-- Create table to track used trial emails
CREATE TABLE trial_emails (
    id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
    email TEXT UNIQUE NOT NULL,
    trial_used_at TIMESTAMP DEFAULT NOW(),
    created_at TIMESTAMP DEFAULT NOW()
);

-- Enable RLS
ALTER TABLE trial_emails ENABLE ROW LEVEL SECURITY;

-- Allow anyone to check if email exists (needed for signup validation)
CREATE POLICY "Anyone can check trial emails" ON trial_emails
    FOR SELECT TO anon, authenticated
    USING (true);

-- Create trigger function to log email when trial is created
CREATE OR REPLACE FUNCTION log_trial_email()
RETURNS TRIGGER AS $$
BEGIN
    INSERT INTO trial_emails (email)
    SELECT email FROM auth.users WHERE id = NEW.user_id
    ON CONFLICT (email) DO NOTHING;
    RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Create trigger on subscriptions table
CREATE TRIGGER on_subscription_created
    AFTER INSERT ON subscriptions
    FOR EACH ROW
    EXECUTE FUNCTION log_trial_email();
