<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M4 Streamline</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script src="https://js.stripe.com/v3/"></script>
<script>
  emailjs.init('cl17j5coPTDN-aVM8');
</script>
</head>
<body>
    <div id="app"></div>
    
    <!-- Copyright Footer -->
    <footer style="background: #000; color: #14b8a6; text-align: center; padding: 20px; margin-top: 40px; border-top: 2px solid #14b8a6;">
        <p style="margin: 0 0 10px 0; font-size: 14px;">¬© 2026 M4 Projects & Designs. All rights reserved.</p>
        <p style="margin: 0 0 10px 0; font-size: 12px; color: #fff;">M4 Streamline‚Ñ¢ - Streamlining Your Business</p>
        <p style="margin: 0; font-size: 12px;">
            <a href="/terms-of-service.html" target="_blank" style="color: #14b8a6; text-decoration: none; margin: 0 10px;">Terms of Service</a>
            <span style="color: #666;">|</span>
            <a href="/privacy-policy.html" target="_blank" style="color: #14b8a6; text-decoration: none; margin: 0 10px;">Privacy Policy</a>
        </p>
    </footer>
    
    <script>
        const supabaseClient = window.supabase.createClient('https://xviustrrsuhidzbcpgow.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2aXVzdHJyc3VoaWR6YmNwZ293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1NDgsImV4cCI6MjA4NDM2NTU0OH0.CEcc50c1K2Qnh6rXt_1-_w30LzHvDniGLbqWhdOolRY');
        let currentUser = null;
        let activeTab = localStorage.getItem('activeTab') || 'dashboard';
        let clients = [];
        let jobs = [];
        let quotes = [];
        let invoices = [];
        let expenses = [];
        let stripeSettings = null;
        let emailSettings = null;
        let smsSettings = null;
        let payments = [];
        let companySettings = null;
        let subscription = null;
        let isAdmin = false;
        let demoMode = null; // 'sole_trader', 'business', or null (use real account type)
        let useDemoData = false; // When true, use demo data instead of real database
        
        // Demo data storage
        let demoClients = [];
        let demoJobs = [];
        let demoQuotes = [];
        let demoInvoices = [];
        let demoExpenses = [];
        let demoTeamMembers = [];
        let teamMembers = [];
        let showModal = false;
        let modalType = '';
        let editingItem = null;
	let scheduleView = 'list';
        let calendarFilter = 'all'; // Track which worker's calendar to show
        let clientSearch = '';
        let invoiceFilter = 'unpaid';
        let expenseFilter = 'all'; // 'all' or 'YYYY-MM' format
        let lastCreatedQuote = null;  // Track last created quote
        
        // Session timeout (30 minutes of inactivity)
        let sessionTimeout;
        const SESSION_TIMEOUT_MS = 30 * 60 * 1000; // 30 minutes
        
        function resetSessionTimeout() {
            clearTimeout(sessionTimeout);
            if (currentUser) {
                sessionTimeout = setTimeout(() => {
                    alert('Your session has expired due to inactivity. Please log in again.');
                    handleLogout();
                }, SESSION_TIMEOUT_MS);
            }
        }
        
        function setupSessionTimeout() {
            // Setup activity listeners once when user logs in
            let activityEvents = ['mousemove', 'keypress', 'click', 'scroll', 'touchstart'];
            activityEvents.forEach(event => {
                document.addEventListener(event, resetSessionTimeout, { passive: true });
            });
            resetSessionTimeout(); // Start the timer
        }
        
        async function checkAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const quoteToken = urlParams.get('quote');
    
    if (quoteToken) {
        // Redirect to the separate quote viewer page
        window.location.href = 'quote-viewer.html?quote=' + quoteToken;
        return;
    }
    
    // Handle email confirmation from URL
    const hashParams = new URLSearchParams(window.location.hash.substring(1));
    const access_token = hashParams.get('access_token');
    const refresh_token = hashParams.get('refresh_token');
    
    if (access_token && refresh_token) {
        await supabaseClient.auth.setSession({
            access_token,
            refresh_token
        });
        // Clear hash and redirect to clean URL
        window.location.hash = '';
        window.location.href = window.location.pathname;
        return;
    }
    
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
        currentUser = session.user;
        await loadAllData();
        setupSessionTimeout(); // Start session timeout
        renderApp();
    } else {
        renderAuth();
    }
}
    
        let selectedAccountType = 'sole_trader'; // Track which account type is selected
        
        function renderAuth() {
            document.getElementById('app').innerHTML = `<div class="min-h-screen flex items-center justify-center bg-black"><div class="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full"><div class="text-center mb-8"><div class="text-teal-400 text-5xl font-bold mb-2">M4</div><h1 class="text-2xl font-bold text-black">Streamline</h1><p class="text-gray-600 mt-2">Business Management</p></div><div class="bg-teal-50 border-l-4 border-teal-400 p-4 mb-6 rounded"><p class="text-sm font-medium text-teal-900 mb-1">üéâ Start Your Free Trial</p><p class="text-xs text-teal-700">14 days free ‚Ä¢ Cancel anytime</p></div><div id="signup-section"><h3 class="text-lg font-bold mb-4 text-center">Choose Your Account Type</h3><div class="grid grid-cols-2 gap-4 mb-6"><div onclick="selectedAccountType='sole_trader'; renderAuth();" class="cursor-pointer p-4 border-2 rounded-lg ${selectedAccountType === 'sole_trader' ? 'border-teal-400 bg-teal-50' : 'border-gray-300 hover:border-teal-200'}"><div class="text-center"><div class="text-2xl mb-2">üë§</div><h4 class="font-bold mb-1">Sole Trader</h4><p class="text-xs text-gray-600 mb-2">Perfect for individuals</p><p class="text-2xl font-bold text-teal-600">$19.99<span class="text-sm text-gray-500">/mo</span></p></div></div><div onclick="selectedAccountType='business'; renderAuth();" class="cursor-pointer p-4 border-2 rounded-lg ${selectedAccountType === 'business' ? 'border-teal-400 bg-teal-50' : 'border-gray-300 hover:border-teal-200'}"><div class="text-center"><div class="text-2xl mb-2">üë•</div><h4 class="font-bold mb-1">Business</h4><p class="text-xs text-gray-600 mb-2">Teams & job assignments</p><p class="text-2xl font-bold text-teal-600">$49.99<span class="text-sm text-gray-500">/mo</span></p></div></div></div><div><input type="email" id="email" placeholder="Email" class="w-full px-4 py-3 border rounded-lg mb-3"><input type="password" id="password" placeholder="Password" class="w-full px-4 py-3 border rounded-lg mb-2"><div class="text-xs text-gray-500 mb-4 pl-1">Password must be 8+ characters with uppercase, lowercase, and number</div><button onclick="handleLogin()" class="w-full bg-black text-white px-4 py-3 rounded-lg hover:bg-gray-800 border-2 border-teal-400 mb-3">Sign In</button><button onclick="handleSignup()" class="w-full bg-white text-black px-4 py-3 rounded-lg hover:bg-gray-50 border-2 border-black">Start Free Trial - ${selectedAccountType === 'sole_trader' ? 'Sole Trader' : 'Business'}</button><div id="auth-error" class="mt-3 text-red-600 text-sm text-center"></div></div></div></div></div>`;
        }
        
        async function handleLogin() {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                email: document.getElementById('email').value, 
                password: document.getElementById('password').value 
            });
            if (error) document.getElementById('auth-error').textContent = error.message;
            else { currentUser = data.user; await loadAllData(); renderApp(); }
        }
        
        async function handleSignup() {
            const email = document.getElementById('email').value;
            const password = document.getElementById('password').value;
            const errorDiv = document.getElementById('auth-error');
            
            // Password strength validation
            if (password.length < 8) {
                errorDiv.textContent = 'Password must be at least 8 characters long';
                errorDiv.className = 'mt-3 text-red-600 text-sm text-center';
                return;
            }
            if (!/[A-Z]/.test(password)) {
                errorDiv.textContent = 'Password must contain at least one uppercase letter';
                errorDiv.className = 'mt-3 text-red-600 text-sm text-center';
                return;
            }
            if (!/[a-z]/.test(password)) {
                errorDiv.textContent = 'Password must contain at least one lowercase letter';
                errorDiv.className = 'mt-3 text-red-600 text-sm text-center';
                return;
            }
            if (!/[0-9]/.test(password)) {
                errorDiv.textContent = 'Password must contain at least one number';
                errorDiv.className = 'mt-3 text-red-600 text-sm text-center';
                return;
            }
            
            const { data, error } = await supabaseClient.auth.signUp({ email, password });
            if (error) {
                errorDiv.textContent = error.message;
                errorDiv.className = 'mt-3 text-red-600 text-sm text-center';
            } else { 
                errorDiv.textContent = 'Success! Please check your email to verify your account before logging in.'; 
                errorDiv.className = 'mt-3 text-green-600 text-sm text-center'; 
            }
        }
        
        async function handleLogout() { 
            clearTimeout(sessionTimeout); // Clear timeout on logout
            await supabaseClient.auth.signOut(); 
            currentUser = null;
            activeTab = 'dashboard'; // Reset to dashboard
            localStorage.setItem('activeTab', 'dashboard'); // Clear saved tab
            renderAuth(); 
        }
        
        
        // Get effective account type (demo mode overrides real account)
        function getAccountType() {
            if (isAdmin && demoMode) return demoMode;
            return subscription?.account_type || 'sole_trader';
        }
        
        // Initialize demo data with sample content
        function initDemoData() {
            const now = new Date();
            const today = now.toISOString().split('T')[0];
            
            // Sample clients
            demoClients = [
                { id: 'demo-client-1', name: 'John Smith', email: 'john@example.com', phone: '0412 345 678', address: '123 Main St, Brisbane', notes: 'Prefers morning appointments' },
                { id: 'demo-client-2', name: 'Sarah Johnson', email: 'sarah@example.com', phone: '0423 456 789', address: '456 Oak Ave, Gold Coast', notes: 'VIP customer' }
            ];
            
            // Sample jobs
            demoJobs = [
                { id: 'demo-job-1', client_id: 'demo-client-1', title: 'Bathroom Renovation', date: today, time: '09:00', status: 'scheduled', notes: 'Full bathroom remodel', photos: [] },
                { id: 'demo-job-2', client_id: 'demo-client-2', title: 'Kitchen Installation', date: today, time: '14:00', status: 'in_progress', notes: 'Cabinet installation', photos: [] }
            ];
            
            // Sample quotes
            demoQuotes = [
                { 
                    id: 'demo-quote-1', 
                    client_id: 'demo-client-1', 
                    title: 'Bathroom Renovation', 
                    date: today,
                    quote_number: 'QT-001',
                    items: [
                        { description: 'Labour', quantity: 1, price: 3000 },
                        { description: 'Materials', quantity: 1, price: 2000 }
                    ],
                    total: 5000,
                    deposit_percentage: 30,
                    deposit_amount: 1500,
                    status: 'pending',
                    share_token: 'demo-token-1'
                }
            ];
            
            // Sample invoices
            demoInvoices = [
                {
                    id: 'demo-invoice-1',
                    client_id: 'demo-client-2',
                    title: 'Kitchen Installation - Deposit',
                    invoice_number: 'INV-001',
                    issue_date: today,
                    due_date: today,
                    items: [{ description: 'Deposit - Kitchen Installation', quantity: 1, price: 2000 }],
                    total: 2000,
                    status: 'unpaid'
                }
            ];
            
            // Sample expenses
            demoExpenses = [
                { id: 'demo-expense-1', date: today, amount: 150, category: 'Materials', description: 'Tiles for bathroom', job_id: 'demo-job-1' },
                { id: 'demo-expense-2', date: today, amount: 80, category: 'Fuel', description: 'Weekly fuel', job_id: null }
            ];
            
            // Sample team members (for business demo)
            if (demoMode === 'business') {
                demoTeamMembers = [
                    { id: 'demo-team-1', name: 'Mike Wilson', email: 'mike@example.com', phone: '0434 567 890', occupation: 'Painter', color: '#3b82f6' },
                    { id: 'demo-team-2', name: 'Lisa Brown', email: 'lisa@example.com', phone: '0445 678 901', occupation: 'Electrician', color: '#ef4444' }
                ];
                // Add team member to job
                demoJobs[0].assigned_to = 'demo-team-1';
                // Add team member to expense
                demoExpenses[0].team_member_id = 'demo-team-1';
            } else {
                demoTeamMembers = [];
            }
            
            useDemoData = true;
        }
        
        // Switch to demo mode with sample data
        async function enterDemoMode(mode) {
            demoMode = mode;
            initDemoData();
            await loadAllData(); // Reload data
            renderApp();
        }
        
        // Exit demo mode and return to real data
        async function exitDemoMode() {
            demoMode = null;
            useDemoData = false;
            await loadAllData(); // Reload real data from database
            renderApp();
        }
        
        async function loadAllData() {
            // If in demo mode, use demo data instead of database
            if (useDemoData) {
                clients = demoClients;
                jobs = demoJobs;
                quotes = demoQuotes;
                invoices = demoInvoices;
                expenses = demoExpenses;
                teamMembers = demoTeamMembers;
                return;
            }
            
            const [c, j, q, i, e, s, sub, admin, team, stripe, pay, email, sms] = await Promise.all([
                supabaseClient.from('clients').select('*'), 
                supabaseClient.from('jobs').select('*'), 
                supabaseClient.from('quotes').select('*'), 
                supabaseClient.from('invoices').select('*'),
                supabaseClient.from('expenses').select('*'),
                supabaseClient.from('company_settings').select('*').eq('user_id', currentUser.id).single(),
                supabaseClient.from('subscriptions').select('*').eq('user_id', currentUser.id).single(),
                supabaseClient.from('admin_users').select('*').eq('user_id', currentUser.id).single(),
                supabaseClient.from('team_members').select('*').eq('account_owner_id', currentUser.id),
                supabaseClient.from('stripe_settings').select('*').eq('user_id', currentUser.id).single(),
                supabaseClient.from('payments').select('*'),
                supabaseClient.from('email_settings').select('*').eq('user_id', currentUser.id).single(),
                supabaseClient.from('sms_settings').select('*').eq('user_id', currentUser.id).single()
            ]);
            clients = c.data || []; 
            jobs = j.data || []; 
            quotes = q.data || []; 
            invoices = i.data || [];
            expenses = e.data || [];
            companySettings = s.data || null;
            subscription = sub.data || null;
            isAdmin = admin.data?.is_admin || false;
            teamMembers = team.data || [];
            stripeSettings = stripe.data || null;
            payments = pay.data || [];
            emailSettings = email.data || null;
            smsSettings = sms.data || null;
            
            console.log('Admin query result:', admin);
            console.log('isAdmin value:', isAdmin);
            
            // Create subscription if doesn't exist
            if (!subscription) {
                // Check if this email has used a trial before
                const { data: trialCheck } = await supabaseClient
                    .from('trial_emails')
                    .select('email')
                    .eq('email', currentUser.email.toLowerCase())
                    .single();
                
                const accountType = selectedAccountType || 'sole_trader';
                const monthlyRate = accountType === 'business' ? 49.99 : 19.99;
                
                if (trialCheck) {
                    // Email already used trial - create expired subscription (go straight to paywall)
                    const { data } = await supabaseClient.from('subscriptions').insert([{
                        user_id: currentUser.id,
                        trial_ends_at: new Date(Date.now() - 1000).toISOString(), // Already expired
                        subscription_status: 'trial',
                        account_type: accountType,
                        monthly_rate: monthlyRate
                    }]).select().single();
                    subscription = data;
                } else {
                    // New email - give them a 14-day trial
                    const { data } = await supabaseClient.from('subscriptions').insert([{
                        user_id: currentUser.id,
                        trial_ends_at: new Date(Date.now() + 14 * 24 * 60 * 60 * 1000).toISOString(),
                        subscription_status: 'trial',
                        account_type: accountType,
                        monthly_rate: monthlyRate
                    }]).select().single();
                    subscription = data;
                }
            }
        }
        
        async function confirmUpgradeToBusiness() {
            if (confirm('Upgrade to Business account for $49/month?\n\nYou will gain access to:\n‚Ä¢ Team member management\n‚Ä¢ Job assignments\n‚Ä¢ Multi-user access\n\nYour trial time will carry over.')) {
                await supabaseClient.from('subscriptions').update({
                    account_type: 'business',
                    monthly_rate: 49.00
                }).eq('user_id', currentUser.id);
                
                alert('Upgraded to Business account! Refreshing...');
                location.reload();
            }
        }
        
        async function addClient(client) {
            if (useDemoData) {
                // Demo mode: add to demo array
                const newClient = { ...client, id: 'demo-client-' + Date.now(), user_id: currentUser.id };
                demoClients.push(newClient);
                clients = demoClients;
                closeModal();
                renderApp();
                return;
            }
            
            const { data } = await supabaseClient.from('clients').insert([{
                ...client, 
                user_id: currentUser.id
            }]).select(); 
            if (data) { 
                clients.push(data[0]); 
                closeModal(); 
                renderApp(); 
            } 
        }
        
        async function updateClient(id) {
            const updatedClient = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value,
                notes: document.getElementById('clientNotes').value
            };
            const { data } = await supabaseClient.from('clients').update(updatedClient).eq('id', id).select();
            if (data) {
                const index = clients.findIndex(c => c.id === id);
                if (index !== -1) clients[index] = data[0];
                closeModal();
                renderApp();
            }
        }
        
        async function deleteClient(id) {
            const client = clients.find(c => c.id === id);
            if (!confirm(`Are you sure you want to delete ${client?.name || 'this client'}? This action cannot be undone.`)) {
                return;
            }
            await supabaseClient.from('clients').delete().eq('id', id); 
            clients = clients.filter(c => c.id !== id); 
            renderApp(); 
        }
        
        async function addJob(job) { 
    const jobData = { ...job, user_id: currentUser.id, photos: [] };
    console.log('Inserting job data:', jobData);
    const { data, error } = await supabaseClient.from('jobs').insert([jobData]).select(); 
    if (error) {
        console.error('Error inserting job:', error);
        alert('Error creating job: ' + error.message);
        return;
    }
    if (data) { 
        jobs.push(data[0]); 
        closeModal(); 
        renderApp(); 
    } 
}
        
        function saveJob() {
            let timeValue = document.getElementById('time').value;
            // Default to 6am if no time selected
            if (!timeValue) {
                timeValue = '06:00';
            }
            
            const duration = parseInt(document.getElementById('duration').value) || 1;
            
            const jobData = {
                client_id: document.getElementById('client_id').value,
                title: document.getElementById('title').value,
                date: document.getElementById('date').value,
                time: timeValue,
                duration: duration,
                notes: document.getElementById('notes').value,
                status: document.getElementById('jobStatus').value
            };
            
            // Add assigned_to if the field exists (business accounts)
            const assignedToField = document.getElementById('assigned_to');
            if (assignedToField && assignedToField.value) {
                jobData.assigned_to = assignedToField.value;
            }
            
            console.log('Saving job with data:', jobData);
            addJob(jobData);
        }
        
        async function updateJob(id) {
            let timeValue = document.getElementById('time').value;
            // Default to 6am if no time selected
            if (!timeValue) {
                timeValue = '06:00';
            }
            
            const duration = parseInt(document.getElementById('duration').value) || 1;
            
            const updatedJob = {
                client_id: document.getElementById('client_id').value,
                title: document.getElementById('title').value,
                date: document.getElementById('date').value,
                time: timeValue,
                duration: duration,
                notes: document.getElementById('notes').value,
                status: document.getElementById('jobStatus').value,
                assigned_to: document.getElementById('assigned_to')?.value || null
            };
            const { data } = await supabaseClient.from('jobs').update(updatedJob).eq('id', id).select();
            if (data) {
                const index = jobs.findIndex(j => j.id === id);
                if (index !== -1) jobs[index] = data[0];
                closeModal();
                renderApp();
            }
        }
        
        async function deleteJob(id) {
            const job = jobs.find(j => j.id === id);
            if (!confirm(`Are you sure you want to delete the job "${job?.title || 'this job'}"? This action cannot be undone.`)) {
                return;
            }
            await supabaseClient.from('jobs').delete().eq('id', id); 
            jobs = jobs.filter(j => j.id !== id); 
            renderApp(); 
        }
        
        async function addQuote(quote) {
    const shareToken = 'q_' + Math.random().toString(36).substring(2, 15);
    const expiryDate = new Date();
    expiryDate.setDate(expiryDate.getDate() + 30);
    
    const quoteData = { 
        ...quote, 
        user_id: currentUser.id, 
        share_token: shareToken, 
        accepted: false,
        expiry_date: expiryDate.toISOString().split('T')[0],
        quote_number: quote.title,  // Store quote number in quote_number field (same as title)
        company_info: companySettings  // Store company details with quote
    };
    const { data } = await supabaseClient.from('quotes').insert([quoteData]).select();
    if (data) {
        quotes.push(data[0]);
        lastCreatedQuote = data[0];  // Track the created quote
        closeModal();
        activeTab = 'quotes';  // Switch to quotes tab
        renderApp();
    }
}

async function acceptQuote(quoteId, shareToken) {
    try {
        // Update quote status to accepted
        const { error } = await supabaseClient
            .from('quotes')
            .update({ accepted: true, status: 'accepted' })
            .eq('share_token', shareToken);
        
        if (error) throw error;
        
        // Get quote and client details for notification email
        const { data: quote } = await supabaseClient
            .from('quotes')
            .select('*, user_id')
            .eq('share_token', shareToken)
            .single();
        
        if (quote) {
            const { data: client } = await supabaseClient
                .from('clients')
                .select('*')
                .eq('id', quote.client_id)
                .single();
            
            // Get the tradesperson's email from auth.users
            const { data: { user } } = await supabaseClient.auth.admin.getUserById(quote.user_id);
            
            // Send notification email to tradesperson
            const templateParams = {
                to_email: user?.email || 'your-email@example.com', // Fallback if user email not found
                client_name: client?.name || 'Client',
                quote_title: quote.title,
                quote_total: quote.total.toFixed(2),
                message: `${client?.name || 'A client'} has ACCEPTED your quote for "${quote.title}"! Total: $${quote.total.toFixed(2)}`,
                from_name: 'M4 Streamline'
            };
            
            await emailjs.send('service_og2tkc8', 'template_xvsfuhv', templateParams);
        }
        
        return true;
    } catch (error) {
        console.error('Error accepting quote:', error);
        return false;
    }
}
        
        async function deleteQuote(id) {
            const quote = quotes.find(q => q.id === id);
            if (!confirm(`Are you sure you want to delete the quote "${quote?.title || 'this quote'}"? This action cannot be undone.`)) {
                return;
            }
            await supabaseClient.from('quotes').delete().eq('id', id); 
            quotes = quotes.filter(q => q.id !== id); 
            renderApp(); 
        }
        
        async function convertToInvoice(quote) {
            // If quote has a deposit, ask if it's been paid
            if (quote.deposit_amount && quote.deposit_amount > 0) {
                const depositPaid = confirm(
                    `This quote has a deposit of $${quote.deposit_amount.toFixed(2)}.\n\n` +
                    `Has the deposit been paid?\n\n` +
                    `Click OK if deposit was paid (invoice will be for remaining balance)\n` +
                    `Click Cancel to enter actual amount paid`
                );
                
                if (depositPaid === false) {
                    // Show custom deposit amount dialog
                    const actualDeposit = prompt(
                        `Enter the actual deposit amount paid:\n(Quote deposit was $${quote.deposit_amount.toFixed(2)})`,
                        quote.deposit_amount.toFixed(2)
                    );
                    
                    if (actualDeposit === null) return; // User cancelled
                    
                    const depositAmount = parseFloat(actualDeposit);
                    if (isNaN(depositAmount) || depositAmount < 0) {
                        alert('Invalid amount entered');
                        return;
                    }
                    
                    // Create invoice with adjusted total
                    await createInvoiceWithDeposit(quote, depositAmount);
                    return;
                }
                
                // Deposit paid as stated - create invoice for remaining balance
                await createInvoiceWithDeposit(quote, quote.deposit_amount);
                return;
            }
            
            // No deposit - create full invoice
            await createInvoiceWithDeposit(quote, 0);
        }
        
        async function createInvoiceWithDeposit(quote, depositPaid) {
            const issueDate = new Date();
            
            // Generate sequential invoice number
            const invoiceNumber = `INV-${String(invoices.length + 1).padStart(3, '0')}`;
            
            // Calculate remaining balance
            const remainingBalance = quote.total - depositPaid;
            
            const inv = {
                client_id: quote.client_id,
                title: quote.title + (depositPaid > 0 ? ' - Final Payment' : ''),
                items: quote.items,
                notes: (quote.notes || '') + (depositPaid > 0 ? `\n\nDeposit paid: $${depositPaid.toFixed(2)}` : ''),
                subtotal: quote.subtotal || quote.total,
                gst: quote.gst || 0,
                total: remainingBalance > 0 ? remainingBalance : quote.total,
                original_total: quote.total,
                deposit_paid: depositPaid,
                include_gst: quote.include_gst || false,
                invoice_number: invoiceNumber,
                status: remainingBalance <= 0 ? 'paid' : 'unpaid',
                issue_date: issueDate.toISOString().split('T')[0],
                due_date: issueDate.toISOString().split('T')[0],
                user_id: currentUser.id,
                company_info: companySettings
            };
            
            const { data, error } = await supabaseClient.from('invoices').insert([inv]).select();
            if (error) {
                console.error('Invoice error:', error);
                alert('Error: ' + error.message);
            } else if (data) {
                await supabaseClient.from('quotes').update({ status: 'converted' }).eq('id', quote.id);
                await loadAllData();
                activeTab = 'invoices';
                
                // Show success message
                if (depositPaid > 0) {
                    alert(`‚úÖ Invoice created!\n\nOriginal Total: $${quote.total.toFixed(2)}\nDeposit Paid: $${depositPaid.toFixed(2)}\nBalance Due: $${remainingBalance.toFixed(2)}\n\nInvoice #${invoiceNumber}`);
                }
                
                renderApp();
            }
        }
        
        async function updateInvoice(id, status) { 
            await supabaseClient.from('invoices').update({ status }).eq('id', id); 
            await loadAllData(); 
            renderApp(); 
        }
        
        async function deleteInvoice(id) {
            const invoice = invoices.find(i => i.id === id);
            if (!confirm(`Are you sure you want to delete invoice "${invoice?.invoice_number || 'this invoice'}"? This action cannot be undone.`)) {
                return;
            }
            await supabaseClient.from('invoices').delete().eq('id', id); 
            invoices = invoices.filter(i => i.id !== id); 
            renderApp(); 
        }
        
        function openModal(type, item = null) { 
            modalType = type; 
            editingItem = item; 
            showModal = true; 
            if (type === 'quote') quoteItems = item?.items || [{ description: '', quantity: 1, price: 0 }]; 
            renderApp(); 
            if (type === 'quote') setTimeout(renderQuoteItems, 100); 
        }
        
        function openJobFromQuote(quote) {
            const client = clients.find(c => c.id === quote.client_id);
            editingItem = {
                client_id: quote.client_id,
                title: quote.title,
                notes: `Quote: ${quote.title} - Total: $${quote.total.toFixed(2)}\n\n${quote.notes || ''}`
            };
            modalType = 'job';
            showModal = true;
            renderApp();
        }
        
        function openQuoteForClient(client) {
            editingItem = {
                client_id: client.id
            };
            modalType = 'quote';
            quoteItems = [{ description: '', quantity: 1, price: 0 }];
            showModal = true;
            renderApp();
            setTimeout(renderQuoteItems, 100);
        }
        
        function closeModal() { 
            showModal = false; 
            editingItem = null; 
            modalType = ''; 
            renderApp(); 
        }
        
        function generatePDF(type, item) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            const company = item.company_info || companySettings || {};
            
            // Add M4 logo from image
const logoImg = new Image();
logoImg.src = 'https://i.imgur.com/dF4xRDK.jpeg';
doc.addImage(logoImg, 'JPEG', 10, 10, 25, 25);
            
            doc.setFontSize(24);
            doc.setTextColor(0, 0, 0);
            doc.text(company.business_name || 'M4 Streamline', 35, 22);
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            if (company.abn) doc.text('ABN: ' + company.abn, 35, 28);
            if (company.phone) doc.text(company.phone, 35, 33);
            if (company.email) doc.text(company.email, 35, 38);
            
            doc.setFontSize(18);
            doc.setTextColor(20, 184, 166);
            const title = type === 'quote' ? 'QUOTE' : 'INVOICE';
            doc.text(title, 20, 50);
            
            const client = clients.find(c => c.id === item.client_id);
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text('Client:', 20, 65);
            doc.text(client?.name || 'Unknown', 45, 65);
            doc.text(client?.email || '', 45, 71);
            doc.text(client?.phone || '', 45, 77);
            
            if (type === 'invoice') {
                doc.text('Invoice #:', 140, 65);
                doc.text(item.invoice_number || '', 170, 65);
                doc.text('Date:', 140, 71);
                doc.text(item.issue_date || '', 170, 71);
            } else {
                if (item.quote_number) {
                    doc.text('Quote #:', 140, 65);
                    doc.text(item.quote_number, 170, 65);
                    doc.text('Date:', 140, 71);
                    doc.text(item.date || '', 170, 71);
                } else {
                    doc.text('Date:', 140, 65);
                    doc.text(item.date || '', 170, 65);
                }
            }
            
            let y = 95;
            doc.setFontSize(12);
            doc.setTextColor(255, 255, 255);
            doc.setFillColor(0, 0, 0);
            doc.rect(20, y - 7, 170, 10, 'F');
            doc.text('Description', 25, y);
            doc.text('Qty', 120, y);
            doc.text('Price', 145, y);
            doc.text('Total', 170, y);
            
            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            
            if (item.items && Array.isArray(item.items)) {
                item.items.forEach(lineItem => {
                    doc.text(lineItem.description || '', 25, y);
                    doc.text(String(lineItem.quantity || 0), 120, y);
                    doc.text('$' + (lineItem.price || 0).toFixed(2), 145, y);
                    doc.text('$' + ((lineItem.quantity * lineItem.price) || 0).toFixed(2), 170, y);
                    y += 7;
                });
            }
            
            y += 10;
            doc.setLineWidth(0.5);
            doc.setDrawColor(200, 200, 200);
            doc.line(120, y, 190, y);
            
            // Show GST breakdown if applicable
            if (item.include_gst) {
                y += 8;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(100, 100, 100);
                doc.text('Subtotal:', 145, y);
                doc.text('$' + (item.subtotal || 0).toFixed(2), 170, y);
                
                y += 6;
                doc.text('GST (10%):', 145, y);
                doc.text('$' + (item.gst || 0).toFixed(2), 170, y);
                
                y += 8;
                doc.setLineWidth(0.5);
                doc.setDrawColor(20, 184, 166);
                doc.line(120, y, 190, y);
            }
            
            y += 8;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.setTextColor(0, 0, 0);
            doc.text(item.include_gst ? 'TOTAL (inc GST):' : 'TOTAL:', 125, y);
            doc.setTextColor(20, 184, 166);
            doc.text('$' + (item.total || 0).toFixed(2), 170, y);
            
            // Add deposit information for invoices with deposits
            if (type === 'invoice' && item.deposit_paid && item.deposit_paid > 0) {
                y += 12;
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Payment Breakdown:', 125, y);
                
                y += 7;
                doc.setFontSize(10);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(50, 50, 50);
                
                doc.text('Original Total:', 125, y);
                doc.text('$' + (item.original_total || item.total).toFixed(2), 170, y);
                
                y += 5;
                doc.setTextColor(100, 100, 100);
                doc.text('Less Deposit Paid:', 125, y);
                doc.text('-$' + item.deposit_paid.toFixed(2), 170, y);
                
                y += 5;
                doc.setFont(undefined, 'bold');
                doc.setTextColor(255, 140, 0); // Orange
                doc.text('Balance Due:', 125, y);
                doc.text('$' + item.total.toFixed(2), 170, y);
            }
            
            // Add deposit information for quotes
            if (type === 'quote') {
                if (item.deposit_percentage > 0) {
                    y += 12;
                    doc.setFontSize(12);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('DEPOSIT REQUIRED:', 125, y);
                    doc.setTextColor(255, 140, 0); // Orange color
                    doc.text('$' + (item.deposit_amount || 0).toFixed(2), 170, y);
                    
                    y += 6;
                    doc.setFontSize(9);
                    doc.setFont(undefined, 'italic');
                    doc.setTextColor(100, 100, 100);
                    doc.text('(' + item.deposit_percentage + '% of total)', 125, y);
                    
                    // Calculate and show balance
                    const balance = (item.total || 0) - (item.deposit_amount || 0);
                    y += 8;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Balance on completion:', 125, y);
                    doc.text('$' + balance.toFixed(2), 170, y);
                    
                    y += 5;
                    doc.setFontSize(8);
                    doc.setFont(undefined, 'italic');
                    doc.setTextColor(100, 100, 100);
                    doc.text('(Unless specified otherwise)', 125, y);
                } else {
                    // 0% deposit - show COD message
                    y += 12;
                    doc.setFontSize(11);
                    doc.setFont(undefined, 'bold');
                    doc.setTextColor(0, 0, 0);
                    doc.text('Payment Terms:', 125, y);
                    
                    y += 6;
                    doc.setFontSize(10);
                    doc.setFont(undefined, 'normal');
                    doc.setTextColor(100, 100, 100);
                    const codText = doc.splitTextToSize('Full payment (COD) to be paid on completion', 65);
                    doc.text(codText, 125, y);
                }
            }
            
            // Add bank details for invoices (if Stripe is disabled or not configured)
            if (type === 'invoice' && company.bank_name) {
                y += 15;
                doc.setFontSize(11);
                doc.setFont(undefined, 'bold');
                doc.setTextColor(0, 0, 0);
                doc.text('Payment Details:', 20, y);
                
                y += 7;
                doc.setFontSize(9);
                doc.setFont(undefined, 'normal');
                doc.setTextColor(50, 50, 50);
                
                if (company.bank_name) {
                    doc.text('Bank: ' + company.bank_name, 20, y);
                    y += 5;
                }
                if (company.account_name) {
                    doc.text('Account Name: ' + company.account_name, 20, y);
                    y += 5;
                }
                if (company.bsb) {
                    doc.text('BSB: ' + company.bsb, 20, y);
                    y += 5;
                }
                if (company.account_number) {
                    doc.text('Account Number: ' + company.account_number, 20, y);
                    y += 5;
                }
                
                // Add payment reference suggestion
                y += 3;
                doc.setFontSize(8);
                doc.setFont(undefined, 'italic');
                doc.setTextColor(100, 100, 100);
                const referenceText = doc.splitTextToSize('Please use invoice number as payment reference', 170);
                doc.text(referenceText, 20, y);
            }
            
            if (item.notes) {
                y += 15;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.text('Notes:', 20, y);
                const splitNotes = doc.splitTextToSize(item.notes, 170);
                doc.text(splitNotes, 20, y + 5);
            }
            
            const filename = type === 'quote' ? `Quote-${item.title}.pdf` : `Invoice-${item.invoice_number}.pdf`;
            doc.save(filename);
        }
        
        async function renderApp() {
            // Check if subscription is active
            if (subscription && !isAdmin) {
                const trialEnds = new Date(subscription.trial_ends_at);
                const now = new Date();
                const daysLeft = Math.ceil((trialEnds - now) / (1000 * 60 * 60 * 24));
                
                if (subscription.subscription_status === 'trial' && daysLeft <= 0) {
                    // Trial expired, show paywall
                    renderPaywall();
                    return;
                }
            }
            
            // Calculate trial days for header
            let trialBanner = '';
            
            // Demo mode banner
            if (useDemoData) {
                const demoType = demoMode === 'sole_trader' ? 'Sole Trader' : 'Business';
                trialBanner = `<div class="bg-orange-500 text-white text-center py-2 text-sm font-bold">üé¨ DEMO MODE (${demoType}) - Sample Data Only - Changes Won't Be Saved</div>`;
            } else {
                console.log('Subscription:', subscription);
                console.log('isAdmin:', isAdmin);
                
                if (subscription && subscription.subscription_status === 'trial' && !isAdmin) {
                    const trialEnds = new Date(subscription.trial_ends_at);
                    const now = new Date();
                    const daysLeft = Math.ceil((trialEnds - now) / (1000 * 60 * 60 * 24));
                    console.log('Days left in trial:', daysLeft);
                    if (daysLeft > 0) {
                        trialBanner = `<div class="bg-yellow-500 text-black text-center py-2 text-sm font-medium">‚è∞ Trial: ${daysLeft} day${daysLeft === 1 ? '' : 's'} remaining</div>`;
                    }
                } else if (!subscription && !isAdmin) {
                    // Fallback for users without subscription record yet
                    trialBanner = `<div class="bg-yellow-500 text-black text-center py-2 text-sm font-medium">‚è∞ Trial: 14 days remaining</div>`;
                }
            }
            
            const content = await renderContent();
            
            document.getElementById('app').innerHTML = `<div class="min-h-screen bg-gray-50">${trialBanner}<div class="bg-black text-white p-4 md:p-6 shadow-lg border-b-4 border-teal-400"><div class="max-w-7xl mx-auto flex flex-col md:grid md:grid-cols-3 gap-4 md:items-center"><div class="flex items-center gap-3 justify-center md:justify-start"><img src="final_logo.png" alt="M4 Projects Logo" class="h-20 w-20 md:h-32 md:w-32 object-contain"><div class="text-xs md:text-sm"><div class="text-xs text-teal-400">Logged in:</div><div class="font-medium text-teal-400 truncate">${currentUser.email}</div></div></div><div class="text-center"><h1 class="text-2xl md:text-3xl font-bold text-teal-400">M4 STREAMLINE</h1><p class="text-teal-400 text-xs md:text-sm italic">"streamlining your business"</p></div><div class="flex items-center justify-center md:justify-end gap-3 md:gap-4">${isAdmin ? '<span class="bg-red-600 px-2 py-1 rounded text-xs font-bold whitespace-nowrap">ADMIN</span>' : ''}${isAdmin ? `<div class="flex gap-1 bg-gray-800 rounded p-1"><button onclick="enterDemoMode('sole_trader');" class="px-2 py-1 rounded text-xs ${demoMode === 'sole_trader' ? 'bg-teal-600' : 'hover:bg-gray-700'}">Sole Trader</button><button onclick="enterDemoMode('business');" class="px-2 py-1 rounded text-xs ${demoMode === 'business' ? 'bg-teal-600' : 'hover:bg-gray-700'}">Business</button><button onclick="exitDemoMode();" class="px-2 py-1 rounded text-xs ${demoMode === null ? 'bg-teal-600' : 'hover:bg-gray-700'}">Real</button>${demoMode ? '<button onclick="initDemoData(); loadAllData(); renderApp();" class="px-2 py-1 rounded text-xs bg-yellow-600 hover:bg-yellow-700" title="Reset demo data">üîÑ</button>' : ''}</div>` : ''}<div class="relative"><button onclick="toggleSettingsMenu()" class="px-3 py-2 md:px-4 md:py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-teal-400 flex items-center gap-2"><svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></button><div id="settings-menu" class="hidden absolute right-0 mt-2 w-48 bg-white rounded-lg shadow-lg border border-gray-200 z-50"><div class="py-1"><button onclick="handleLogout()" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H6a3 3 0 01-3-3V7a3 3 0 013-3h4a3 3 0 013 3v1"></path></svg>Logout</button><a href="mailto:m4projectsanddesigns@gmail.com?subject=M4 Streamline Support Request" class="w-full text-left px-4 py-2 text-sm text-gray-700 hover:bg-gray-100 flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>Contact Support</a>${subscription?.account_type === 'sole_trader' ? '<button onclick="confirmUpgradeToBusiness()" class="w-full text-left px-4 py-2 text-sm text-teal-600 hover:bg-teal-50 flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>Upgrade to Business</button>' : ''}<button onclick="confirmDeleteAccount()" class="w-full text-left px-4 py-2 text-sm text-red-600 hover:bg-red-50 flex items-center gap-2"><svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>Delete Account</button></div></div></div></div></div></div><div class="bg-white shadow overflow-x-auto"><div class="max-w-7xl mx-auto px-2 md:px-4"><div class="flex space-x-1 min-w-max">${['dashboard', 'schedule', 'clients', 'quotes', 'invoices', 'expenses', 'analytics', 'company'].map(tab => `<button onclick="switchTab('${tab}')" class="px-3 md:px-6 py-3 md:py-4 font-medium border-b-2 text-sm md:text-base whitespace-nowrap ${activeTab === tab ? 'border-teal-400 text-black' : 'border-transparent text-gray-600'}">${tab === 'company' ? 'Company Info' : tab.charAt(0).toUpperCase() + tab.slice(1)}</button>`).join('')}${getAccountType() === 'business' ? '<button onclick="switchTab(\'team\')" class="px-3 md:px-6 py-3 md:py-4 font-medium border-b-2 text-sm md:text-base whitespace-nowrap ' + (activeTab === 'team' ? 'border-teal-400 text-black' : 'border-transparent text-gray-600') + '">Team</button>' : ''}${isAdmin ? '<button onclick="switchTab(\'admin\')" class="px-3 md:px-6 py-3 md:py-4 font-medium border-b-2 text-sm md:text-base whitespace-nowrap ' + (activeTab === 'admin' ? 'border-teal-400 text-black' : 'border-transparent text-gray-600') + '">Admin</button>' : ''}</div></div></div><div class="max-w-7xl mx-auto p-3 md:p-6">${content}</div>${showModal ? renderModal() : ''}</div>`;
        }
        
        function toggleSettingsMenu() {
            const menu = document.getElementById('settings-menu');
            if (menu) {
                menu.classList.toggle('hidden');
            }
        }
        
        // Close settings menu when clicking outside
        document.addEventListener('click', function(event) {
            const menu = document.getElementById('settings-menu');
            const button = event.target.closest('button[onclick="toggleSettingsMenu()"]');
            if (menu && !menu.contains(event.target) && !button) {
                menu.classList.add('hidden');
            }
        });
        
        async function confirmDeleteAccount() {
            if (confirm('Are you sure you want to delete your account? This action cannot be undone and will delete all your clients, jobs, quotes, and invoices.')) {
                if (confirm('This is your final warning. All data will be permanently deleted. Are you absolutely sure?')) {
                    await deleteAccount();
                }
            }
        }
        
        async function deleteAccount() {
            try {
                // Delete all user data first
                await Promise.all([
                    supabaseClient.from('clients').delete().eq('user_id', currentUser.id),
                    supabaseClient.from('jobs').delete().eq('user_id', currentUser.id),
                    supabaseClient.from('quotes').delete().eq('user_id', currentUser.id),
                    supabaseClient.from('invoices').delete().eq('user_id', currentUser.id),
                    supabaseClient.from('company_settings').delete().eq('user_id', currentUser.id),
                    supabaseClient.from('subscriptions').delete().eq('user_id', currentUser.id),
                    supabaseClient.from('admin_users').delete().eq('user_id', currentUser.id)
                ]);
                
                // Use RPC function to delete user (requires database function)
                const { error } = await supabaseClient.rpc('delete_user');
                
                if (error) {
                    console.error('Delete error:', error);
                    alert('Account data deleted. Please contact support to complete account deletion: m4projectsanddesigns@gmail.com');
                    await supabaseClient.auth.signOut();
                    currentUser = null;
                    renderAuth();
                } else {
                    alert('Account deleted successfully.');
                    await supabaseClient.auth.signOut();
                    currentUser = null;
                    renderAuth();
                }
            } catch (error) {
                console.error('Delete error:', error);
                alert('Account data deleted. Please contact support to complete account deletion: m4projectsanddesigns@gmail.com');
                await supabaseClient.auth.signOut();
                currentUser = null;
                renderAuth();
            }
        }
        
        async function switchTab(tab) {
            activeTab = tab;
            localStorage.setItem('activeTab', tab);
            await loadAllData();
            renderApp();
        }
        
        async function saveCompanySettings() {
            const settings = {
                user_id: currentUser.id,
                business_name: document.getElementById('business_name').value,
                abn: document.getElementById('abn').value,
                phone: document.getElementById('settings_phone').value,
                email: document.getElementById('settings_email').value,
                address: document.getElementById('settings_address').value,
                bank_name: document.getElementById('bank_name').value,
                bsb: document.getElementById('bsb').value,
                account_number: document.getElementById('account_number').value,
                account_name: document.getElementById('account_name').value
            };
            
            if (companySettings) {
                // Update existing settings
                const { data, error } = await supabaseClient
                    .from('company_settings')
                    .update(settings)
                    .eq('user_id', currentUser.id)
                    .select();
                if (data) companySettings = data[0];
            } else {
                // Create new settings
                const { data, error } = await supabaseClient
                    .from('company_settings')
                    .insert([settings])
                    .select();
                if (data) companySettings = data[0];
            }
            
            alert('Settings saved successfully!');
            renderApp();
        }
        
        async function saveStripeSettings() {
            const publishableKey = document.getElementById('stripe_publishable_key').value.trim();
            const secretKey = document.getElementById('stripe_secret_key').value.trim();
            const enabled = document.getElementById('stripe_enabled').checked;
            
            // If keys are provided, validate them
            if (publishableKey && !publishableKey.startsWith('pk_')) {
                alert('Invalid Publishable Key. Should start with pk_test_ or pk_live_');
                return;
            }
            
            if (secretKey && !secretKey.startsWith('sk_')) {
                alert('Invalid Secret Key. Should start with sk_test_ or sk_live_');
                return;
            }
            
            // If enabled is true but no keys, warn user
            if (enabled && (!publishableKey || !secretKey)) {
                alert('Stripe is enabled but keys are missing. Please add keys or turn off Stripe.');
                return;
            }
            
            const settings = {
                user_id: currentUser.id,
                publishable_key: publishableKey || null,
                secret_key: secretKey || null,
                enabled: enabled
            };
            
            if (stripeSettings) {
                // Update existing
                const { data } = await supabaseClient
                    .from('stripe_settings')
                    .update(settings)
                    .eq('user_id', currentUser.id)
                    .select();
                if (data) stripeSettings = data[0];
            } else {
                // Create new
                const { data } = await supabaseClient
                    .from('stripe_settings')
                    .insert([settings])
                    .select();
                if (data) stripeSettings = data[0];
            }
            
            alert('Stripe settings saved! You can now accept online payments.');
            renderApp();
        }
        
        async function saveEmailSettings() {
            const apiKey = document.getElementById('sendgrid_api_key').value.trim();
            const fromEmail = document.getElementById('sendgrid_from_email').value.trim();
            const fromName = document.getElementById('sendgrid_from_name').value.trim();
            
            if (!apiKey || !fromEmail || !fromName) {
                alert('Please fill in all email settings fields');
                return;
            }
            
            if (!apiKey.startsWith('SG.')) {
                alert('Invalid SendGrid API Key. Should start with SG.');
                return;
            }
            
            if (!fromEmail.includes('@')) {
                alert('Please enter a valid email address');
                return;
            }
            
            const settings = {
                user_id: currentUser.id,
                sendgrid_api_key: apiKey,
                from_email: fromEmail,
                from_name: fromName
            };
            
            if (emailSettings) {
                // Update existing
                const { data } = await supabaseClient
                    .from('email_settings')
                    .update(settings)
                    .eq('user_id', currentUser.id)
                    .select();
                if (data) emailSettings = data[0];
            } else {
                // Create new
                const { data } = await supabaseClient
                    .from('email_settings')
                    .insert([settings])
                    .select();
                if (data) emailSettings = data[0];
            }
            
            alert('‚úÖ Email settings saved! You can now send quotes and invoices.');
            renderApp();
        }
        
        async function saveSMSSettings() {
            const enabled = document.getElementById('sms_enabled').checked;
            const notify_quote_sent = document.getElementById('notify_quote_sent').checked;
            const notify_invoice_sent = document.getElementById('notify_invoice_sent').checked;
            const notify_payment_received = document.getElementById('notify_payment_received').checked;
            const notify_job_reminder = document.getElementById('notify_job_reminder').checked;
            
            const settings = {
                user_id: currentUser.id,
                enabled: enabled,
                notify_quote_sent: notify_quote_sent,
                notify_invoice_sent: notify_invoice_sent,
                notify_payment_received: notify_payment_received,
                notify_job_reminder: notify_job_reminder
            };
            
            if (smsSettings) {
                // Update existing
                const { data } = await supabaseClient
                    .from('sms_settings')
                    .update(settings)
                    .eq('user_id', currentUser.id)
                    .select();
                if (data) smsSettings = data[0];
            } else {
                // Create new
                const { data } = await supabaseClient
                    .from('sms_settings')
                    .insert([settings])
                    .select();
                if (data) smsSettings = data[0];
            }
            
            alert('‚úÖ SMS settings saved!');
            renderApp();
        }
        
        function copyPaymentLink(invoiceId) {
            const paymentUrl = `${window.location.origin}/payment.html?invoice=${invoiceId}`;
            
            // Copy to clipboard
            navigator.clipboard.writeText(paymentUrl).then(() => {
                alert('Payment link copied to clipboard! Send this link to your client:\n\n' + paymentUrl);
            }).catch(() => {
                // Fallback for older browsers
                prompt('Copy this payment link and send it to your client:', paymentUrl);
            });
        }
        
        function exportToCSV(type) {
            let data = [];
            let filename = '';
            let headers = [];
            
            if (type === 'clients') {
                headers = ['Name', 'Email', 'Phone', 'Address', 'Notes'];
                data = clients.map(c => [c.name, c.email, c.phone, c.address || '', c.notes || '']);
                filename = 'clients.csv';
            } else if (type === 'jobs') {
                headers = ['Client', 'Title', 'Date', 'Time', 'Status', 'Notes'];
                data = jobs.map(j => {
                    const client = clients.find(c => c.id === j.client_id);
                    return [client?.name || 'Unknown', j.title, j.date, j.time, j.status || 'scheduled', j.notes || ''];
                });
                filename = 'jobs.csv';
            } else if (type === 'quotes') {
                headers = ['Client', 'Title', 'Date', 'Total', 'Status', 'Accepted'];
                data = quotes.map(q => {
                    const client = clients.find(c => c.id === q.client_id);
                    return [client?.name || 'Unknown', q.title, q.date, q.total, q.status, q.accepted ? 'Yes' : 'No'];
                });
                filename = 'quotes.csv';
            } else if (type === 'invoices') {
                headers = ['Client', 'Invoice #', 'Title', 'Issue Date', 'Due Date', 'Total', 'Status'];
                data = invoices.map(i => {
                    const client = clients.find(c => c.id === i.client_id);
                    return [client?.name || 'Unknown', i.invoice_number, i.title, i.issue_date, i.due_date || '', i.total, i.status];
                });
                filename = 'invoices.csv';
            } else if (type === 'expenses') {
                headers = ['Date', 'Amount', 'Category', 'Description'];
                data = expenses.map(e => [e.date, e.amount, e.category, e.description || '']);
                filename = 'expenses.csv';
            }
            
            // Create CSV content
            let csvContent = headers.join(',') + '\n';
            data.forEach(row => {
                csvContent += row.map(cell => `"${String(cell).replace(/"/g, '""')}"`).join(',') + '\n';
            });
            
            // Download CSV
            const blob = new Blob([csvContent], { type: 'text/csv' });
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            window.URL.revokeObjectURL(url);
        }
        
        async function renderContent() {
            if (activeTab === 'dashboard') return renderDashboard();
            if (activeTab === 'schedule') return renderSchedule();
            if (activeTab === 'clients') return renderClients();
            if (activeTab === 'quotes') return renderQuotes();
            if (activeTab === 'invoices') return renderInvoices();
            if (activeTab === 'expenses') return renderExpenses();
            if (activeTab === 'analytics') return renderAnalytics();
            if (activeTab === 'company') return renderSettings();
            if (activeTab === 'team') return renderTeam();
            if (activeTab === 'admin' && isAdmin) return await renderAdmin();
        }
        
        function renderAnalytics() {
            // Calculate all metrics
            const totalQuotes = quotes.length;
            const acceptedQuotes = quotes.filter(q => q.status === 'accepted' || q.accepted).length;
            const quoteWinRate = totalQuotes > 0 ? ((acceptedQuotes / totalQuotes) * 100).toFixed(1) : 0;
            
            const avgQuoteValue = totalQuotes > 0 ? (quotes.reduce((sum, q) => sum + (q.total || 0), 0) / totalQuotes).toFixed(2) : 0;
            
            const totalInvoices = invoices.length;
            const paidInvoices = invoices.filter(inv => inv.status === 'paid').length;
            const unpaidInvoices = invoices.filter(inv => inv.status === 'unpaid').length;
            const overdueInvoices = invoices.filter(inv => {
                if (inv.status !== 'paid' && inv.due_date) {
                    const dueDate = new Date(inv.due_date);
                    dueDate.setHours(0,0,0,0);
                    // Add 24-hour grace period
                    dueDate.setDate(dueDate.getDate() + 1);
                    const today = new Date();
                    today.setHours(0,0,0,0);
                    return dueDate < today;
                }
                return false;
            }).length;
            
            const totalRevenue = invoices.filter(inv => inv.status === 'paid').reduce((sum, inv) => sum + (inv.total || 0), 0);
            const outstandingRevenue = invoices.filter(inv => inv.status === 'unpaid').reduce((sum, inv) => sum + (inv.total || 0), 0);
            
            // Expense metrics
            const totalExpenses = expenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            const netProfit = totalRevenue - totalExpenses;
            const profitMargin = totalRevenue > 0 ? ((netProfit / totalRevenue) * 100).toFixed(1) : 0;
            
            // Average collection time (for paid invoices)
            const paidInvoicesWithDates = invoices.filter(inv => inv.status === 'paid' && inv.date && inv.paid_date);
            const avgCollectionDays = paidInvoicesWithDates.length > 0 
                ? Math.round(paidInvoicesWithDates.reduce((sum, inv) => {
                    const created = new Date(inv.date);
                    const paid = new Date(inv.paid_date);
                    const days = Math.ceil((paid - created) / (1000 * 60 * 60 * 24));
                    return sum + days;
                }, 0) / paidInvoicesWithDates.length)
                : 0;
            
            // Most profitable clients
            const clientRevenue = {};
            invoices.filter(inv => inv.status === 'paid').forEach(inv => {
                const clientId = inv.client_id;
                if (!clientRevenue[clientId]) clientRevenue[clientId] = 0;
                clientRevenue[clientId] += inv.total || 0;
            });
            const topClients = Object.entries(clientRevenue)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5)
                .map(([clientId, revenue]) => {
                    const client = clients.find(c => c.id === clientId);
                    return { name: client?.name || 'Unknown', revenue };
                });
            
            // Monthly revenue trend (last 6 months)
            const monthlyRevenue = {};
            const now = new Date();
            for (let i = 5; i >= 0; i--) {
                const date = new Date(now.getFullYear(), now.getMonth() - i, 1);
                const key = date.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                monthlyRevenue[key] = 0;
            }
            invoices.filter(inv => inv.status === 'paid' && inv.paid_date).forEach(inv => {
                const paidDate = new Date(inv.paid_date);
                const key = paidDate.toLocaleDateString('en-US', { month: 'short', year: 'numeric' });
                if (monthlyRevenue[key] !== undefined) {
                    monthlyRevenue[key] += inv.total || 0;
                }
            });
            
            // Conversion funnel
            const totalJobs = jobs.length;
            const completedJobs = jobs.filter(j => j.status === 'completed').length;
            
            // Insights & Alerts
            const insights = [];
            if (quoteWinRate < 30 && totalQuotes >= 5) {
                insights.push({ type: 'warning', text: `Your quote win rate is ${quoteWinRate}% - Consider reviewing your pricing or proposal approach` });
            }
            if (avgCollectionDays > 45 && paidInvoicesWithDates.length >= 3) {
                insights.push({ type: 'warning', text: `Average payment time is ${avgCollectionDays} days - Consider sending earlier payment reminders` });
            }
            if (overdueInvoices > 0) {
                insights.push({ type: 'alert', text: `You have ${overdueInvoices} overdue invoice${overdueInvoices > 1 ? 's' : ''} - Follow up with clients for payment` });
            }
            if (quoteWinRate >= 60 && totalQuotes >= 5) {
                insights.push({ type: 'success', text: `Excellent ${quoteWinRate}% quote win rate - Your pricing and proposals are working well!` });
            }
            if (totalRevenue === 0 && totalInvoices > 0) {
                insights.push({ type: 'info', text: 'No revenue collected yet - Mark invoices as paid when clients pay' });
            }
            
            return `<div>
                <h2 class="text-2xl font-bold mb-6">üìä Analytics & Insights</h2>
                
                ${insights.length > 0 ? `
                    <div class="mb-6 space-y-3">
                        ${insights.map(insight => `
                            <div class="p-4 rounded-lg border-l-4 ${
                                insight.type === 'warning' ? 'bg-yellow-50 border-yellow-500' :
                                insight.type === 'alert' ? 'bg-red-50 border-red-500' :
                                insight.type === 'success' ? 'bg-green-50 border-green-500' :
                                'bg-blue-50 border-blue-500'
                            }">
                                <p class="text-sm font-medium ${
                                    insight.type === 'warning' ? 'text-yellow-800' :
                                    insight.type === 'alert' ? 'text-red-800' :
                                    insight.type === 'success' ? 'text-green-800' :
                                    'text-blue-800'
                                }">${insight.text}</p>
                            </div>
                        `).join('')}
                    </div>
                ` : ''}
                
                <!-- Key Metrics Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-teal-500">
                        <div class="text-sm text-gray-600 mb-1">Quote Win Rate</div>
                        <div class="text-3xl font-bold text-teal-600">${quoteWinRate}%</div>
                        <div class="text-xs text-gray-500 mt-1">${acceptedQuotes} of ${totalQuotes} quotes accepted</div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-green-500">
                        <div class="text-sm text-gray-600 mb-1">Total Revenue</div>
                        <div class="text-3xl font-bold text-green-600">$${totalRevenue.toFixed(2)}</div>
                        <div class="text-xs text-gray-500 mt-1">${paidInvoices} paid invoices</div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-red-500">
                        <div class="text-sm text-gray-600 mb-1">Total Expenses</div>
                        <div class="text-3xl font-bold text-red-600">$${totalExpenses.toFixed(2)}</div>
                        <div class="text-xs text-gray-500 mt-1">${expenses.length} expenses</div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-${netProfit >= 0 ? 'blue' : 'orange'}-500">
                        <div class="text-sm text-gray-600 mb-1">Net Profit</div>
                        <div class="text-3xl font-bold text-${netProfit >= 0 ? 'blue' : 'orange'}-600">$${netProfit.toFixed(2)}</div>
                        <div class="text-xs text-gray-500 mt-1">${profitMargin}% margin</div>
                    </div>
                    
                    <div class="bg-white p-6 rounded-lg shadow-lg border-l-4 border-orange-500">
                        <div class="text-sm text-gray-600 mb-1">Outstanding</div>
                        <div class="text-3xl font-bold text-orange-600">$${outstandingRevenue.toFixed(2)}</div>
                        <div class="text-xs text-gray-500 mt-1">${unpaidInvoices} unpaid invoices</div>
                    </div>
                </div>
                
                <!-- Secondary Metrics -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600 mb-1">Avg Collection Time</div>
                        <div class="text-2xl font-bold">${avgCollectionDays} days</div>
                        <div class="text-xs text-gray-500 mt-1">${paidInvoicesWithDates.length} paid invoices tracked</div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600 mb-1">Total Clients</div>
                        <div class="text-2xl font-bold">${clients.length}</div>
                        <div class="text-xs text-gray-500 mt-1">Active client base</div>
                    </div>
                    
                    <div class="bg-white p-4 rounded-lg shadow">
                        <div class="text-sm text-gray-600 mb-1">Completed Jobs</div>
                        <div class="text-2xl font-bold">${completedJobs}</div>
                        <div class="text-xs text-gray-500 mt-1">${totalJobs} total jobs</div>
                    </div>
                </div>
                
                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <!-- Monthly Revenue Trend -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-4">Revenue Trend (Last 6 Months)</h3>
                        <div class="space-y-2">
                            ${Object.entries(monthlyRevenue).map(([month, revenue]) => {
                                const maxRevenue = Math.max(...Object.values(monthlyRevenue), 1);
                                const percentage = (revenue / maxRevenue) * 100;
                                return `
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span class="text-gray-600">${month}</span>
                                            <span class="font-medium">$${revenue.toFixed(2)}</span>
                                        </div>
                                        <div class="w-full bg-gray-200 rounded-full h-2">
                                            <div class="bg-teal-500 h-2 rounded-full" style="width: ${percentage}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>
                    
                    <!-- Top Clients -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-4">Top 5 Clients by Revenue</h3>
                        ${topClients.length > 0 ? `
                            <div class="space-y-3">
                                ${topClients.map((client, index) => `
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-3">
                                            <div class="w-8 h-8 rounded-full bg-teal-100 flex items-center justify-center font-bold text-teal-600">
                                                ${index + 1}
                                            </div>
                                            <span class="font-medium">${client.name}</span>
                                        </div>
                                        <span class="text-green-600 font-bold">$${client.revenue.toFixed(2)}</span>
                                    </div>
                                `).join('')}
                            </div>
                        ` : '<div class="text-center text-gray-500 py-8">No client revenue data yet</div>'}
                    </div>
                </div>
                
                <!-- Conversion Funnel -->
                <div class="bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-bold mb-4">Business Funnel</h3>
                    <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                        <div class="text-center p-4 bg-blue-50 rounded">
                            <div class="text-3xl font-bold text-blue-600">${totalQuotes}</div>
                            <div class="text-sm text-gray-600 mt-1">Quotes Sent</div>
                        </div>
                        <div class="text-center p-4 bg-teal-50 rounded">
                            <div class="text-3xl font-bold text-teal-600">${acceptedQuotes}</div>
                            <div class="text-sm text-gray-600 mt-1">Quotes Accepted</div>
                        </div>
                        <div class="text-center p-4 bg-purple-50 rounded">
                            <div class="text-3xl font-bold text-purple-600">${totalInvoices}</div>
                            <div class="text-sm text-gray-600 mt-1">Invoices Sent</div>
                        </div>
                        <div class="text-center p-4 bg-green-50 rounded">
                            <div class="text-3xl font-bold text-green-600">${paidInvoices}</div>
                            <div class="text-sm text-gray-600 mt-1">Invoices Paid</div>
                        </div>
                    </div>
                </div>
                
            </div>`;
        }
        
        function renderTeam() {
            return `<div>
                <div class="flex justify-between mb-6">
                    <h2 class="text-2xl font-bold">Team Members</h2>
                    <button onclick="openModal('team_member')" class="bg-black text-white px-4 py-2 rounded-lg hover:bg-gray-800 border border-teal-400">+ Add Team Member</button>
                </div>
                <div class="grid gap-4">
                    ${teamMembers.length === 0 ? '<div class="text-center py-12 text-gray-500">No team members yet. Add your first worker!</div>' : teamMembers.map(member => `
                        <div class="bg-white p-4 rounded-lg shadow border-l-4" style="border-color: ${member.color || '#3b82f6'}">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="text-lg font-semibold">${member.name}</h3>
                                    ${member.occupation ? `<p class="text-sm text-gray-600 font-medium">${member.occupation}</p>` : ''}
                                    <p class="text-sm text-gray-600">${member.email || 'No email'}</p>
                                    <p class="text-sm text-gray-600">${member.phone || 'No phone'}</p>
                                    <div class="flex items-center gap-2 mt-2">
                                        <div class="w-4 h-4 rounded" style="background-color: ${member.color || '#3b82f6'}"></div>
                                        <span class="text-xs text-gray-500">Calendar color</span>
                                    </div>
                                </div>
                                <div class="flex gap-2">
                                    <button onclick="editTeamMember('${member.id}')" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Edit</button>
                                    <button onclick="deleteTeamMember('${member.id}')" class="px-3 py-1 text-red-600 border rounded text-sm">Delete</button>
                                </div>
                            </div>
                        </div>
                    `).join('')}
                </div>
            </div>`;
        }
        
        async function addTeamMember(member) {
            const { data } = await supabaseClient.from('team_members').insert([{
                ...member,
                account_owner_id: currentUser.id
            }]).select();
            if (data) teamMembers.push(data[0]);
            closeModal();
            renderApp();
        }
        
        async function editTeamMember(id) {
            const member = teamMembers.find(m => m.id === id);
            editingItem = member;
            modalType = 'team_member';
            showModal = true;
            renderApp();
        }
        
        async function updateTeamMember(id) {
            const updatedMember = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                occupation: document.getElementById('occupation').value,
                color: document.getElementById('color').value
            };
            const { data } = await supabaseClient.from('team_members').update(updatedMember).eq('id', id).select();
            if (data) {
                const index = teamMembers.findIndex(m => m.id === id);
                if (index !== -1) teamMembers[index] = data[0];
                closeModal();
                renderApp();
            }
        }
        
        async function deleteTeamMember(id) {
            if (confirm('Delete this team member?')) {
                await supabaseClient.from('team_members').delete().eq('id', id);
                teamMembers = teamMembers.filter(m => m.id !== id);
                renderApp();
            }
        }
        
        function renderPaywall() {
            const accountType = subscription?.account_type || 'sole_trader';
            const monthlyRate = subscription?.monthly_rate || 19.99;
            const accountTypeName = accountType === 'business' ? 'Business' : 'Sole Trader';
            
            document.getElementById('app').innerHTML = `
                <div class="min-h-screen bg-gray-50 flex items-center justify-center p-6">
                    <div class="bg-white p-8 rounded-lg shadow-xl max-w-2xl w-full">
                        <div class="text-center mb-8">
                            <div class="text-teal-400 text-5xl font-bold mb-2">M4</div>
                            <h1 class="text-2xl font-bold text-black">Streamline</h1>
                            <p class="text-gray-600 mt-2">Business Management</p>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-6">
                            <p class="text-yellow-700 font-medium">‚è∞ Your 14-day free trial has ended</p>
                        </div>
                        
                        <div class="bg-teal-50 p-3 rounded mb-4 text-center">
                            <p class="text-sm text-teal-800"><strong>${accountTypeName}</strong> Account</p>
                        </div>
                        
                        <h2 class="text-2xl font-bold mb-4">Continue with M4 Streamline</h2>
                        <p class="text-gray-600 mb-6">To continue using M4 Streamline, please subscribe for just <strong>$${monthlyRate.toFixed(2)}/month</strong>.</p>
                        
                        <div class="bg-gray-50 p-6 rounded-lg mb-6">
                            <h3 class="font-bold mb-3">Payment Instructions:</h3>
                            <ol class="list-decimal list-inside space-y-2 text-sm">
                                <li>Transfer $${monthlyRate.toFixed(2)} to the account details below</li>
                                <li>Include your email (<strong>${currentUser.email}</strong>) in the payment reference</li>
                                <li>Email m4projectsanddesigns@gmail.com to confirm payment</li>
                                <li>Your account will be activated within 24 hours</li>
                            </ol>
                        </div>
                        
                        <div class="bg-teal-50 p-6 rounded-lg border border-teal-200">
                            <h3 class="font-bold mb-3 text-teal-900">Bank Details:</h3>
                            <div class="space-y-2 text-sm">
                                <div><span class="font-medium">Account Name:</span> Keith Murphy</div>
                                <div><span class="font-medium">BSB:</span> 063-225</div>
                                <div><span class="font-medium">Account Number:</span> 10412509</div>
                                <div><span class="font-medium">Amount:</span> $${monthlyRate.toFixed(2)}</div>
                                <div><span class="font-medium">Reference:</span> ${currentUser.email}</div>
                            </div>
                        </div>
                        
                        <div class="mt-6 text-center">
                            <button onclick="handleLogout()" class="px-6 py-2 bg-gray-600 text-white rounded-lg hover:bg-gray-700">Logout</button>
                        </div>
                    </div>
                </div>
            `;
        }
        
        async function renderAdmin() {
            // Load all subscriptions
            const { data: allSubs, error } = await supabaseClient.from('subscriptions').select('*');
            
            if (error) {
                console.error('Error loading subscriptions:', error);
                console.error('Error message:', error.message);
                console.error('Error details:', error.details);
                console.error('Error hint:', error.hint);
                return `<div><h2 class="text-2xl font-bold mb-6">Admin - Subscription Management</h2><p class="text-red-600">Error: ${error.message || 'Unknown error'}</p></div>`;
            }
            
            const users = allSubs || [];
            console.log('Loaded subscriptions:', users);
            
            return `<div>
                <h2 class="text-2xl font-bold mb-6">Admin - Subscription Management</h2>
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    <table class="min-w-full">
                        <thead class="bg-gray-50">
                            <tr>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Email</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Status</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Trial Ends</th>
                                <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase">Actions</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200">
                            ${users.length === 0 ? '<tr><td colspan="4" class="px-6 py-4 text-center text-gray-500">No subscriptions found</td></tr>' : users.map(u => {
                                const trialEnds = new Date(u.trial_ends_at);
                                const daysLeft = Math.ceil((trialEnds - new Date()) / (1000 * 60 * 60 * 24));
                                const statusColor = u.subscription_status === 'active' ? 'text-green-600' : u.subscription_status === 'trial' ? 'text-yellow-600' : 'text-red-600';
                                
                                return `<tr>
                                    <td class="px-6 py-4 text-sm">${u.user_email || 'Unknown'}</td>
                                    <td class="px-6 py-4 text-sm ${statusColor} font-medium">${u.subscription_status.toUpperCase()}</td>
                                    <td class="px-6 py-4 text-sm">${trialEnds.toLocaleDateString()} (${daysLeft} days)</td>
                                    <td class="px-6 py-4 text-sm">
                                        ${u.subscription_status !== 'active' ? 
                                            `<button onclick="activateSubscription('${u.user_id}')" class="px-3 py-1 bg-green-600 text-white rounded text-xs mr-2">Activate</button>` : 
                                            `<button onclick="deactivateSubscription('${u.user_id}')" class="px-3 py-1 bg-red-600 text-white rounded text-xs mr-2">Deactivate</button>`
                                        }
                                        <button onclick="extendTrial('${u.user_id}')" class="px-3 py-1 bg-blue-600 text-white rounded text-xs">Extend Trial</button>
                                    </td>
                                </tr>`;
                            }).join('')}
                        </tbody>
                    </table>
                </div>
            </div>`;
        }
        
        async function activateSubscription(userId) {
            await supabaseClient.from('subscriptions').update({
                subscription_status: 'active',
                subscription_activated_at: new Date().toISOString()
            }).eq('user_id', userId);
            alert('Subscription activated!');
            renderApp();
        }
        
        async function deactivateSubscription(userId) {
            if (confirm('Are you sure you want to deactivate this subscription?')) {
                await supabaseClient.from('subscriptions').update({
                    subscription_status: 'expired'
                }).eq('user_id', userId);
                alert('Subscription deactivated!');
                renderApp();
            }
        }
        
        async function extendTrial(userId) {
            const days = prompt('How many days to extend trial?', '14');
            if (days) {
                const { data } = await supabaseClient.from('subscriptions').select('trial_ends_at').eq('user_id', userId).single();
                const currentEnd = new Date(data.trial_ends_at);
                const newEnd = new Date(currentEnd.getTime() + parseInt(days) * 24 * 60 * 60 * 1000);
                
                await supabaseClient.from('subscriptions').update({
                    trial_ends_at: newEnd.toISOString()
                }).eq('user_id', userId);
                
                alert(`Trial extended by ${days} days!`);
                renderApp();
            }
        }
        
        function renderSettings() {
            const settings = companySettings || {};
            const stripe = stripeSettings || {};
            return `<div>
                <h2 class="text-2xl font-bold mb-6">Company Settings</h2>
                
                <!-- Company Info -->
                <div class="bg-white p-6 rounded-lg shadow max-w-2xl mb-6">
                    <p class="text-gray-600 mb-6">Your business information will automatically appear on all quotes and invoices.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">Business Name</label>
                            <input type="text" id="business_name" value="${settings.business_name || ''}" class="w-full px-4 py-2 border rounded">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">ABN</label>
                            <input type="text" id="abn" value="${settings.abn || ''}" class="w-full px-4 py-2 border rounded">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Phone</label>
                            <input type="tel" id="settings_phone" value="${settings.phone || ''}" class="w-full px-4 py-2 border rounded">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Email</label>
                            <input type="email" id="settings_email" value="${settings.email || ''}" class="w-full px-4 py-2 border rounded">
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Address</label>
                            <textarea id="settings_address" class="w-full px-4 py-2 border rounded" rows="2">${settings.address || ''}</textarea>
                        </div>
                        
                        <h3 class="text-lg font-bold mt-6 mb-4">Bank Details (for invoices)</h3>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Bank Name</label>
                            <input type="text" id="bank_name" value="${settings.bank_name || ''}" class="w-full px-4 py-2 border rounded">
                        </div>
                        
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label class="block text-sm font-medium mb-1">BSB</label>
                                <input type="text" id="bsb" value="${settings.bsb || ''}" class="w-full px-4 py-2 border rounded">
                            </div>
                            <div>
                                <label class="block text-sm font-medium mb-1">Account Number</label>
                                <input type="text" id="account_number" value="${settings.account_number || ''}" class="w-full px-4 py-2 border rounded">
                            </div>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Account Name</label>
                            <input type="text" id="account_name" value="${settings.account_name || ''}" class="w-full px-4 py-2 border rounded">
                        </div>
                        
                        <button onclick="saveCompanySettings()" class="w-full bg-black text-white px-4 py-3 rounded-lg border border-teal-400 hover:bg-gray-800 mt-6">Save Company Settings</button>
                    </div>
                </div>
                
                <!-- Stripe Payment Settings -->
                <div class="bg-white p-6 rounded-lg shadow max-w-2xl">
                    <h3 class="text-lg font-bold mb-2">üí≥ Stripe Payment Settings</h3>
                    <p class="text-sm text-gray-600 mb-6">Enable online payments for your invoices. Get your API keys from <a href="https://dashboard.stripe.com/apikeys" target="_blank" class="text-teal-600 underline">Stripe Dashboard</a>.</p>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                            <div>
                                <p class="font-medium">Enable Stripe Payments</p>
                                <p class="text-xs text-gray-600">Turn off to show bank details instead</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="stripe_enabled" ${stripe.enabled !== false ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div>
                            </label>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Publishable Key</label>
                            <input type="text" id="stripe_publishable_key" value="${stripe.publishable_key || ''}" placeholder="pk_test_... (optional)" class="w-full px-4 py-2 border rounded font-mono text-sm">
                            <p class="text-xs text-gray-500 mt-1">Starts with pk_test_ or pk_live_</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">Secret Key</label>
                            <input type="password" id="stripe_secret_key" value="${stripe.secret_key || ''}" placeholder="sk_test_... (optional)" class="w-full px-4 py-2 border rounded font-mono text-sm">
                            <p class="text-xs text-gray-500 mt-1">Starts with sk_test_ or sk_live_</p>
                        </div>
                        
                        ${stripe.enabled !== false && stripe.publishable_key ? '<div class="bg-green-50 border border-green-200 rounded p-3 text-sm text-green-800">‚úì Stripe is enabled. Clients can pay invoices online!</div>' : '<div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-sm text-yellow-800">‚ö† Stripe is disabled. Clients will see bank transfer details.</div>'}
                        
                        <button onclick="saveStripeSettings()" class="w-full bg-black text-white px-4 py-3 rounded-lg border border-teal-400 hover:bg-gray-800">Save Stripe Settings</button>
                    </div>
                </div>
                
                <!-- SendGrid Email Settings -->
                <div class="bg-white p-6 rounded-lg shadow max-w-2xl">
                    <h3 class="text-lg font-bold mb-2">üìß Email Settings (SendGrid)</h3>
                    <p class="text-sm text-gray-600 mb-6">Configure email delivery for quotes and invoices. Get your API key from <a href="https://app.sendgrid.com/settings/api_keys" target="_blank" class="text-teal-600 underline">SendGrid Dashboard</a>.</p>
                    
                    <div class="space-y-4">
                        <div>
                            <label class="block text-sm font-medium mb-1">SendGrid API Key</label>
                            <input type="password" id="sendgrid_api_key" value="${emailSettings?.sendgrid_api_key || ''}" placeholder="SG...." class="w-full px-4 py-2 border rounded font-mono text-sm">
                            <p class="text-xs text-gray-500 mt-1">Starts with SG.</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">From Email (Verified in SendGrid)</label>
                            <input type="email" id="sendgrid_from_email" value="${emailSettings?.from_email || companySettings?.email || ''}" placeholder="your@email.com" class="w-full px-4 py-2 border rounded">
                            <p class="text-xs text-gray-500 mt-1">Must be verified in SendGrid</p>
                        </div>
                        
                        <div>
                            <label class="block text-sm font-medium mb-1">From Name</label>
                            <input type="text" id="sendgrid_from_name" value="${emailSettings?.from_name || companySettings?.business_name || ''}" placeholder="Your Business Name" class="w-full px-4 py-2 border rounded">
                        </div>
                        
                        ${emailSettings?.sendgrid_api_key ? '<div class="bg-green-50 border border-green-200 rounded p-3 text-sm text-green-800">‚úì Email is configured. You can send quotes and invoices!</div>' : '<div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-sm text-yellow-800">‚ö† Add your SendGrid API key to enable email sending</div>'}
                        
                        <button onclick="saveEmailSettings()" class="w-full bg-black text-white px-4 py-3 rounded-lg border border-teal-400 hover:bg-gray-800">Save Email Settings</button>
                    </div>
                </div>
                
                <!-- SMS Settings -->
                <div class="bg-white p-6 rounded-lg shadow max-w-2xl">
                    <h3 class="text-lg font-bold mb-2">üì± SMS Notifications (Twilio)</h3>
                    <p class="text-sm text-gray-600 mb-6">Send SMS notifications to clients. Solves email delivery issues (BigPond, etc.)</p>
                    
                    <div class="space-y-4">
                        <div class="flex items-center justify-between p-4 bg-gray-50 rounded-lg border">
                            <div>
                                <p class="font-medium">Enable SMS Notifications</p>
                                <p class="text-xs text-gray-600">Turn on to send SMS to clients</p>
                            </div>
                            <label class="relative inline-flex items-center cursor-pointer">
                                <input type="checkbox" id="sms_enabled" ${smsSettings?.enabled ? 'checked' : ''} class="sr-only peer">
                                <div class="w-11 h-6 bg-gray-200 peer-focus:outline-none peer-focus:ring-4 peer-focus:ring-teal-300 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all peer-checked:bg-teal-600"></div>
                            </label>
                        </div>
                        
                        <div class="bg-blue-50 border border-blue-200 rounded p-3 text-sm">
                            <p class="text-blue-900 font-medium mb-1">üìä SMS Usage</p>
                            <p class="text-blue-700">${smsSettings?.sms_count_current_month || 0} / ${smsSettings?.sms_limit || 50} SMS used this month</p>
                            <div class="w-full bg-blue-200 rounded-full h-2 mt-2">
                                <div class="bg-blue-600 h-2 rounded-full" style="width: ${Math.min(((smsSettings?.sms_count_current_month || 0) / (smsSettings?.sms_limit || 50)) * 100, 100)}%"></div>
                            </div>
                        </div>
                        
                        <h4 class="font-semibold mt-4">Send SMS when:</h4>
                        
                        <label class="flex items-center space-x-3 cursor-pointer p-3 hover:bg-gray-50 rounded">
                            <input type="checkbox" id="notify_quote_sent" ${smsSettings?.notify_quote_sent !== false ? 'checked' : ''} class="w-5 h-5 text-teal-600 rounded">
                            <div>
                                <p class="font-medium">Quote Sent</p>
                                <p class="text-xs text-gray-600">Notify client when quote is ready</p>
                            </div>
                        </label>
                        
                        <label class="flex items-center space-x-3 cursor-pointer p-3 hover:bg-gray-50 rounded">
                            <input type="checkbox" id="notify_invoice_sent" ${smsSettings?.notify_invoice_sent !== false ? 'checked' : ''} class="w-5 h-5 text-teal-600 rounded">
                            <div>
                                <p class="font-medium">Invoice Sent</p>
                                <p class="text-xs text-gray-600">Notify client when invoice is ready</p>
                            </div>
                        </label>
                        
                        <label class="flex items-center space-x-3 cursor-pointer p-3 hover:bg-gray-50 rounded">
                            <input type="checkbox" id="notify_payment_received" ${smsSettings?.notify_payment_received ? 'checked' : ''} class="w-5 h-5 text-teal-600 rounded">
                            <div>
                                <p class="font-medium">Payment Received</p>
                                <p class="text-xs text-gray-600">Thank client when payment is received</p>
                            </div>
                        </label>
                        
                        <label class="flex items-center space-x-3 cursor-pointer p-3 hover:bg-gray-50 rounded">
                            <input type="checkbox" id="notify_job_reminder" ${smsSettings?.notify_job_reminder ? 'checked' : ''} class="w-5 h-5 text-teal-600 rounded">
                            <div>
                                <p class="font-medium">Job Reminder</p>
                                <p class="text-xs text-gray-600">Remind client 1 day before scheduled job</p>
                            </div>
                        </label>
                        
                        ${smsSettings?.enabled ? '<div class="bg-green-50 border border-green-200 rounded p-3 text-sm text-green-800">‚úì SMS is enabled. Clients will receive SMS notifications!</div>' : '<div class="bg-yellow-50 border border-yellow-200 rounded p-3 text-sm text-yellow-800">‚ö† SMS is disabled. Turn on to start sending SMS</div>'}
                        
                        <button onclick="saveSMSSettings()" class="w-full bg-black text-white px-4 py-3 rounded-lg border border-teal-400 hover:bg-gray-800">Save SMS Settings</button>
                    </div>
                </div>
            </div>`;
        }
        
        function renderDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const tomorrow = new Date(Date.now() + 86400000).toISOString().split('T')[0];
            const upcomingJobs = jobs.filter(j => j.date >= today).sort((a, b) => new Date(a.date) - new Date(b.date)).slice(0, 5);
            const tomorrowJobs = jobs.filter(j => j.date === tomorrow);
            const pendingQuotes = quotes.filter(q => q.status === 'pending' && !q.accepted);
            const acceptedQuotes = quotes.filter(q => q.accepted || q.status === 'accepted');
            const unpaidInvoices = invoices.filter(i => i.status === 'unpaid');
            
            // Quote expiry warnings (48 hours before 30 days)
            const expiringQuotes = quotes.filter(q => {
                if (q.accepted || q.status !== 'pending') return false;
                const createdDate = new Date(q.created_at);
                const expiryDate = new Date(createdDate);
                expiryDate.setDate(expiryDate.getDate() + 30);
                const warningDate = new Date(expiryDate);
                warningDate.setHours(warningDate.getHours() - 48);
                const now = new Date();
                return now >= warningDate && now < expiryDate;
            });
            
            // Overdue invoices
            const todayDate = new Date();
            todayDate.setHours(0,0,0,0);
            const overdueInvoices = unpaidInvoices.filter(i => {
                if (!i.due_date) return false;
                const dueDate = new Date(i.due_date);
                dueDate.setHours(0,0,0,0);
                // Add 24-hour grace period
                dueDate.setDate(dueDate.getDate() + 1);
                return dueDate < todayDate;
            });
            
            const totalUnpaid = unpaidInvoices.reduce((sum, inv) => sum + parseFloat(inv.total || 0), 0);
            const totalRevenue = invoices.filter(i => i.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total || 0), 0);
            
            return `<div>
                <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
                
                <!-- Alerts -->
                ${tomorrowJobs.length > 0 ? `<div class="bg-blue-50 border-l-4 border-blue-500 p-4 mb-4 cursor-pointer hover:bg-blue-100" onclick="switchTab('schedule')"><div class="flex"><div class="flex-shrink-0">‚è∞</div><div class="ml-3"><p class="text-sm text-blue-700"><strong>Tomorrow's Jobs (${tomorrowJobs.length}):</strong> ${tomorrowJobs.map(j => j.title).join(', ')}</p></div></div></div>` : ''}
                ${expiringQuotes.length > 0 ? `<div class="bg-yellow-50 border-l-4 border-yellow-500 p-4 mb-4 cursor-pointer hover:bg-yellow-100" onclick="switchTab('quotes')"><div class="flex"><div class="flex-shrink-0">‚ö†Ô∏è</div><div class="ml-3"><p class="text-sm text-yellow-700"><strong>Quotes Expiring Soon (${expiringQuotes.length}):</strong> These quotes will expire in less than 48 hours</p></div></div></div>` : ''}
                ${overdueInvoices.length > 0 ? `<div class="bg-red-50 border-l-4 border-red-500 p-4 mb-4 cursor-pointer hover:bg-red-100" onclick="switchTab('invoices')"><div class="flex"><div class="flex-shrink-0">üö®</div><div class="ml-3"><p class="text-sm text-red-700"><strong>Overdue Invoices (${overdueInvoices.length}):</strong> $${overdueInvoices.reduce((s,i) => s + parseFloat(i.total || 0), 0).toFixed(2)} overdue</p></div></div></div>` : ''}
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-teal-400 cursor-pointer hover:bg-gray-50" onclick="switchTab('clients')">
                        <div class="text-gray-600 text-sm">Total Clients</div>
                        <div class="text-3xl font-bold mt-2">${clients.length}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-400 cursor-pointer hover:bg-gray-50" onclick="switchTab('schedule')">
                        <div class="text-gray-600 text-sm">Upcoming Jobs</div>
                        <div class="text-3xl font-bold mt-2">${upcomingJobs.length}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-yellow-400 cursor-pointer hover:bg-gray-50" onclick="switchTab('quotes')">
                        <div class="text-gray-600 text-sm">Pending Quotes</div>
                        <div class="text-3xl font-bold mt-2">${pendingQuotes.length}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-red-400 cursor-pointer hover:bg-gray-50" onclick="switchTab('invoices')">
                        <div class="text-gray-600 text-sm">Unpaid Invoices</div>
                        <div class="text-3xl font-bold mt-2">$${totalUnpaid.toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Upcoming Jobs -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold">Upcoming Jobs</h3>
                            <button onclick="switchTab('schedule')" class="text-teal-500 text-sm hover:underline">View All</button>
                        </div>
                        ${upcomingJobs.length === 0 ? '<p class="text-gray-500 text-center py-4">No upcoming jobs</p>' : upcomingJobs.map(job => {
                            const client = clients.find(c => c.id === job.client_id);
                            const isTomorrow = job.date === tomorrow;
                            return `<div class="border-l-4 ${isTomorrow ? 'border-blue-400 bg-blue-50' : 'border-teal-400'} pl-3 py-2 mb-3 cursor-pointer hover:bg-gray-50" onclick="switchTab('schedule')">
                                <div class="font-semibold">${job.title} ${isTomorrow ? '‚è∞' : ''}</div>
                                <div class="text-sm text-gray-600">${client?.name || 'Unknown'}</div>
                                <div class="text-sm text-gray-500">${new Date(job.date).toLocaleDateString()} at ${job.time}</div>
                            </div>`;
                        }).join('')}
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-4">Recent Activity</h3>
                        ${acceptedQuotes.length === 0 && unpaidInvoices.length === 0 ? '<p class="text-gray-500 text-center py-4">No recent activity</p>' : `
                            ${acceptedQuotes.slice(0, 3).map(q => {
                                const client = clients.find(c => c.id === q.client_id);
                                return `<div class="py-2 mb-2 border-b cursor-pointer hover:bg-gray-50" onclick="switchTab('quotes')">
                                    <div class="flex justify-between">
                                        <span class="text-sm">‚úì Quote accepted: <strong>${q.title}</strong></span>
                                    </div>
                                    <div class="text-xs text-gray-500">${client?.name || 'Unknown'} - $${q.total.toFixed(2)}</div>
                                </div>`;
                            }).join('')}
                            ${unpaidInvoices.slice(0, 3).map(inv => {
                                const client = clients.find(c => c.id === inv.client_id);
                                const isOverdue = inv.due_date && new Date(inv.due_date) < todayDate;
                                return `<div class="py-2 mb-2 border-b cursor-pointer hover:bg-gray-50" onclick="switchTab('invoices')">
                                    <div class="flex justify-between">
                                        <span class="text-sm">${isOverdue ? 'üö®' : '‚è≥'} ${isOverdue ? 'Overdue' : 'Unpaid'}: <strong>${inv.title}</strong></span>
                                    </div>
                                    <div class="text-xs text-gray-500">${client?.name || 'Unknown'} - $${inv.total.toFixed(2)}</div>
                                </div>`;
                            }).join('')}
                        `}
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-6 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-bold mb-4">Quick Actions</h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="openModal('client')" class="px-4 py-2 bg-black text-white rounded-lg border border-teal-400 hover:bg-gray-800">+ Add Client</button>
                        <button onclick="openModal('job')" class="px-4 py-2 bg-black text-white rounded-lg border border-teal-400 hover:bg-gray-800">+ Schedule Job</button>
                        <button onclick="openModal('quote')" class="px-4 py-2 bg-black text-white rounded-lg border border-teal-400 hover:bg-gray-800">+ Create Quote</button>
                    </div>
                </div>
            </div>`;
        }
        
        function renderSchedule() {
    const viewToggle = `<div class="flex gap-2"><button onclick="scheduleView='list'; renderApp();" class="px-3 py-2 rounded text-sm ${scheduleView === 'list' ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300'} border">List</button><button onclick="scheduleView='calendar'; renderApp();" class="px-3 py-2 rounded text-sm ${scheduleView === 'calendar' ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300'} border">Calendar</button></div>`;
    
    // Worker filter dropdown for calendar view
    const workerFilter = getAccountType() === 'business' && teamMembers.length > 0 
        ? `<select onchange="calendarFilter=this.value; renderApp();" class="px-3 py-2 border rounded bg-white text-sm">
            <option value="all" ${calendarFilter === 'all' ? 'selected' : ''}>All Workers</option>
            <option value="unassigned" ${calendarFilter === 'unassigned' ? 'selected' : ''}>Unassigned</option>
            ${teamMembers.map(m => `<option value="${m.id}" ${calendarFilter === m.id ? 'selected' : ''}>${m.name}${m.occupation ? ' - ' + m.occupation : ''}</option>`).join('')}
           </select>`
        : '';
    
    if (scheduleView === 'calendar') {
        setTimeout(() => renderCalendar(), 100);
        return `<div><div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6"><h2 class="text-2xl font-bold">Schedule</h2><div class="flex flex-wrap gap-2 sm:gap-4">${workerFilter}${viewToggle}<button onclick="openModal('job')" class="bg-black text-white px-4 py-2 rounded-lg border border-teal-400 text-sm whitespace-nowrap">+ Schedule Job</button></div></div><div id="calendar" class="bg-white p-4 rounded-lg shadow"></div></div>`;
    }
    
    return `<div><div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6"><h2 class="text-2xl font-bold">Schedule</h2><div class="flex flex-wrap gap-2 sm:gap-4">${viewToggle}<button onclick="exportToCSV('jobs')" class="bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-gray-700 text-sm whitespace-nowrap">Export CSV</button><button onclick="openModal('job')" class="bg-black text-white px-3 sm:px-4 py-2 rounded-lg border border-teal-400 text-sm whitespace-nowrap">+ Schedule Job</button></div></div><div class="grid gap-4">${jobs.length === 0 ? '<div class="text-center py-12 text-gray-500">No jobs</div>' : jobs.map(job => { 
        const client = clients.find(c => c.id === job.client_id);
        const assignedWorker = teamMembers.find(m => m.id === job.assigned_to);
        const workerColor = assignedWorker?.color || '#14b8a6';
        const statusColors = {
            scheduled: 'bg-blue-100 text-blue-800',
            in_progress: 'bg-yellow-100 text-yellow-800',
            completed: 'bg-green-100 text-green-800'
        };
        const statusLabels = {
            scheduled: 'Scheduled',
            in_progress: 'In Progress',
            completed: 'Completed'
        };
        const statusColor = statusColors[job.status] || statusColors.scheduled;
        const statusLabel = statusLabels[job.status] || statusLabels.scheduled;
        return `<div class="bg-white p-4 rounded-lg shadow border-l-4" style="border-color: ${workerColor}"><div class="flex flex-col sm:flex-row sm:justify-between gap-3"><div class="flex-1"><h3 class="text-lg font-semibold">${job.title}</h3><span class="text-xs ${statusColor} px-2 py-1 rounded inline-block mt-1">${statusLabel}</span><p class="text-gray-600 mt-1">${client?.name || 'Unknown'}</p>${client?.address ? `<p class="text-sm text-gray-500">üìç ${client.address}</p>` : ''}${assignedWorker ? `<p class="text-sm font-medium text-gray-700 mt-2">üë§ ${assignedWorker.name}${assignedWorker.occupation ? ' - ' + assignedWorker.occupation : ''}</p>` : '<p class="text-sm text-gray-400 mt-2">üë§ Unassigned</p>'}<div class="text-sm text-gray-500 mt-2">${new Date(job.date).toLocaleDateString()} ${job.time}</div>${job.notes ? `<p class="text-sm text-gray-700 mt-2 italic">${job.notes}</p>` : ''}${job.photos && job.photos.length > 0 ? `<div class="mt-3 flex gap-2 flex-wrap">${job.photos.map(photo => `<img src="${photo}" class="w-20 h-20 object-cover rounded border border-teal-400" />`).join('')}</div>` : ''}</div><div class="flex sm:flex-col gap-2"><button onclick='openModal("job", ${JSON.stringify(job).replace(/"/g, "&quot;")})' class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Edit</button><label class="cursor-pointer px-3 py-1 bg-teal-500 text-white rounded text-sm text-center"><input type="file" accept="image/*" onchange="uploadJobPhoto(this, '${job.id}')" class="hidden" />Add Photo</label><button onclick="deleteJob('${job.id}')" class="px-3 py-1 text-red-600 border border-red-200 rounded text-sm">Delete</button></div></div></div>`; 
    }).join('')}</div></div>`;
}

function renderCalendar() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;
    
    // Filter jobs based on selected worker
    let filteredJobs = jobs;
    if (calendarFilter !== 'all') {
        if (calendarFilter === 'unassigned') {
            filteredJobs = jobs.filter(job => !job.assigned_to);
        } else {
            filteredJobs = jobs.filter(job => job.assigned_to === calendarFilter);
        }
    }
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek'
        },
        events: filteredJobs.map(job => {
            const client = clients.find(c => c.id === job.client_id);
            const assignedWorker = teamMembers.find(m => m.id === job.assigned_to);
            const workerColor = assignedWorker?.color || '#14b8a6';
            const workerName = assignedWorker?.name || 'Unassigned';
            const duration = job.duration || 1;
            
            // Calculate end date for multi-day jobs
            const startDate = new Date(job.date + 'T' + job.time);
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + duration);
            
            return {
                title: job.title + (client ? ' - ' + client.name : '') + ' (' + workerName + ')' + (duration > 1 ? ` [${duration} days]` : ''),
                start: job.date + 'T' + job.time,
                end: endDate.toISOString().split('T')[0],
                backgroundColor: workerColor,
                borderColor: workerColor,
                extendedProps: {
                    jobId: job.id,
                    client: client?.name,
                    worker: workerName,
                    duration: duration
                }
            };
        }),
        eventClick: function(info) {
            const job = jobs.find(j => j.id === info.event.extendedProps.jobId);
            if (job) {
                const duration = job.duration || 1;
                const durationText = duration > 1 ? `\nDuration: ${duration} days` : '';
                alert('Job: ' + job.title + '\nClient: ' + info.event.extendedProps.client + '\nWorker: ' + info.event.extendedProps.worker + '\nDate: ' + new Date(job.date).toLocaleDateString() + '\nTime: ' + job.time + durationText);
            }
        }
    });
    
    calendar.render();
}
        
        function renderClients() {
            const filteredClients = clients.filter(c => 
                c.name.toLowerCase().includes(clientSearch.toLowerCase()) ||
                c.email.toLowerCase().includes(clientSearch.toLowerCase()) ||
                c.phone.includes(clientSearch) ||
                (c.address && c.address.toLowerCase().includes(clientSearch.toLowerCase()))
            );
            
            return `<div><div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6"><h2 class="text-2xl font-bold">Clients</h2><div class="flex flex-wrap gap-2"><button onclick="exportToCSV('clients')" class="bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-gray-700 text-sm whitespace-nowrap">Export CSV</button><button onclick="openModal('client')" class="bg-black text-white px-3 sm:px-4 py-2 rounded-lg border border-teal-400 text-sm whitespace-nowrap">+ Add Client</button></div></div><div class="mb-4"><input type="text" id="clientSearchInput" placeholder="Search clients..." value="${clientSearch}" oninput="clientSearch=this.value; renderClientsOnly();" class="w-full px-4 py-2 border rounded-lg text-sm" /></div><div id="clientsList" class="grid gap-4">${filteredClients.length === 0 ? '<div class="text-center py-12 text-gray-500">No clients found</div>' : filteredClients.map(c => `<div class="bg-white p-4 rounded-lg shadow"><div class="flex flex-col sm:flex-row sm:justify-between gap-3"><div class="flex-1"><h3 class="text-lg font-semibold">${c.name}</h3><p class="text-sm text-gray-600">${c.email}</p><p class="text-sm text-gray-600">${c.phone}</p>${c.address ? `<p class="text-sm text-gray-600 mt-1">üìç ${c.address}</p>` : ''}</div><div class="flex sm:flex-col gap-2"><button onclick='openQuoteForClient(${JSON.stringify(c).replace(/"/g, "&quot;")})' class="flex-1 sm:w-24 px-3 py-1 bg-teal-600 text-white rounded text-sm whitespace-nowrap">New Quote</button><button onclick='openModal("client", ${JSON.stringify(c).replace(/"/g, "&quot;")})' class="flex-1 sm:w-24 px-3 py-1 bg-blue-600 text-white rounded text-sm">Edit</button><button onclick="deleteClient('${c.id}')" class="flex-1 sm:w-24 px-3 py-1 text-red-600 border border-red-200 rounded text-sm">Delete</button></div></div></div>`).join('')}</div></div>`;
        }
        
        function renderClientsOnly() {
            const filteredClients = clients.filter(c => 
                c.name.toLowerCase().includes(clientSearch.toLowerCase()) ||
                c.email.toLowerCase().includes(clientSearch.toLowerCase()) ||
                c.phone.includes(clientSearch) ||
                (c.address && c.address.toLowerCase().includes(clientSearch.toLowerCase()))
            );
            
            const listHtml = filteredClients.length === 0 ? '<div class="text-center py-12 text-gray-500">No clients found</div>' : filteredClients.map(c => `<div class="bg-white p-4 rounded-lg shadow"><div class="flex flex-col sm:flex-row sm:justify-between gap-3"><div class="flex-1"><h3 class="text-lg font-semibold">${c.name}</h3><p class="text-sm text-gray-600">${c.email}</p><p class="text-sm text-gray-600">${c.phone}</p>${c.address ? `<p class="text-sm text-gray-600 mt-1">üìç ${c.address}</p>` : ''}</div><div class="flex sm:flex-col gap-2"><button onclick='openQuoteForClient(${JSON.stringify(c).replace(/"/g, "&quot;")})' class="flex-1 sm:w-24 px-3 py-1 bg-teal-600 text-white rounded text-sm whitespace-nowrap">New Quote</button><button onclick='openModal("client", ${JSON.stringify(c).replace(/"/g, "&quot;")})' class="flex-1 sm:w-24 px-3 py-1 bg-blue-600 text-white rounded text-sm">Edit</button><button onclick="deleteClient('${c.id}')" class="flex-1 sm:w-24 px-3 py-1 text-red-600 border border-red-200 rounded text-sm">Delete</button></div></div></div>`).join('');
            
            const listElement = document.getElementById('clientsList');
            if (listElement) listElement.innerHTML = listHtml;
        }
        
        function renderQuotes() {
    const successNotification = lastCreatedQuote ? `<div class="bg-green-50 border-l-4 border-green-500 p-4 mb-4"><div class="flex justify-between items-center"><div><p class="text-sm text-green-700"><strong>‚úì Quote Created!</strong> ${lastCreatedQuote.title} has been created successfully.</p></div></div></div>` : '';
    
    // Auto-dismiss notification after 5 seconds
    if (lastCreatedQuote) {
        setTimeout(() => {
            lastCreatedQuote = null;
            renderApp();
        }, 5000);
    }
    
    return `<div>${successNotification}<div class="flex flex-col sm:flex-row sm:justify-between sm:items-center gap-3 mb-6"><h2 class="text-2xl font-bold">Quotes</h2><div class="flex flex-wrap gap-2"><button onclick="exportToCSV('quotes')" class="bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-gray-700 text-sm whitespace-nowrap">Export CSV</button><button onclick="openModal('quote')" class="bg-black text-white px-3 sm:px-4 py-2 rounded-lg border border-teal-400 text-sm whitespace-nowrap">+ Create Quote</button></div></div><div class="grid gap-4">${quotes.length === 0 ? '<div class="text-center py-12 text-gray-500">No quotes</div>' : quotes.map(q => { 
        const client = clients.find(c => c.id === q.client_id);
        const isAccepted = q.accepted || q.status === 'accepted';
        const isConverted = q.status === 'converted';
        const isNewQuote = lastCreatedQuote && lastCreatedQuote.id === q.id;
        return `<div class="bg-white p-4 rounded-lg shadow ${isAccepted ? 'border-l-4 border-green-500' : ''} ${isConverted ? 'border-l-4 border-gray-400' : ''} ${isNewQuote ? 'ring-2 ring-green-400' : ''}"><div class="flex flex-col sm:flex-row sm:justify-between gap-2 mb-3"><div><h3 class="text-lg font-semibold">${q.title}</h3><p class="text-sm">${client?.name || 'Unknown'}</p>${isAccepted ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mt-1 inline-block">‚úì ACCEPTED</span>' : ''}${isConverted ? '<span class="text-xs bg-gray-100 text-gray-800 px-2 py-1 rounded mt-1 inline-block ml-2">‚úì CONVERTED</span>' : ''}</div><p class="text-2xl font-bold text-teal-500">$${q.total?.toFixed(2)}</p></div>${q.notes ? `<p class="text-sm text-gray-600 italic mb-3">${q.notes}</p>` : ''}${isConverted ? '<p class="text-xs text-gray-500 italic mb-3">This quote has been converted to an invoice</p>' : ''}<div class="flex gap-2 flex-wrap">${isAccepted ? `<button onclick='openJobFromQuote(${JSON.stringify(q).replace(/"/g, "&quot;")})' class="px-3 py-1 bg-teal-600 text-white rounded text-sm whitespace-nowrap">üìÖ Schedule Job</button>` : ''}${!isAccepted && !isConverted ? `<button onclick='openModal("quote", ${JSON.stringify(q).replace(/"/g, "&quot;")})' class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Edit</button>` : ''}${!isConverted ? `<button onclick='convertToInvoice(${JSON.stringify(q).replace(/"/g, '&quot;')})' class="px-3 py-1 bg-green-600 text-white rounded text-sm whitespace-nowrap">Convert to Invoice</button>` : ''}<button onclick='generatePDF("quote", ${JSON.stringify(q).replace(/"/g, '&quot;')})' class="px-3 py-1 bg-blue-600 text-white rounded text-sm whitespace-nowrap">Download PDF</button><button onclick='sendQuoteEmail(${JSON.stringify(q).replace(/"/g, '&quot;')})' class="px-3 py-1 bg-purple-600 text-white rounded text-sm whitespace-nowrap">üìß Email</button>${client?.phone && smsSettings?.enabled ? `<button onclick='sendQuoteSMS(${JSON.stringify(q).replace(/"/g, '&quot;')})' class="px-3 py-1 bg-green-600 text-white rounded text-sm whitespace-nowrap">üì± SMS</button>` : ''}<button onclick="deleteQuote('${q.id}')" class="px-3 py-1 text-red-600 border rounded text-sm">Delete</button></div></div>`; 
    }).join('')}</div></div>`;
}
        
        function renderInvoices() {
            const today = new Date();
            today.setHours(0,0,0,0);
            
            let content = '';
            
            if (invoiceFilter === 'monthly') {
                // Group paid invoices by month
                const paidInvoices = invoices.filter(i => i.status === 'paid');
                const monthlyGroups = {};
                
                paidInvoices.forEach(inv => {
                    const date = new Date(inv.issue_date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    const monthLabel = date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
                    
                    if (!monthlyGroups[monthKey]) {
                        monthlyGroups[monthKey] = {
                            label: monthLabel,
                            invoices: [],
                            total: 0
                        };
                    }
                    monthlyGroups[monthKey].invoices.push(inv);
                    monthlyGroups[monthKey].total += parseFloat(inv.total || 0);
                });
                
                // Sort by month (newest first)
                const sortedMonths = Object.keys(monthlyGroups).sort().reverse();
                
                content = sortedMonths.length === 0 
                    ? '<div class="text-center py-12 text-gray-500">No paid invoices yet</div>'
                    : sortedMonths.map(monthKey => {
                        const group = monthlyGroups[monthKey];
                        return `
                            <div class="mb-6">
                                <div class="bg-teal-50 p-4 rounded-lg border-l-4 border-teal-400 mb-3">
                                    <div class="flex justify-between items-center">
                                        <h3 class="text-xl font-bold text-teal-900">${group.label}</h3>
                                        <div class="text-right">
                                            <div class="text-sm text-gray-600">${group.invoices.length} invoice${group.invoices.length === 1 ? '' : 's'}</div>
                                            <div class="text-2xl font-bold text-teal-600">$${group.total.toFixed(2)}</div>
                                        </div>
                                    </div>
                                </div>
                                <div class="grid gap-3 ml-4">
                                    ${group.invoices.map(inv => {
                                        const client = clients.find(c => c.id === inv.client_id);
                                        return `<div class="bg-white p-3 rounded-lg shadow border-l-4 border-green-500">
                                            <div class="flex justify-between">
                                                <div>
                                                    <h4 class="font-semibold">${inv.title}</h4>
                                                    <p class="text-sm text-gray-600">${client?.name || 'Unknown'}</p>
                                                    <p class="text-xs text-gray-500">${inv.invoice_number} ‚Ä¢ ${inv.issue_date}</p>
                                                </div>
                                                <div class="text-right">
                                                    <p class="text-xl font-bold text-green-600">$${inv.total?.toFixed(2)}</p>
                                                    <button onclick="generatePDF('invoice', ${JSON.stringify(inv).replace(/"/g, '&quot;')})" class="text-xs text-blue-600 hover:underline mt-1">Download PDF</button>
                                                </div>
                                            </div>
                                        </div>`;
                                    }).join('')}
                                </div>
                            </div>
                        `;
                    }).join('');
            } else {
                const filteredInvoices = invoiceFilter === 'unpaid' 
                    ? invoices.filter(i => i.status === 'unpaid')
                    : invoices.filter(i => i.status === 'paid');
                
                content = filteredInvoices.length === 0 
                    ? `<div class="text-center py-12 text-gray-500">No ${invoiceFilter} invoices</div>` 
                    : filteredInvoices.map(inv => { 
                        const client = clients.find(c => c.id === inv.client_id);
                        let borderColor = '';
                        let statusBadge = '';
                        
                        if (inv.status === 'paid') {
                            borderColor = 'border-l-4 border-green-500';
                            statusBadge = '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mt-1 inline-block">‚úì PAID</span>';
                        } else if (inv.due_date) {
                            const dueDate = new Date(inv.due_date);
                            dueDate.setHours(0,0,0,0);
                            const diffTime = dueDate - today;
                            const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
                            
                            if (diffDays < 0) {
                                borderColor = 'border-l-4 border-red-500';
                                statusBadge = `<span class="text-xs bg-red-100 text-red-800 px-2 py-1 rounded mt-1 inline-block">‚ö† OVERDUE (${Math.abs(diffDays)} days)</span>`;
                            } else if (diffDays <= 7) {
                                borderColor = 'border-l-4 border-yellow-500';
                                statusBadge = `<span class="text-xs bg-yellow-100 text-yellow-800 px-2 py-1 rounded mt-1 inline-block">‚è∞ DUE IN ${diffDays} DAYS</span>`;
                            }
                        }
                        
                        const paymentLinkButton = (inv.status === 'unpaid' && stripeSettings?.publishable_key) 
                            ? `<button onclick="copyPaymentLink('${inv.id}')" class="px-3 py-1 bg-purple-600 text-white rounded text-sm">üí≥ Get Payment Link</button>` 
                            : '';
                        
                        return `<div class="bg-white p-4 rounded-lg shadow ${borderColor}"><div class="flex justify-between mb-3"><div><h3 class="text-lg font-semibold">${inv.title}</h3><p class="text-sm">${client?.name || 'Unknown'}</p><p class="text-xs">${inv.invoice_number}</p><p class="text-xs text-gray-500">Issued: ${inv.issue_date}</p>${inv.due_date ? `<p class="text-xs text-gray-500">Due: ${inv.due_date}</p>` : ''}${statusBadge}</div><p class="text-2xl font-bold text-teal-500">$${inv.total?.toFixed(2)}</p></div><div class="flex gap-2 flex-wrap">${inv.status === 'unpaid' ? `<button onclick="updateInvoice('${inv.id}', 'paid')" class="px-3 py-1 bg-green-600 text-white rounded text-sm">Mark Paid</button>` : ''}${paymentLinkButton}<button onclick="generatePDF('invoice', ${JSON.stringify(inv).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Download PDF</button><button onclick="sendInvoiceEmail(${JSON.stringify(inv).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-teal-600 text-white rounded text-sm">üìß Email</button>${client?.phone && smsSettings?.enabled ? `<button onclick="sendInvoiceSMS(${JSON.stringify(inv).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-green-600 text-white rounded text-sm">üì± SMS</button>` : ''}<button onclick="deleteInvoice('${inv.id}')" class="px-3 py-1 text-red-600 border rounded text-sm">Delete</button></div></div>`; 
                    }).join('');
            }
            
            const unpaidTotal = invoices.filter(i => i.status === 'unpaid').reduce((s, i) => s + parseFloat(i.total || 0), 0);
            const paidTotal = invoices.filter(i => i.status === 'paid').reduce((s, i) => s + parseFloat(i.total || 0), 0);
            
            const filterTabs = `<div class="flex flex-wrap gap-2 mb-4"><button onclick="invoiceFilter='unpaid'; renderApp();" class="px-3 sm:px-4 py-2 rounded text-sm ${invoiceFilter === 'unpaid' ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300'} border">Unpaid (${invoices.filter(i => i.status === 'unpaid').length})</button><button onclick="invoiceFilter='paid'; renderApp();" class="px-3 sm:px-4 py-2 rounded text-sm ${invoiceFilter === 'paid' ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300'} border">Paid (${invoices.filter(i => i.status === 'paid').length})</button><button onclick="invoiceFilter='monthly'; renderApp();" class="px-3 sm:px-4 py-2 rounded text-sm ${invoiceFilter === 'monthly' ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300'} border">Monthly</button></div>`;
            
            return `<div><div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 mb-6"><h2 class="text-2xl font-bold">Invoices</h2><div class="flex flex-wrap items-center gap-3"><button onclick="exportToCSV('invoices')" class="bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-gray-700 text-sm whitespace-nowrap">Export CSV</button><div class="text-sm flex gap-4"><div>Outstanding: <span class="font-bold text-red-600">$${unpaidTotal.toFixed(2)}</span></div><div>Paid: <span class="font-bold text-green-600">$${paidTotal.toFixed(2)}</span></div></div></div></div>${filterTabs}<div class="grid gap-4">${content}</div></div>`;
        }
        
        function renderExpenses() {
            const categories = ['Materials', 'Fuel', 'Equipment', 'Subcontractors', 'Office Supplies', 'Insurance', 'Marketing', 'Other'];
            
            // Get unique months from expenses
            const monthsSet = new Set();
            expenses.forEach(exp => {
                const date = new Date(exp.date);
                const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                monthsSet.add(monthKey);
            });
            const months = Array.from(monthsSet).sort().reverse(); // Newest first
            
            // Filter expenses by selected month
            const filteredExpenses = expenseFilter === 'all' 
                ? expenses 
                : expenses.filter(exp => {
                    const date = new Date(exp.date);
                    const monthKey = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
                    return monthKey === expenseFilter;
                });
            
            const totalExpenses = filteredExpenses.reduce((sum, e) => sum + parseFloat(e.amount || 0), 0);
            
            // Get month label for display
            const getMonthLabel = (monthKey) => {
                if (monthKey === 'all') return 'All Time';
                const [year, month] = monthKey.split('-');
                const date = new Date(year, parseInt(month) - 1);
                return date.toLocaleDateString('en-US', { month: 'long', year: 'numeric' });
            };
            
            return `<div>
                <div class="flex flex-col sm:flex-row sm:justify-between sm:items-start gap-3 mb-6">
                    <div>
                        <h2 class="text-2xl font-bold">Expenses</h2>
                        <div class="text-3xl font-bold text-red-600 mt-2">$${totalExpenses.toFixed(2)}</div>
                        <div class="text-sm text-gray-500">${filteredExpenses.length} expense${filteredExpenses.length !== 1 ? 's' : ''} - ${getMonthLabel(expenseFilter)}</div>
                    </div>
                    <div class="flex flex-wrap gap-2 items-center">
                        ${months.length > 0 ? `
                            <select onchange="expenseFilter=this.value; renderApp();" class="px-3 py-2 border rounded bg-white text-sm">
                                <option value="all" ${expenseFilter === 'all' ? 'selected' : ''}>All Months</option>
                                ${months.map(m => `<option value="${m}" ${expenseFilter === m ? 'selected' : ''}>${getMonthLabel(m)}</option>`).join('')}
                            </select>
                        ` : ''}
                        <button onclick="exportToCSV('expenses')" class="bg-gray-600 text-white px-3 sm:px-4 py-2 rounded-lg hover:bg-gray-700 text-sm whitespace-nowrap">Export CSV</button>
                        <button onclick="openModal('expense')" class="bg-black text-white px-3 sm:px-4 py-2 rounded-lg border border-teal-400 text-sm whitespace-nowrap">+ Add Expense</button>
                    </div>
                </div>
                
                <!-- Expenses Table -->
                <div class="bg-white rounded-lg shadow overflow-hidden">
                    ${filteredExpenses.length === 0 ? 
                        `<div class="text-center py-12 text-gray-500">${expenseFilter === 'all' ? 'No expenses yet. Click "+ Add Expense" to get started!' : 'No expenses for this month.'}</div>` 
                        : 
                        `<div class="overflow-x-auto">
                            <table class="w-full">
                                <thead class="bg-black text-white">
                                    <tr>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Date</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Category</th>
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Job</th>
                                        ${getAccountType() === 'business' ? '<th class="px-4 py-3 text-left text-sm font-semibold">Team Member</th>' : ''}
                                        <th class="px-4 py-3 text-left text-sm font-semibold">Description</th>
                                        <th class="px-4 py-3 text-right text-sm font-semibold">Amount</th>
                                        <th class="px-4 py-3 text-center text-sm font-semibold">Actions</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200">
                                    ${filteredExpenses.sort((a, b) => new Date(b.date) - new Date(a.date)).map(exp => {
                                        const teamMember = exp.team_member_id ? teamMembers.find(tm => tm.id === exp.team_member_id) : null;
                                        const job = exp.job_id ? jobs.find(j => j.id === exp.job_id) : null;
                                        return `
                                        <tr class="hover:bg-gray-50">
                                            <td class="px-4 py-3 text-sm text-gray-900">${new Date(exp.date).toLocaleDateString()}</td>
                                            <td class="px-4 py-3">
                                                <span class="inline-block px-2 py-1 text-xs font-medium rounded bg-gray-100 text-gray-800">${exp.category}</span>
                                            </td>
                                            <td class="px-4 py-3 text-sm text-gray-600">${job ? job.title : '-'}</td>
                                            ${getAccountType() === 'business' ? `<td class="px-4 py-3 text-sm text-gray-600">${teamMember ? teamMember.name : '-'}</td>` : ''}
                                            <td class="px-4 py-3 text-sm text-gray-600">
                                                ${exp.description || '-'}
                                                ${exp.receipt_url ? `<a href="${exp.receipt_url}" target="_blank" class="text-teal-600 hover:underline ml-2">üìé</a>` : ''}
                                            </td>
                                            <td class="px-4 py-3 text-sm font-semibold text-right text-red-600">$${parseFloat(exp.amount).toFixed(2)}</td>
                                            <td class="px-4 py-3 text-center">
                                                <div class="flex justify-center gap-2">
                                                    <button onclick='openModal("expense", ${JSON.stringify(exp).replace(/"/g, "&quot;")})' class="text-blue-600 hover:text-blue-800 text-sm font-medium">Edit</button>
                                                    <button onclick="deleteExpense('${exp.id}')" class="text-red-600 hover:text-red-800 text-sm font-medium">Delete</button>
                                                </div>
                                            </td>
                                        </tr>
                                    `}).join('')}
                                    <tr class="bg-gray-50 font-bold border-t-2 border-gray-300">
                                        <td colspan="${getAccountType() === 'business' ? '5' : '4'}" class="px-4 py-4 text-right text-sm uppercase">Total ${expenseFilter !== 'all' ? `(${getMonthLabel(expenseFilter)})` : ''}:</td>
                                        <td class="px-4 py-4 text-right text-lg text-red-600">$${totalExpenses.toFixed(2)}</td>
                                        <td></td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>`
                    }
                </div>
            </div>`;
        }
        
        async function addExpense(expense) {
            const { data } = await supabaseClient.from('expenses').insert([{
                ...expense,
                user_id: currentUser.id
            }]).select();
            if (data) {
                expenses.push(data[0]);
                closeModal();
                renderApp();
            }
        }
        
        
        // Receipt upload handling
        let currentReceiptFile = null;
        
        function handleReceiptUpload(input) {
            const file = input.files[0];
            if (!file) return;
            
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please select an image file');
                input.value = '';
                return;
            }
            
            // Validate file size (max 5MB)
            if (file.size > 5 * 1024 * 1024) {
                alert('Image must be less than 5MB');
                input.value = '';
                return;
            }
            
            currentReceiptFile = file;
            
            // Show preview
            const preview = document.getElementById('receipt_preview');
            preview.innerHTML = `<div class="bg-gray-50 p-2 rounded text-sm text-gray-600">üì∏ ${file.name} ready to upload</div>`;
        }
        
        function removeReceipt() {
            currentReceiptFile = null;
            document.getElementById('receipt_photo').value = '';
            document.getElementById('receipt_url').value = '';
            document.getElementById('receipt_preview').innerHTML = '';
        }
        
        async function uploadReceiptToStorage(file) {
            const fileExt = file.name.split('.').pop();
            const fileName = `${currentUser.id}/${Date.now()}.${fileExt}`;
            
            const { data, error } = await supabaseClient.storage
                .from('receipts')
                .upload(fileName, file);
            
            if (error) {
                console.error('Upload error:', error);
                throw error;
            }
            
            // Get public URL
            const { data: urlData } = supabaseClient.storage
                .from('receipts')
                .getPublicUrl(fileName);
            
            return urlData.publicUrl;
        }
        
        async function addExpenseWithReceipt() {
            const expenseData = {
                date: document.getElementById('expense_date').value,
                amount: parseFloat(document.getElementById('expense_amount').value),
                category: document.getElementById('expense_category').value,
                description: document.getElementById('expense_description').value,
                team_member_id: document.getElementById('team_member_id')?.value || null,
                job_id: document.getElementById('job_id')?.value || null,
                user_id: currentUser.id
            };
            
            // Upload receipt if one was selected
            if (currentReceiptFile) {
                try {
                    expenseData.receipt_url = await uploadReceiptToStorage(currentReceiptFile);
                } catch (error) {
                    alert('Failed to upload receipt. Expense will be saved without receipt.');
                }
            }
            
            const { data } = await supabaseClient.from('expenses').insert([expenseData]).select();
            if (data) {
                expenses.push(data[0]);
                currentReceiptFile = null;
                closeModal();
                renderApp();
            }
        }
        
        async function updateExpenseWithReceipt(id) {
            const expenseData = {
                date: document.getElementById('expense_date').value,
                amount: parseFloat(document.getElementById('expense_amount').value),
                category: document.getElementById('expense_category').value,
                description: document.getElementById('expense_description').value,
                team_member_id: document.getElementById('team_member_id')?.value || null,
                job_id: document.getElementById('job_id')?.value || null
            };
            
            // Upload new receipt if one was selected
            if (currentReceiptFile) {
                try {
                    expenseData.receipt_url = await uploadReceiptToStorage(currentReceiptFile);
                } catch (error) {
                    alert('Failed to upload receipt. Expense will be updated without new receipt.');
                }
            } else {
                // Keep existing receipt URL if no new file
                const existingUrl = document.getElementById('receipt_url').value;
                if (existingUrl) {
                    expenseData.receipt_url = existingUrl;
                }
            }
            
            const { data } = await supabaseClient.from('expenses').update(expenseData).eq('id', id).select();
            if (data) {
                const index = expenses.findIndex(e => e.id === id);
                if (index !== -1) expenses[index] = data[0];
                currentReceiptFile = null;
                closeModal();
                renderApp();
            }
        }
        
        async function updateExpense(id) {
            const updatedExpense = {
                date: document.getElementById('expense_date').value,
                amount: parseFloat(document.getElementById('expense_amount').value),
                category: document.getElementById('expense_category').value,
                description: document.getElementById('expense_description').value,
                team_member_id: document.getElementById('team_member_id')?.value || null,
                job_id: document.getElementById('job_id')?.value || null
            };
            const { data } = await supabaseClient.from('expenses').update(updatedExpense).eq('id', id).select();
            if (data) {
                const index = expenses.findIndex(e => e.id === id);
                if (index !== -1) expenses[index] = data[0];
                closeModal();
                renderApp();
            }
        }
        
        async function deleteExpense(id) {
            if (confirm('Delete this expense?')) {
                await supabaseClient.from('expenses').delete().eq('id', id);
                expenses = expenses.filter(e => e.id !== id);
                renderApp();
            }
        }
        
        function renderModal() {
            let form = '';
            if (modalType === 'expense') {
                const date = editingItem?.date || new Date().toISOString().split('T')[0];
                const amount = editingItem?.amount || '';
                const category = editingItem?.category || 'Materials';
                const description = editingItem?.description || '';
                const team_member_id = editingItem?.team_member_id || '';
                const job_id = editingItem?.job_id || '';
                const categories = ['Materials', 'Fuel', 'Equipment', 'Subcontractors', 'Office Supplies', 'Insurance', 'Marketing', 'Other'];
                const buttonText = editingItem ? 'Update Expense' : 'Add Expense';
                const receipt_url = editingItem?.receipt_url || '';
                
                // Job dropdown - show recent/active jobs
                const activeJobs = jobs.filter(j => j.status !== 'completed').sort((a, b) => new Date(b.date) - new Date(a.date));
                const jobDropdown = `<div><label class="block text-sm font-medium mb-1">Related Job (Optional)</label><select id="job_id" class="w-full px-4 py-2 border rounded mb-3"><option value="">No specific job</option>${activeJobs.map(j => {
                    const client = clients.find(c => c.id === j.client_id);
                    return `<option value="${j.id}" ${j.id === job_id ? 'selected' : ''}>${j.title}${client ? ' - ' + client.name : ''}</option>`;
                }).join('')}</select></div>`;
                
                // Team member dropdown for business accounts
                const teamMemberDropdown = getAccountType() === 'business' 
                    ? `<div><label class="block text-sm font-medium mb-1">Team Member (Optional)</label><select id="team_member_id" class="w-full px-4 py-2 border rounded mb-3"><option value="">No specific team member</option>${teamMembers.map(tm => `<option value="${tm.id}" ${tm.id === team_member_id ? 'selected' : ''}>${tm.name}${tm.occupation ? ' (' + tm.occupation + ')' : ''}</option>`).join('')}</select></div>` 
                    : '';
                
                // Receipt upload section
                const receiptSection = `<div class="mb-3"><label class="block text-sm font-medium mb-1">üì∏ Receipt Photo (Optional)</label><input type="file" id="receipt_photo" accept="image/*" capture="environment" class="w-full px-4 py-2 border rounded" onchange="handleReceiptUpload(this)"><div id="receipt_preview" class="mt-2">${receipt_url ? `<div class="bg-gray-50 p-2 rounded flex items-center justify-between"><a href="${receipt_url}" target="_blank" class="text-teal-600 hover:underline text-sm">üìé View Receipt</a><button type="button" onclick="removeReceipt()" class="text-red-600 text-sm">Remove</button></div>` : ''}</div><input type="hidden" id="receipt_url" value="${receipt_url}"></div>`;
                
                const action = editingItem 
                    ? `updateExpenseWithReceipt('${editingItem.id}')` 
                    : `addExpenseWithReceipt()`;
                form = `<input type="date" id="expense_date" value="${date}" class="w-full px-4 py-2 border rounded mb-3" required><input type="number" id="expense_amount" placeholder="Amount" value="${amount}" step="0.01" class="w-full px-4 py-2 border rounded mb-3" required><select id="expense_category" class="w-full px-4 py-2 border rounded mb-3">${categories.map(cat => `<option value="${cat}" ${cat === category ? 'selected' : ''}>${cat}</option>`).join('')}</select>${jobDropdown}${teamMemberDropdown}<textarea id="expense_description" placeholder="Description (e.g., Plumbing supplies for Smith job)" class="w-full px-4 py-2 border rounded mb-3" rows="3">${description}</textarea>${receiptSection}<button onclick="${action}" class="w-full bg-black text-white px-4 py-2 rounded border border-teal-400">${buttonText}</button>`;
            }
            if (modalType === 'team_member') {
                const name = editingItem?.name || '';
                const email = editingItem?.email || '';
                const phone = editingItem?.phone || '';
                const occupation = editingItem?.occupation || '';
                const color = editingItem?.color || '#3b82f6';
                const buttonText = editingItem ? 'Update Team Member' : 'Add Team Member';
                const action = editingItem ? `updateTeamMember('${editingItem.id}')` : `addTeamMember({name:document.getElementById('name').value,email:document.getElementById('email').value,phone:document.getElementById('phone').value,occupation:document.getElementById('occupation').value,color:document.getElementById('color').value})`;
                form = `<input type="text" id="name" placeholder="Name" value="${name}" class="w-full px-4 py-2 border rounded mb-3" required><input type="email" id="email" placeholder="Email (optional)" value="${email}" class="w-full px-4 py-2 border rounded mb-3"><input type="tel" id="phone" placeholder="Phone (optional)" value="${phone}" class="w-full px-4 py-2 border rounded mb-3"><input type="text" id="occupation" placeholder="Occupation (e.g., Painter, Electrician)" value="${occupation}" class="w-full px-4 py-2 border rounded mb-3"><div class="mb-3"><label class="block text-sm font-medium mb-2">Calendar Color</label><div class="flex items-center gap-3"><input type="color" id="color" value="${color}" class="h-10 w-20 cursor-pointer border rounded"><span class="text-sm text-gray-600">Choose a color for this team member's jobs</span></div></div><button onclick="${action}" class="w-full bg-black text-white px-4 py-2 rounded border border-teal-400">${buttonText}</button>`;
            }
            if (modalType === 'client') {
                const name = editingItem?.name || '';
                const email = editingItem?.email || '';
                const phone = editingItem?.phone || '';
                const address = editingItem?.address || '';
                const notes = editingItem?.notes || '';
                const buttonText = editingItem ? 'Update Client' : 'Add Client';
                const action = editingItem ? `updateClient('${editingItem.id}')` : `addClient({name:document.getElementById('name').value,email:document.getElementById('email').value,phone:document.getElementById('phone').value,address:document.getElementById('address').value,notes:document.getElementById('clientNotes').value})`;
                form = `<input type="text" id="name" placeholder="Name" value="${name}" class="w-full px-4 py-2 border rounded mb-3"><input type="email" id="email" placeholder="Email" value="${email}" class="w-full px-4 py-2 border rounded mb-3"><input type="tel" id="phone" placeholder="Phone" value="${phone}" class="w-full px-4 py-2 border rounded mb-3"><input type="text" id="address" placeholder="Address" value="${address}" class="w-full px-4 py-2 border rounded mb-3"><textarea id="clientNotes" placeholder="Internal notes (only visible to you)" class="w-full px-4 py-2 border rounded mb-3" rows="3">${notes}</textarea><button onclick="${action}" class="w-full bg-black text-white px-4 py-2 rounded border border-teal-400">${buttonText}</button>`;
            }
            if (modalType === 'job') {
                const clientId = editingItem?.client_id || '';
                const title = editingItem?.title || '';
                const date = editingItem?.date || '';
                const time = editingItem?.time || '06:00';
                const duration = editingItem?.duration || 1;
                const notes = editingItem?.notes || '';
                const status = editingItem?.status || 'scheduled';
                const assignedTo = editingItem?.assigned_to || '';
                const buttonText = (editingItem && editingItem.id) ? 'Update Job' : 'Schedule Job';
                
                // Worker dropdown for business accounts
                const workerDropdown = getAccountType() === 'business' && teamMembers.length > 0 
                    ? `<select id="assigned_to" class="w-full px-4 py-2 border rounded mb-3">
                        <option value="">Unassigned</option>
                        ${teamMembers.map(m => `<option value="${m.id}" ${m.id === assignedTo ? 'selected' : ''}>${m.name}${m.occupation ? ' - ' + m.occupation : ''}</option>`).join('')}
                       </select>`
                    : '';
                
                const action = (editingItem && editingItem.id) 
                    ? `updateJob('${editingItem.id}')` 
                    : `saveJob()`;
                    
                form = `<select id="client_id" class="w-full px-4 py-2 border rounded mb-3"><option value="">Select Client</option>${clients.map(c => `<option value="${c.id}" ${c.id === clientId ? 'selected' : ''}>${c.name}</option>`).join('')}</select><input type="text" id="title" placeholder="Job Title" value="${title}" class="w-full px-4 py-2 border rounded mb-3"><div class="mb-3"><label class="block text-sm font-medium mb-1">Start Date</label><input type="date" id="date" value="${date}" class="w-full px-4 py-2 border rounded" required></div><div class="mb-3"><label class="block text-sm font-medium mb-1">Start Time (defaults to 6am if blank)</label><input type="time" id="time" value="${time}" class="w-full px-4 py-2 border rounded"></div><div class="mb-3"><label class="block text-sm font-medium mb-1">Duration (days)</label><input type="number" id="duration" value="${duration}" min="1" max="30" class="w-full px-4 py-2 border rounded" placeholder="1"></div>${workerDropdown}<select id="jobStatus" class="w-full px-4 py-2 border rounded mb-3"><option value="scheduled" ${status === 'scheduled' ? 'selected' : ''}>Scheduled</option><option value="in_progress" ${status === 'in_progress' ? 'selected' : ''}>In Progress</option><option value="completed" ${status === 'completed' ? 'selected' : ''}>Completed</option></select><textarea id="notes" placeholder="Notes (optional)" class="w-full px-4 py-2 border rounded mb-3" rows="3">${notes}</textarea><button onclick="${action}" class="w-full bg-black text-white px-4 py-2 rounded border border-teal-400">${buttonText}</button>`;
            }
            if (modalType === 'quote') {
                const clientId = editingItem?.client_id || '';
                const title = editingItem?.title || '';
                const notes = editingItem?.notes || '';
                const quoteNumber = editingItem?.quote_number || '';
                const includeGst = editingItem?.include_gst || false;
                const depositPercentage = editingItem?.deposit_percentage || 0;
                const isEditing = editingItem && editingItem.id;
                const buttonText = isEditing ? 'Update Quote' : 'Create Quote';
                if (isEditing) {
                    quoteItems = editingItem.items || [{ description: '', quantity: 1, price: 0 }];
                } else if (!editingItem || !editingItem.client_id) {
                    quoteItems = [{ description: '', quantity: 1, price: 0 }];
                }
                // Pre-generate quote number for new quotes or show existing for editing
                const displayQuoteNumber = isEditing ? quoteNumber : `QT-${String(quotes.length + 1).padStart(3, '0')}`;
                const titleField = `<input type="text" id="title" value="${displayQuoteNumber}" class="w-full px-4 py-2 border rounded mb-3 bg-gray-100" readonly>`;
                form = `<select id="client_id" class="w-full px-4 py-2 border rounded mb-3"><option value="">Select Client</option>${clients.map(c => `<option value="${c.id}" ${c.id === clientId ? 'selected' : ''}>${c.name}</option>`).join('')}</select>${titleField}<div id="items-list"></div><button onclick="addQuoteItem()" class="text-teal-500 text-sm mb-3">+ Add Item</button><div id="quote-total" class="font-bold mb-3">Total: $0</div><div class="mb-3"><label class="flex items-center cursor-pointer"><input type="checkbox" id="include_gst" ${includeGst ? 'checked' : ''} onchange="updateQuoteTotal()" class="mr-2"><span class="text-sm font-medium">Include GST (10%)</span></label></div><div class="mb-3"><label class="block text-sm font-medium mb-2">Deposit Required</label><input type="hidden" id="deposit_percentage" value="${depositPercentage}"><div class="flex gap-2 flex-wrap"><button type="button" onclick="setDeposit(0)" class="px-4 py-2 border rounded text-sm ${depositPercentage === 0 ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300 hover:bg-gray-100'}">0% (COD)</button><button type="button" onclick="setDeposit(30)" class="px-4 py-2 border rounded text-sm ${depositPercentage === 30 ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300 hover:bg-gray-100'}">30%</button><button type="button" onclick="setDeposit(40)" class="px-4 py-2 border rounded text-sm ${depositPercentage === 40 ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300 hover:bg-gray-100'}">40%</button><button type="button" onclick="setDeposit(50)" class="px-4 py-2 border rounded text-sm ${depositPercentage === 50 ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300 hover:bg-gray-100'}">50%</button></div></div><div id="deposit-amount" class="text-sm text-gray-600 mb-3"></div><textarea id="notes" placeholder="Notes (optional)" class="w-full px-4 py-2 border rounded mb-3" rows="3">${notes}</textarea><button onclick="${isEditing ? `updateQuote('${editingItem.id}')` : 'saveQuote()'}" class="w-full bg-black text-white px-4 py-2 rounded border border-teal-400">${buttonText}</button>`;
            }
            return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-3 sm:p-4 z-50 overflow-y-auto" onclick="if(event.target===this)closeModal()"><div class="bg-white rounded-lg p-4 sm:p-6 max-w-2xl w-full my-4 max-h-[90vh] overflow-y-auto"><div class="flex justify-between mb-4"><h3 class="text-lg sm:text-xl font-bold">${editingItem ? 'Edit ' + modalType : modalType}</h3><button onclick="closeModal()" class="text-2xl leading-none">√ó</button></div>${form}</div></div>`;
        }
        
        let quoteItems = [];
        function addQuoteItem() { quoteItems.push({ description: '', quantity: 1, price: 0 }); renderQuoteItems(); }
        function updateQuoteTotal() { renderQuoteItems(); }
        function setDeposit(percentage) {
            document.getElementById('deposit_percentage').value = percentage;
            
            // Update button styles
            const buttons = document.querySelectorAll('[onclick^="setDeposit"]');
            buttons.forEach(btn => {
                const btnPercentage = parseInt(btn.textContent);
                if (btnPercentage === percentage || (percentage === 0 && btn.textContent.includes('COD'))) {
                    btn.className = 'px-4 py-2 border rounded text-sm bg-black text-white border-teal-400';
                } else {
                    btn.className = 'px-4 py-2 border rounded text-sm bg-white text-black border-gray-300 hover:bg-gray-100';
                }
            });
            
            renderQuoteItems();
        }
        function renderQuoteItems() {
            const c = document.getElementById('items-list');
            if (!c) return;
            c.innerHTML = quoteItems.map((item, i) => `<div class="grid grid-cols-12 gap-2 mb-2"><input type="text" value="${item.description}" onchange="quoteItems[${i}].description=this.value;renderQuoteItems()" placeholder="Description" class="col-span-6 px-3 py-2 border rounded"><input type="number" value="${item.quantity}" onchange="quoteItems[${i}].quantity=parseFloat(this.value);renderQuoteItems()" class="col-span-2 px-3 py-2 border rounded"><input type="number" value="${item.price}" onchange="quoteItems[${i}].price=parseFloat(this.value);renderQuoteItems()" class="col-span-3 px-3 py-2 border rounded"><button onclick="quoteItems.splice(${i},1);renderQuoteItems()" class="text-red-600">√ó</button></div>`).join('');
            
            const subtotal = quoteItems.reduce((s, i) => s + (i.quantity * i.price), 0);
            const includeGst = document.getElementById('include_gst')?.checked || false;
            const gst = includeGst ? subtotal * 0.1 : 0;
            const total = subtotal + gst;
            
            const depositPercentage = parseFloat(document.getElementById('deposit_percentage')?.value || 0);
            const depositAmount = (total * depositPercentage) / 100;
            
            const t = document.getElementById('quote-total');
            if (t) {
                if (includeGst) {
                    t.innerHTML = `<div class="text-right"><div class="text-sm">Subtotal: $${subtotal.toFixed(2)}</div><div class="text-sm">GST (10%): $${gst.toFixed(2)}</div><div class="font-bold text-lg border-t pt-1 mt-1">Total: $${total.toFixed(2)}</div></div>`;
                } else {
                    t.innerHTML = `Total: $${total.toFixed(2)}`;
                }
            }
            
            const d = document.getElementById('deposit-amount');
            if (d) {
                if (depositPercentage > 0) {
                    d.innerHTML = `<strong>Deposit Required:</strong> $${depositAmount.toFixed(2)} (${depositPercentage}% of total)`;
                } else {
                    d.innerHTML = '<strong>Payment Terms:</strong> Full payment (COD) to be paid on completion';
                }
            }
        }
        function saveQuote() {
            const subtotal = quoteItems.reduce((s, i) => s + (i.quantity * i.price), 0);
            const includeGst = document.getElementById('include_gst').checked;
            const gst = includeGst ? subtotal * 0.1 : 0;
            const total = subtotal + gst;
            const notes = document.getElementById('notes').value;
            const quoteNumber = document.getElementById('title').value;
            const depositPercentage = parseFloat(document.getElementById('deposit_percentage').value || 0);
            const depositAmount = (total * depositPercentage) / 100;
            addQuote({client_id:document.getElementById('client_id').value,title:quoteNumber,items:quoteItems,subtotal:subtotal,gst:gst,total:total,include_gst:includeGst,notes:notes,date:new Date().toISOString().split('T')[0],status:'pending',deposit_percentage:depositPercentage,deposit_amount:depositAmount});
        }
        
        async function updateQuote(id) {
            const subtotal = quoteItems.reduce((s, i) => s + (i.quantity * i.price), 0);
            const includeGst = document.getElementById('include_gst').checked;
            const gst = includeGst ? subtotal * 0.1 : 0;
            const total = subtotal + gst;
            const depositPercentage = parseFloat(document.getElementById('deposit_percentage').value || 0);
            const depositAmount = (total * depositPercentage) / 100;
            
            // Get the existing quote to preserve share_token
            const existingQuote = quotes.find(q => q.id === id);
            
            const updatedQuote = {
                client_id: document.getElementById('client_id').value,
                title: document.getElementById('title').value,
                items: quoteItems,
                subtotal: subtotal,
                gst: gst,
                total: total,
                include_gst: includeGst,
                notes: document.getElementById('notes').value,
                deposit_percentage: depositPercentage,
                deposit_amount: depositAmount,
                share_token: existingQuote?.share_token  // Preserve the share_token!
            };
            const { data } = await supabaseClient.from('quotes').update(updatedQuote).eq('id', id).select();
            if (data) {
                const index = quotes.findIndex(q => q.id === id);
                if (index !== -1) quotes[index] = data[0];
                quoteItems = []; // Reset quote items
                closeModal();
                renderApp();
            }
        }
async function uploadJobPhoto(input, jobId) {
    const file = input.files[0];
    if (!file) return;
    
    const fileExt = file.name.split('.').pop();
    const fileName = `${jobId}-${Date.now()}.${fileExt}`;
    const filePath = `${fileName}`;
    
    const { data: uploadData, error: uploadError } = await supabaseClient.storage
        .from('job-photos')
        .upload(filePath, file);
    
    if (uploadError) {
        alert('Error uploading photo: ' + uploadError.message);
        return;
    }
    
    const { data: urlData } = supabaseClient.storage
        .from('job-photos')
        .getPublicUrl(filePath);
    
    const job = jobs.find(j => j.id === jobId);
    const photos = job.photos || [];
    photos.push(urlData.publicUrl);
    
    const { error: updateError } = await supabaseClient
        .from('jobs')
        .update({ photos })
        .eq('id', jobId);
    
    if (!updateError) {
        await loadAllData();
        renderApp();
    }
}        

async function sendQuoteEmail(quote) {
    const client = clients.find(c => c.id === quote.client_id);
    if (!client || !client.email) {
        alert('Client email not found!');
        return;
    }
    
    if (!emailSettings || !emailSettings.sendgrid_api_key) {
        alert('‚ö†Ô∏è Email not configured! Please add your SendGrid settings in Company Info.');
        return;
    }
    
    // More robust URL construction
    const currentUrl = window.location.href.split('?')[0].split('#')[0];
    const baseUrl = currentUrl.replace(/\/[^\/]*$/, '/');
    const shareLink = baseUrl + 'quote-viewer.html?quote=' + quote.share_token;
    
    console.log('Generated share link:', shareLink);
    console.log('Sending to:', client.email);
    
    const fromName = emailSettings.from_name;
    
    const htmlContent = `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <p>Hello ${client.name},</p>
            <p>${fromName} has sent you a quote for: <strong>${quote.title}</strong></p>
            <p>Total Amount: <strong>$${quote.total.toFixed(2)}</strong></p>
            <p>Please click the link below to view and download your quote.</p>
            <p style="margin: 30px 0;">
                <a href="${shareLink}" style="background-color: #14b8a6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">View Your Quote</a>
            </p>
            <p>Or copy and paste this link into your browser:</p>
            <p style="color: #14b8a6; word-break: break-all;">${shareLink}</p>
            <p>Best regards,<br>${fromName}</p>
        </div>
    `;
    
    try {
        console.log('Calling Edge Function...');
        
        const response = await fetch('https://xviustrrsuhidzbcpgow.supabase.co/functions/v1/send-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2aXVzdHJyc3VoaWR6YmNwZ293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1NDgsImV4cCI6MjA4NDM2NTU0OH0.CEcc50c1K2Qnh6rXt_1-_w30LzHvDniGLbqWhdOolRY'
            },
            body: JSON.stringify({
                user_id: currentUser.id,
                to_email: client.email,
                to_name: client.name,
                subject: `Quote from ${fromName}: ${quote.title}`,
                html_content: htmlContent
            })
        });
        
        const result = await response.json();
        console.log('Edge Function response:', result);
        
        if (response.ok && result.success) {
            alert('‚úÖ Email sent successfully to ' + client.email + '!\n\nQuote link: ' + shareLink);
        } else {
            console.error('Email send error:', result);
            alert('‚ö†Ô∏è Email may not have sent: ' + (result.error || 'Unknown error') + '\n\nManually send this link:\n' + shareLink);
        }
    } catch (error) {
        console.error('Email error:', error);
        alert('‚ùå Failed to send email: ' + error.message + '\n\nManually send this link:\n' + shareLink);
    }
}

async function sendQuoteSMS(quote) {
    const client = clients.find(c => c.id === quote.client_id);
    if (!client || !client.phone) {
        alert('Client phone number not found!');
        return;
    }
    
    if (!smsSettings || !smsSettings.enabled) {
        alert('‚ö†Ô∏è SMS is not enabled! Please enable SMS in Company Info settings.');
        return;
    }
    
    // Check SMS limit
    if (smsSettings.sms_count_current_month >= smsSettings.sms_limit) {
        alert('‚ö†Ô∏è SMS limit reached for this month (' + smsSettings.sms_limit + ' SMS). Please wait until next month or upgrade your plan.');
        return;
    }
    
    // Construct share link
    const currentUrl = window.location.href.split('?')[0].split('#')[0];
    const baseUrl = currentUrl.replace(/\/[^\/]*$/, '/');
    const shareLink = baseUrl + 'quote-viewer.html?quote=' + quote.share_token;
    
    const fromName = companySettings?.business_name || 'M4 Projects & Designs';
    const message = `${fromName}: Your quote for "${quote.title}" is ready! Total: $${quote.total.toFixed(2)}. View: ${shareLink}`;
    
    try {
        const response = await fetch('https://xviustrrsuhidzbcpgow.supabase.co/functions/v1/send-sms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2aXVzdHJyc3VoaWR6YmNwZ293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1NDgsImV4cCI6MjA4NDM2NTU0OH0.CEcc50c1K2Qnh6rXt_1-_w30LzHvDniGLbqWhdOolRY'
            },
            body: JSON.stringify({
                user_id: currentUser.id,
                to_number: client.phone,
                message: message,
                type: 'quote'
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('‚úÖ SMS sent successfully to ' + client.phone + '!');
            await loadAllData(); // Refresh SMS counter
            renderApp();
        } else {
            alert('‚ö†Ô∏è SMS failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('SMS error:', error);
        alert('‚ùå Failed to send SMS: ' + error.message);
    }
}

async function sendInvoiceSMS(invoice) {
    const client = clients.find(c => c.id === invoice.client_id);
    if (!client || !client.phone) {
        alert('Client phone number not found!');
        return;
    }
    
    if (!smsSettings || !smsSettings.enabled) {
        alert('‚ö†Ô∏è SMS is not enabled! Please enable SMS in Company Info settings.');
        return;
    }
    
    // Check SMS limit
    if (smsSettings.sms_count_current_month >= smsSettings.sms_limit) {
        alert('‚ö†Ô∏è SMS limit reached for this month (' + smsSettings.sms_limit + ' SMS). Please wait until next month or upgrade your plan.');
        return;
    }
    
    const baseUrl = window.location.href.split('?')[0].replace('index.html', '');
    const paymentLink = baseUrl + 'payment.html?invoice=' + invoice.id;
    const fromName = companySettings?.business_name || 'M4 Projects & Designs';
    const message = `${fromName}: Invoice #${invoice.invoice_number} is ready. Amount: $${invoice.total.toFixed(2)}${invoice.due_date ? ', Due: ' + invoice.due_date : ''}. View: ${paymentLink}`;
    
    try {
        const response = await fetch('https://xviustrrsuhidzbcpgow.supabase.co/functions/v1/send-sms', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2aXVzdHJyc3VoaWR6YmNwZ293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1NDgsImV4cCI6MjA4NDM2NTU0OH0.CEcc50c1K2Qnh6rXt_1-_w30LzHvDniGLbqWhdOolRY'
            },
            body: JSON.stringify({
                user_id: currentUser.id,
                to_number: client.phone,
                message: message,
                type: 'invoice'
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('‚úÖ SMS sent successfully to ' + client.phone + '!');
            await loadAllData(); // Refresh SMS counter
            renderApp();
        } else {
            alert('‚ö†Ô∏è SMS failed: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('SMS error:', error);
        alert('‚ùå Failed to send SMS: ' + error.message);
    }
}

async function sendInvoiceEmail(invoice) {
    const client = clients.find(c => c.id === invoice.client_id);
    if (!client || !client.email) {
        alert('Client email not found!');
        return;
    }
    
    if (!emailSettings || !emailSettings.sendgrid_api_key) {
        alert('‚ö†Ô∏è Email not configured! Please add your SendGrid settings in Company Info.');
        return;
    }
    
    const baseUrl = window.location.href.split('?')[0].replace('index.html', '');
    const fromName = emailSettings.from_name;
    
    // Include payment link if Stripe is configured and invoice is unpaid
    let paymentButton = '';
    if (invoice.status === 'unpaid' && stripeSettings?.publishable_key) {
        const paymentLink = baseUrl + 'payment.html?invoice=' + invoice.id;
        paymentButton = `<p style="margin: 30px 0;">
            <a href="${paymentLink}" style="background-color: #14b8a6; color: white; padding: 12px 24px; text-decoration: none; border-radius: 5px; display: inline-block; font-weight: bold;">View Invoice</a>
        </p>
        <p>Or copy and paste this link: <span style="color: #14b8a6;">${paymentLink}</span></p>`;
    }
    
    const htmlContent = `
        <div style="font-family: Arial, sans-serif; max-width: 600px; margin: 0 auto;">
            <p>Hello ${client.name},</p>
            <p>Your invoice is ready.</p>
            <div style="background: #f9fafb; padding: 20px; border-radius: 8px; margin: 20px 0;">
                <p style="margin: 5px 0;"><strong>Invoice #:</strong> ${invoice.invoice_number}</p>
                <p style="margin: 5px 0;"><strong>Amount Due:</strong> $${invoice.total.toFixed(2)}</p>
                <p style="margin: 5px 0;"><strong>Due Date:</strong> ${invoice.due_date || 'Upon receipt'}</p>
            </div>
            ${paymentButton}
            <p>Thank you for your business!</p>
            <p>Best regards,<br>${fromName}</p>
        </div>
    `;
    
    try {
        const response = await fetch('https://xviustrrsuhidzbcpgow.supabase.co/functions/v1/send-email', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'Authorization': 'Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2aXVzdHJyc3VoaWR6YmNwZ293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1NDgsImV4cCI6MjA4NDM2NTU0OH0.CEcc50c1K2Qnh6rXt_1-_w30LzHvDniGLbqWhdOolRY'
            },
            body: JSON.stringify({
                user_id: currentUser.id,
                to_email: client.email,
                to_name: client.name,
                subject: `Invoice ${invoice.invoice_number} from ${fromName}`,
                html_content: htmlContent
            })
        });
        
        const result = await response.json();
        
        if (response.ok && result.success) {
            alert('‚úÖ Invoice email sent successfully to ' + client.email + '!');
        } else {
            console.error('Email send error:', result);
            alert('‚ö†Ô∏è Failed to send invoice email: ' + (result.error || 'Unknown error'));
        }
    } catch (error) {
        console.error('Email error:', error);
        alert('‚ùå Failed to send email: ' + error.message);
    }
}


window.addEventListener('load', checkAuth);
    </script>
</body>
</html>
