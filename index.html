<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>M4 Streamline</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.10/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
<script>
  emailjs.init('cl17j5coPTDN-aVM8');
</script>
</head>
<body>
    <div id="app"></div>
    <script>
        const supabaseClient = window.supabase.createClient('https://xviustrrsuhidzbcpgow.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2aXVzdHJyc3VoaWR6YmNwZ293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1NDgsImV4cCI6MjA4NDM2NTU0OH0.CEcc50c1K2Qnh6rXt_1-_w30LzHvDniGLbqWhdOolRY');
        let currentUser = null;
        let activeTab = 'dashboard';
        let clients = [];
        let jobs = [];
        let quotes = [];
        let invoices = [];
        let showModal = false;
        let modalType = '';
        let editingItem = null;
	let scheduleView = 'list';
        let clientSearch = '';
        let invoiceFilter = 'unpaid';
        
        async function checkAuth() {
    const urlParams = new URLSearchParams(window.location.search);
    const quoteToken = urlParams.get('quote');
    
    if (quoteToken) {
        // Redirect to the separate quote viewer page
        window.location.href = 'quote-viewer.html?quote=' + quoteToken;
        return;
    }
    
    const { data: { session } } = await supabaseClient.auth.getSession();
    if (session) {
        currentUser = session.user;
        await loadAllData();
        renderApp();
    } else {
        renderAuth();
    }
}
    
        
        function renderAuth() {
            document.getElementById('app').innerHTML = `<div class="min-h-screen flex items-center justify-center bg-black"><div class="bg-white p-8 rounded-lg shadow-xl max-w-md w-full"><div class="text-center mb-8"><div class="text-teal-400 text-5xl font-bold mb-2">M4</div><h1 class="text-2xl font-bold text-black">Streamline</h1><p class="text-gray-600 mt-2">Business Management</p></div><div><input type="email" id="email" placeholder="Email" class="w-full px-4 py-3 border rounded-lg mb-3"><input type="password" id="password" placeholder="Password" class="w-full px-4 py-3 border rounded-lg mb-4"><button onclick="handleLogin()" class="w-full bg-black text-white px-4 py-3 rounded-lg hover:bg-gray-800 border-2 border-teal-400 mb-3">Sign In</button><button onclick="handleSignup()" class="w-full bg-white text-black px-4 py-3 rounded-lg hover:bg-gray-50 border-2 border-black">Create Account</button><div id="auth-error" class="mt-3 text-red-600 text-sm text-center"></div></div></div></div>`;
        }
        
        async function handleLogin() {
            const { data, error } = await supabaseClient.auth.signInWithPassword({ 
                email: document.getElementById('email').value, 
                password: document.getElementById('password').value 
            });
            if (error) document.getElementById('auth-error').textContent = error.message;
            else { currentUser = data.user; await loadAllData(); renderApp(); }
        }
        
        async function handleSignup() {
            const { data, error } = await supabaseClient.auth.signUp({ 
                email: document.getElementById('email').value, 
                password: document.getElementById('password').value 
            });
            const errorDiv = document.getElementById('auth-error');
            if (error) errorDiv.textContent = error.message;
            else { 
                errorDiv.textContent = 'Account created! You can now sign in.'; 
                errorDiv.className = 'mt-3 text-green-600 text-sm text-center'; 
            }
        }
        
        async function handleLogout() { 
            await supabaseClient.auth.signOut(); 
            currentUser = null; 
            renderAuth(); 
        }
        
        async function loadAllData() {
            const [c, j, q, i] = await Promise.all([
                supabaseClient.from('clients').select('*'), 
                supabaseClient.from('jobs').select('*'), 
                supabaseClient.from('quotes').select('*'), 
                supabaseClient.from('invoices').select('*')
            ]);
            clients = c.data || []; 
            jobs = j.data || []; 
            quotes = q.data || []; 
            invoices = i.data || [];
        }
        
        async function addClient(client) { 
            const { data } = await supabaseClient.from('clients').insert([{
                ...client, 
                user_id: currentUser.id
            }]).select(); 
            if (data) { 
                clients.push(data[0]); 
                closeModal(); 
                renderApp(); 
            } 
        }
        
        async function updateClient(id) {
            const updatedClient = {
                name: document.getElementById('name').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                address: document.getElementById('address').value
            };
            const { data } = await supabaseClient.from('clients').update(updatedClient).eq('id', id).select();
            if (data) {
                const index = clients.findIndex(c => c.id === id);
                if (index !== -1) clients[index] = data[0];
                closeModal();
                renderApp();
            }
        }
        
        async function deleteClient(id) {
            const client = clients.find(c => c.id === id);
            if (!confirm(`Are you sure you want to delete ${client?.name || 'this client'}? This action cannot be undone.`)) {
                return;
            }
            await supabaseClient.from('clients').delete().eq('id', id); 
            clients = clients.filter(c => c.id !== id); 
            renderApp(); 
        }
        
        async function addJob(job) { 
    const jobData = { ...job, user_id: currentUser.id, photos: [] };
    const { data } = await supabaseClient.from('jobs').insert([jobData]).select(); 
    if (data) { 
        jobs.push(data[0]); 
        closeModal(); 
        renderApp(); 
    } 
}
        
        async function updateJob(id) {
            const updatedJob = {
                client_id: document.getElementById('client_id').value,
                title: document.getElementById('title').value,
                date: document.getElementById('date').value,
                time: document.getElementById('time').value,
                notes: document.getElementById('notes').value
            };
            const { data } = await supabaseClient.from('jobs').update(updatedJob).eq('id', id).select();
            if (data) {
                const index = jobs.findIndex(j => j.id === id);
                if (index !== -1) jobs[index] = data[0];
                closeModal();
                renderApp();
            }
        }
        
        async function deleteJob(id) {
            const job = jobs.find(j => j.id === id);
            if (!confirm(`Are you sure you want to delete the job "${job?.title || 'this job'}"? This action cannot be undone.`)) {
                return;
            }
            await supabaseClient.from('jobs').delete().eq('id', id); 
            jobs = jobs.filter(j => j.id !== id); 
            renderApp(); 
        }
        
        async function addQuote(quote) {
    const shareToken = 'q_' + Math.random().toString(36).substring(2, 15);
    const quoteData = { ...quote, user_id: currentUser.id, share_token: shareToken, accepted: false };
    const { data } = await supabaseClient.from('quotes').insert([quoteData]).select();
    if (data) {
        quotes.push(data[0]);
        closeModal();
        renderApp();
    }
}

async function acceptQuote(quoteId, shareToken) {
    try {
        // Update quote status to accepted
        const { error } = await supabaseClient
            .from('quotes')
            .update({ accepted: true, status: 'accepted' })
            .eq('share_token', shareToken);
        
        if (error) throw error;
        
        // Get quote and client details for notification email
        const { data: quote } = await supabaseClient
            .from('quotes')
            .select('*, user_id')
            .eq('share_token', shareToken)
            .single();
        
        if (quote) {
            const { data: client } = await supabaseClient
                .from('clients')
                .select('*')
                .eq('id', quote.client_id)
                .single();
            
            // Get the tradesperson's email from auth.users
            const { data: { user } } = await supabaseClient.auth.admin.getUserById(quote.user_id);
            
            // Send notification email to tradesperson
            const templateParams = {
                to_email: user?.email || 'your-email@example.com', // Fallback if user email not found
                client_name: client?.name || 'Client',
                quote_title: quote.title,
                quote_total: quote.total.toFixed(2),
                message: `${client?.name || 'A client'} has ACCEPTED your quote for "${quote.title}"! Total: $${quote.total.toFixed(2)}`,
                from_name: 'M4 Streamline'
            };
            
            await emailjs.send('service_og2tkc8', 'template_xvsfuhv', templateParams);
        }
        
        return true;
    } catch (error) {
        console.error('Error accepting quote:', error);
        return false;
    }
}
        
        async function deleteQuote(id) {
            const quote = quotes.find(q => q.id === id);
            if (!confirm(`Are you sure you want to delete the quote "${quote?.title || 'this quote'}"? This action cannot be undone.`)) {
                return;
            }
            await supabaseClient.from('quotes').delete().eq('id', id); 
            quotes = quotes.filter(q => q.id !== id); 
            renderApp(); 
        }
        
        async function convertToInvoice(quote) {
            const inv = {
                client_id: quote.client_id,
                title: quote.title,
                items: quote.items,
                notes: quote.notes || '',
                total: quote.total,
                invoice_number: 'INV-' + Date.now(),
                status: 'unpaid',
                issue_date: new Date().toISOString().split('T')[0],
                user_id: currentUser.id
            };
            const { data, error } = await supabaseClient.from('invoices').insert([inv]).select();
            if (error) {
                console.error('Invoice error:', error);
                alert('Error: ' + error.message);
            } else if (data) {
                await supabaseClient.from('quotes').update({ status: 'converted' }).eq('id', quote.id);
                await loadAllData();
                activeTab = 'invoices';
                renderApp();
            }
        }
        
        async function updateInvoice(id, status) { 
            await supabaseClient.from('invoices').update({ status }).eq('id', id); 
            await loadAllData(); 
            renderApp(); 
        }
        
        async function deleteInvoice(id) {
            const invoice = invoices.find(i => i.id === id);
            if (!confirm(`Are you sure you want to delete invoice "${invoice?.invoice_number || 'this invoice'}"? This action cannot be undone.`)) {
                return;
            }
            await supabaseClient.from('invoices').delete().eq('id', id); 
            invoices = invoices.filter(i => i.id !== id); 
            renderApp(); 
        }
        
        function openModal(type, item = null) { 
            modalType = type; 
            editingItem = item; 
            showModal = true; 
            if (type === 'quote') quoteItems = item?.items || [{ description: '', quantity: 1, price: 0 }]; 
            renderApp(); 
            if (type === 'quote') setTimeout(renderQuoteItems, 100); 
        }
        
        function closeModal() { 
            showModal = false; 
            editingItem = null; 
            modalType = ''; 
            renderApp(); 
        }
        
        function generatePDF(type, item) {
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            
            // Add M4 logo from image
const logoImg = new Image();
logoImg.src = 'https://i.imgur.com/dF4xRDK.jpeg';
doc.addImage(logoImg, 'JPEG', 10, 10, 25, 25);
            
            doc.setFontSize(24);
            doc.setTextColor(0, 0, 0);
            doc.text('M4 Streamline', 35, 22);
            doc.setFontSize(10);
            doc.setTextColor(100, 100, 100);
            doc.text('Business Management', 35, 28);
            
            doc.setFontSize(18);
            doc.setTextColor(20, 184, 166);
            const title = type === 'quote' ? 'QUOTE' : 'INVOICE';
            doc.text(title, 20, 50);
            
            const client = clients.find(c => c.id === item.client_id);
            doc.setFontSize(11);
            doc.setTextColor(0, 0, 0);
            doc.text('Client:', 20, 65);
            doc.text(client?.name || 'Unknown', 45, 65);
            doc.text(client?.email || '', 45, 71);
            doc.text(client?.phone || '', 45, 77);
            
            if (type === 'invoice') {
                doc.text('Invoice #:', 140, 65);
                doc.text(item.invoice_number || '', 170, 65);
                doc.text('Date:', 140, 71);
                doc.text(item.issue_date || '', 170, 71);
            } else {
                doc.text('Date:', 140, 65);
                doc.text(item.date || '', 170, 65);
            }
            
            let y = 95;
            doc.setFontSize(12);
            doc.setTextColor(255, 255, 255);
            doc.setFillColor(0, 0, 0);
            doc.rect(20, y - 7, 170, 10, 'F');
            doc.text('Description', 25, y);
            doc.text('Qty', 120, y);
            doc.text('Price', 145, y);
            doc.text('Total', 170, y);
            
            y += 10;
            doc.setTextColor(0, 0, 0);
            doc.setFontSize(10);
            
            if (item.items && Array.isArray(item.items)) {
                item.items.forEach(lineItem => {
                    doc.text(lineItem.description || '', 25, y);
                    doc.text(String(lineItem.quantity || 0), 120, y);
                    doc.text('$' + (lineItem.price || 0).toFixed(2), 145, y);
                    doc.text('$' + ((lineItem.quantity * lineItem.price) || 0).toFixed(2), 170, y);
                    y += 7;
                });
            }
            
            y += 10;
            doc.setLineWidth(0.5);
            doc.setDrawColor(20, 184, 166);
            doc.line(20, y, 190, y);
            y += 8;
            doc.setFontSize(14);
            doc.setFont(undefined, 'bold');
            doc.text('TOTAL:', 145, y);
            doc.setTextColor(20, 184, 166);
            doc.text('$' + (item.total || 0).toFixed(2), 170, y);
            
            if (item.notes) {
                y += 15;
                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.setFont(undefined, 'normal');
                doc.text('Notes:', 20, y);
                const splitNotes = doc.splitTextToSize(item.notes, 170);
                doc.text(splitNotes, 20, y + 5);
            }
            
            const filename = type === 'quote' ? `Quote-${item.title}.pdf` : `Invoice-${item.invoice_number}.pdf`;
            doc.save(filename);
        }
        
        function renderApp() {
            document.getElementById('app').innerHTML = `<div class="min-h-screen bg-gray-50"><div class="bg-black text-white p-6 shadow-lg border-b-4 border-teal-400"><div class="max-w-7xl mx-auto flex justify-between items-center"><div><h1 class="text-3xl font-bold text-teal-400">M4 Streamline</h1><p class="text-teal-400 mt-1">Business Management</p></div><div class="flex items-center gap-4"><img src="final_logo.png" alt="M4 Projects Logo" class="h-20 w-20 object-contain"><button onclick="handleLogout()" class="px-4 py-2 bg-gray-800 hover:bg-gray-700 rounded-lg text-sm border border-teal-400">Logout</button></div></div></div><div class="bg-white shadow"><div class="max-w-7xl mx-auto px-4"><div class="flex space-x-1">${['dashboard', 'schedule', 'clients', 'quotes', 'invoices'].map(tab => `<button onclick="switchTab('${tab}')" class="px-6 py-4 font-medium border-b-2 ${activeTab === tab ? 'border-teal-400 text-black' : 'border-transparent text-gray-600'}">${tab.charAt(0).toUpperCase() + tab.slice(1)}</button>`).join('')}</div></div></div><div class="max-w-7xl mx-auto p-6">${renderContent()}</div>${showModal ? renderModal() : ''}</div>`;
        }
        
        async function switchTab(tab) {
            activeTab = tab;
            await loadAllData();
            renderApp();
        }
        
        function renderContent() {
            if (activeTab === 'dashboard') return renderDashboard();
            if (activeTab === 'schedule') return renderSchedule();
            if (activeTab === 'clients') return renderClients();
            if (activeTab === 'quotes') return renderQuotes();
            if (activeTab === 'invoices') return renderInvoices();
        }
        
        function renderDashboard() {
            const today = new Date().toISOString().split('T')[0];
            const upcomingJobs = jobs.filter(j => j.date >= today).sort((a, b) => new Date(a.date) - new Date(b.date)).slice(0, 5);
            const pendingQuotes = quotes.filter(q => q.status === 'pending' && !q.accepted);
            const acceptedQuotes = quotes.filter(q => q.accepted || q.status === 'accepted');
            const unpaidInvoices = invoices.filter(i => i.status === 'unpaid');
            const totalUnpaid = unpaidInvoices.reduce((sum, inv) => sum + parseFloat(inv.total || 0), 0);
            const totalRevenue = invoices.filter(i => i.status === 'paid').reduce((sum, inv) => sum + parseFloat(inv.total || 0), 0);
            
            return `<div>
                <h2 class="text-2xl font-bold mb-6">Dashboard</h2>
                
                <!-- Stats Cards -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4 mb-6">
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-teal-400">
                        <div class="text-gray-600 text-sm">Total Clients</div>
                        <div class="text-3xl font-bold mt-2">${clients.length}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-blue-400">
                        <div class="text-gray-600 text-sm">Upcoming Jobs</div>
                        <div class="text-3xl font-bold mt-2">${upcomingJobs.length}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-yellow-400">
                        <div class="text-gray-600 text-sm">Pending Quotes</div>
                        <div class="text-3xl font-bold mt-2">${pendingQuotes.length}</div>
                    </div>
                    <div class="bg-white p-6 rounded-lg shadow border-l-4 border-red-400">
                        <div class="text-gray-600 text-sm">Unpaid Invoices</div>
                        <div class="text-3xl font-bold mt-2">$${totalUnpaid.toFixed(2)}</div>
                    </div>
                </div>
                
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Upcoming Jobs -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <div class="flex justify-between items-center mb-4">
                            <h3 class="text-lg font-bold">Upcoming Jobs</h3>
                            <button onclick="activeTab='schedule'; renderApp();" class="text-teal-500 text-sm hover:underline">View All</button>
                        </div>
                        ${upcomingJobs.length === 0 ? '<p class="text-gray-500 text-center py-4">No upcoming jobs</p>' : upcomingJobs.map(job => {
                            const client = clients.find(c => c.id === job.client_id);
                            return `<div class="border-l-4 border-teal-400 pl-3 py-2 mb-3">
                                <div class="font-semibold">${job.title}</div>
                                <div class="text-sm text-gray-600">${client?.name || 'Unknown'}</div>
                                <div class="text-sm text-gray-500">${new Date(job.date).toLocaleDateString()} at ${job.time}</div>
                            </div>`;
                        }).join('')}
                    </div>
                    
                    <!-- Recent Activity -->
                    <div class="bg-white p-6 rounded-lg shadow">
                        <h3 class="text-lg font-bold mb-4">Recent Activity</h3>
                        ${acceptedQuotes.length === 0 && unpaidInvoices.length === 0 ? '<p class="text-gray-500 text-center py-4">No recent activity</p>' : `
                            ${acceptedQuotes.slice(0, 3).map(q => {
                                const client = clients.find(c => c.id === q.client_id);
                                return `<div class="py-2 mb-2 border-b cursor-pointer hover:bg-gray-50" onclick="switchTab('quotes')">
                                    <div class="flex justify-between">
                                        <span class="text-sm">‚úì Quote accepted: <strong>${q.title}</strong></span>
                                    </div>
                                    <div class="text-xs text-gray-500">${client?.name || 'Unknown'} - $${q.total.toFixed(2)}</div>
                                </div>`;
                            }).join('')}
                            ${unpaidInvoices.slice(0, 3).map(inv => {
                                const client = clients.find(c => c.id === inv.client_id);
                                return `<div class="py-2 mb-2 border-b cursor-pointer hover:bg-gray-50" onclick="switchTab('invoices')">
                                    <div class="flex justify-between">
                                        <span class="text-sm">‚è≥ Unpaid: <strong>${inv.title}</strong></span>
                                    </div>
                                    <div class="text-xs text-gray-500">${client?.name || 'Unknown'} - $${inv.total.toFixed(2)}</div>
                                </div>`;
                            }).join('')}
                        `}
                    </div>
                </div>
                
                <!-- Quick Actions -->
                <div class="mt-6 bg-white p-6 rounded-lg shadow">
                    <h3 class="text-lg font-bold mb-4">Quick Actions</h3>
                    <div class="flex flex-wrap gap-3">
                        <button onclick="openModal('client')" class="px-4 py-2 bg-black text-white rounded-lg border border-teal-400 hover:bg-gray-800">+ Add Client</button>
                        <button onclick="openModal('job')" class="px-4 py-2 bg-black text-white rounded-lg border border-teal-400 hover:bg-gray-800">+ Schedule Job</button>
                        <button onclick="openModal('quote')" class="px-4 py-2 bg-black text-white rounded-lg border border-teal-400 hover:bg-gray-800">+ Create Quote</button>
                    </div>
                </div>
            </div>`;
        }
        
        function renderSchedule() {
    const viewToggle = `<div class="flex gap-2"><button onclick="scheduleView='list'; renderApp();" class="px-3 py-2 rounded ${scheduleView === 'list' ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300'} border">List</button><button onclick="scheduleView='calendar'; renderApp();" class="px-3 py-2 rounded ${scheduleView === 'calendar' ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300'} border">Calendar</button></div>`;
    
    if (scheduleView === 'calendar') {
        setTimeout(() => renderCalendar(), 100);
        return `<div><div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">Schedule</h2><div class="flex gap-4">${viewToggle}<button onclick="openModal('job')" class="bg-black text-white px-4 py-2 rounded-lg border border-teal-400">+ Schedule Job</button></div></div><div id="calendar" class="bg-white p-4 rounded-lg shadow"></div></div>`;
    }
    
    return `<div><div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">Schedule</h2><div class="flex gap-4">${viewToggle}<button onclick="openModal('job')" class="bg-black text-white px-4 py-2 rounded-lg border border-teal-400">+ Schedule Job</button></div></div><div class="grid gap-4">${jobs.length === 0 ? '<div class="text-center py-12 text-gray-500">No jobs</div>' : jobs.map(job => { 
        const client = clients.find(c => c.id === job.client_id); 
        return `<div class="bg-white p-4 rounded-lg shadow border-l-4 border-teal-400"><div class="flex justify-between"><div class="flex-1"><h3 class="text-lg font-semibold">${job.title}</h3><p class="text-gray-600">${client?.name || 'Unknown'}</p>${client?.address ? `<p class="text-sm text-gray-500">üìç ${client.address}</p>` : ''}<div class="text-sm text-gray-500 mt-2">${new Date(job.date).toLocaleDateString()} ${job.time}</div>${job.notes ? `<p class="text-sm text-gray-700 mt-2 italic">${job.notes}</p>` : ''}${job.photos && job.photos.length > 0 ? `<div class="mt-3 flex gap-2 flex-wrap">${job.photos.map(photo => `<img src="${photo}" class="w-20 h-20 object-cover rounded border border-teal-400" />`).join('')}</div>` : ''}</div><div class="flex flex-col gap-2"><button onclick='openModal("job", ${JSON.stringify(job).replace(/"/g, "&quot;")})' class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Edit</button><label class="cursor-pointer px-3 py-1 bg-teal-500 text-white rounded text-sm text-center"><input type="file" accept="image/*" onchange="uploadJobPhoto(this, '${job.id}')" class="hidden" />Add Photo</label><button onclick="deleteJob('${job.id}')" class="px-3 py-1 text-red-600 border border-red-200 rounded text-sm">Delete</button></div></div></div>`; 
    }).join('')}</div></div>`;
}

function renderCalendar() {
    const calendarEl = document.getElementById('calendar');
    if (!calendarEl) return;
    
    const calendar = new FullCalendar.Calendar(calendarEl, {
        initialView: 'dayGridMonth',
        headerToolbar: {
            left: 'prev,next today',
            center: 'title',
            right: 'dayGridMonth,timeGridWeek'
        },
        events: jobs.map(job => {
            const client = clients.find(c => c.id === job.client_id);
            return {
                title: job.title + (client ? ' - ' + client.name : ''),
                start: job.date + 'T' + job.time,
                backgroundColor: '#14b8a6',
                borderColor: '#14b8a6',
                extendedProps: {
                    jobId: job.id,
                    client: client?.name
                }
            };
        }),
        eventClick: function(info) {
            const job = jobs.find(j => j.id === info.event.extendedProps.jobId);
            if (job) {
                alert('Job: ' + job.title + '\nClient: ' + info.event.extendedProps.client + '\nDate: ' + new Date(job.date).toLocaleDateString() + '\nTime: ' + job.time);
            }
        }
    });
    
    calendar.render();
}
        
        function renderClients() {
            const filteredClients = clients.filter(c => 
                c.name.toLowerCase().includes(clientSearch.toLowerCase()) ||
                c.email.toLowerCase().includes(clientSearch.toLowerCase()) ||
                c.phone.includes(clientSearch) ||
                (c.address && c.address.toLowerCase().includes(clientSearch.toLowerCase()))
            );
            
            return `<div><div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">Clients</h2><button onclick="openModal('client')" class="bg-black text-white px-4 py-2 rounded-lg border border-teal-400">+ Add Client</button></div><div class="mb-4"><input type="text" id="clientSearchInput" placeholder="Search clients by name, email, phone, or address..." value="${clientSearch}" oninput="clientSearch=this.value; renderClientsOnly();" class="w-full px-4 py-2 border rounded-lg" /></div><div id="clientsList" class="grid gap-4">${filteredClients.length === 0 ? '<div class="text-center py-12 text-gray-500">No clients found</div>' : filteredClients.map(c => `<div class="bg-white p-4 rounded-lg shadow"><div class="flex justify-between"><div class="flex-1"><h3 class="text-lg font-semibold">${c.name}</h3><p class="text-sm text-gray-600">${c.email}</p><p class="text-sm text-gray-600">${c.phone}</p>${c.address ? `<p class="text-sm text-gray-600 mt-1">üìç ${c.address}</p>` : ''}</div><div class="flex gap-2"><button onclick='openModal("client", ${JSON.stringify(c).replace(/"/g, "&quot;")})' class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Edit</button><button onclick="deleteClient('${c.id}')" class="px-3 py-1 text-red-600 border border-red-200 rounded text-sm">Delete</button></div></div></div>`).join('')}</div></div>`;
        }
        
        function renderClientsOnly() {
            const filteredClients = clients.filter(c => 
                c.name.toLowerCase().includes(clientSearch.toLowerCase()) ||
                c.email.toLowerCase().includes(clientSearch.toLowerCase()) ||
                c.phone.includes(clientSearch) ||
                (c.address && c.address.toLowerCase().includes(clientSearch.toLowerCase()))
            );
            
            const listHtml = filteredClients.length === 0 ? '<div class="text-center py-12 text-gray-500">No clients found</div>' : filteredClients.map(c => `<div class="bg-white p-4 rounded-lg shadow"><div class="flex justify-between"><div class="flex-1"><h3 class="text-lg font-semibold">${c.name}</h3><p class="text-sm text-gray-600">${c.email}</p><p class="text-sm text-gray-600">${c.phone}</p>${c.address ? `<p class="text-sm text-gray-600 mt-1">üìç ${c.address}</p>` : ''}</div><div class="flex gap-2"><button onclick='openModal("client", ${JSON.stringify(c).replace(/"/g, "&quot;")})' class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Edit</button><button onclick="deleteClient('${c.id}')" class="px-3 py-1 text-red-600 border border-red-200 rounded text-sm">Delete</button></div></div></div>`).join('');
            
            const listElement = document.getElementById('clientsList');
            if (listElement) listElement.innerHTML = listHtml;
        }
        
        function renderQuotes() {
    return `<div><div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">Quotes</h2><button onclick="openModal('quote')" class="bg-black text-white px-4 py-2 rounded-lg border border-teal-400">+ Create Quote</button></div><div class="grid gap-4">${quotes.length === 0 ? '<div class="text-center py-12 text-gray-500">No quotes</div>' : quotes.map(q => { 
        const client = clients.find(c => c.id === q.client_id);
        const isAccepted = q.accepted || q.status === 'accepted';
        return `<div class="bg-white p-4 rounded-lg shadow ${isAccepted ? 'border-l-4 border-green-500' : ''}"><div class="flex justify-between mb-3"><div><h3 class="text-lg font-semibold">${q.title}</h3><p class="text-sm">${client?.name || 'Unknown'}</p>${isAccepted ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mt-1 inline-block">‚úì ACCEPTED</span>' : ''}</div><p class="text-2xl font-bold text-teal-500">$${q.total?.toFixed(2)}</p></div>${q.notes ? `<p class="text-sm text-gray-600 italic mb-3">${q.notes}</p>` : ''}<div class="flex gap-2">${!isAccepted ? `<button onclick='openModal("quote", ${JSON.stringify(q).replace(/"/g, "&quot;")})' class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Edit</button>` : ''}${!isAccepted && q.status === 'pending' ? `<button onclick='convertToInvoice(${JSON.stringify(q).replace(/"/g, '&quot;')})' class="px-3 py-1 bg-green-600 text-white rounded text-sm">Convert to Invoice</button>` : ''}${isAccepted ? `<button onclick='convertToInvoice(${JSON.stringify(q).replace(/"/g, '&quot;')})' class="px-3 py-1 bg-green-600 text-white rounded text-sm">Convert to Invoice</button>` : ''}<button onclick='generatePDF("quote", ${JSON.stringify(q).replace(/"/g, '&quot;')})' class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Download PDF</button><button onclick='sendQuoteEmail(${JSON.stringify(q).replace(/"/g, '&quot;')})' class="px-3 py-1 bg-purple-600 text-white rounded text-sm">Send Email</button><button onclick="deleteQuote('${q.id}')" class="px-3 py-1 text-red-600 border rounded text-sm">Delete</button></div></div>`; 
    }).join('')}</div></div>`;
}
        
        function renderInvoices() {
            const filteredInvoices = invoiceFilter === 'unpaid' 
                ? invoices.filter(i => i.status === 'unpaid')
                : invoices.filter(i => i.status === 'paid');
            
            const unpaidTotal = invoices.filter(i => i.status === 'unpaid').reduce((s, i) => s + parseFloat(i.total || 0), 0);
            const paidTotal = invoices.filter(i => i.status === 'paid').reduce((s, i) => s + parseFloat(i.total || 0), 0);
            
            const filterTabs = `<div class="flex gap-2 mb-4"><button onclick="invoiceFilter='unpaid'; renderApp();" class="px-4 py-2 rounded ${invoiceFilter === 'unpaid' ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300'} border">Unpaid (${invoices.filter(i => i.status === 'unpaid').length})</button><button onclick="invoiceFilter='paid'; renderApp();" class="px-4 py-2 rounded ${invoiceFilter === 'paid' ? 'bg-black text-white border-teal-400' : 'bg-white text-black border-gray-300'} border">Paid (${invoices.filter(i => i.status === 'paid').length})</button></div>`;
            
            return `<div><div class="flex justify-between mb-6"><h2 class="text-2xl font-bold">Invoices</h2><div class="text-sm"><div>Outstanding: <span class="font-bold text-red-600">$${unpaidTotal.toFixed(2)}</span></div><div>Paid: <span class="font-bold text-green-600">$${paidTotal.toFixed(2)}</span></div></div></div>${filterTabs}<div class="grid gap-4">${filteredInvoices.length === 0 ? `<div class="text-center py-12 text-gray-500">No ${invoiceFilter} invoices</div>` : filteredInvoices.map(inv => { 
                const client = clients.find(c => c.id === inv.client_id); 
                return `<div class="bg-white p-4 rounded-lg shadow ${inv.status === 'paid' ? 'border-l-4 border-green-500' : ''}"><div class="flex justify-between mb-3"><div><h3 class="text-lg font-semibold">${inv.title}</h3><p class="text-sm">${client?.name || 'Unknown'}</p><p class="text-xs">${inv.invoice_number}</p><p class="text-xs text-gray-500">${inv.issue_date}</p>${inv.status === 'paid' ? '<span class="text-xs bg-green-100 text-green-800 px-2 py-1 rounded mt-1 inline-block">‚úì PAID</span>' : ''}</div><p class="text-2xl font-bold text-teal-500">$${inv.total?.toFixed(2)}</p></div><div class="flex gap-2">${inv.status === 'unpaid' ? `<button onclick="updateInvoice('${inv.id}', 'paid')" class="px-3 py-1 bg-green-600 text-white rounded text-sm">Mark Paid</button>` : ''}<button onclick="generatePDF('invoice', ${JSON.stringify(inv).replace(/"/g, '&quot;')})" class="px-3 py-1 bg-blue-600 text-white rounded text-sm">Download PDF</button><button onclick="deleteInvoice('${inv.id}')" class="px-3 py-1 text-red-600 border rounded text-sm">Delete</button></div></div>`; 
            }).join('')}</div></div>`;
        }
        
        function renderModal() {
            let form = '';
            if (modalType === 'client') {
                const name = editingItem?.name || '';
                const email = editingItem?.email || '';
                const phone = editingItem?.phone || '';
                const address = editingItem?.address || '';
                const buttonText = editingItem ? 'Update Client' : 'Add Client';
                const action = editingItem ? `updateClient('${editingItem.id}')` : `addClient({name:document.getElementById('name').value,email:document.getElementById('email').value,phone:document.getElementById('phone').value,address:document.getElementById('address').value})`;
                form = `<input type="text" id="name" placeholder="Name" value="${name}" class="w-full px-4 py-2 border rounded mb-3"><input type="email" id="email" placeholder="Email" value="${email}" class="w-full px-4 py-2 border rounded mb-3"><input type="tel" id="phone" placeholder="Phone" value="${phone}" class="w-full px-4 py-2 border rounded mb-3"><input type="text" id="address" placeholder="Address" value="${address}" class="w-full px-4 py-2 border rounded mb-3"><button onclick="${action}" class="w-full bg-black text-white px-4 py-2 rounded border border-teal-400">${buttonText}</button>`;
            }
            if (modalType === 'job') {
                const clientId = editingItem?.client_id || '';
                const title = editingItem?.title || '';
                const date = editingItem?.date || '';
                const time = editingItem?.time || '';
                const notes = editingItem?.notes || '';
                const buttonText = editingItem ? 'Update Job' : 'Schedule Job';
                const action = editingItem ? `updateJob('${editingItem.id}')` : `addJob({client_id:document.getElementById('client_id').value,title:document.getElementById('title').value,date:document.getElementById('date').value,time:document.getElementById('time').value,notes:document.getElementById('notes').value})`;
                form = `<select id="client_id" class="w-full px-4 py-2 border rounded mb-3"><option value="">Select Client</option>${clients.map(c => `<option value="${c.id}" ${c.id === clientId ? 'selected' : ''}>${c.name}</option>`).join('')}</select><input type="text" id="title" placeholder="Job Title" value="${title}" class="w-full px-4 py-2 border rounded mb-3"><input type="date" id="date" value="${date}" class="w-full px-4 py-2 border rounded mb-3"><input type="time" id="time" value="${time}" class="w-full px-4 py-2 border rounded mb-3"><textarea id="notes" placeholder="Notes (optional)" class="w-full px-4 py-2 border rounded mb-3" rows="3">${notes}</textarea><button onclick="${action}" class="w-full bg-black text-white px-4 py-2 rounded border border-teal-400">${buttonText}</button>`;
            }
            if (modalType === 'quote') {
                const clientId = editingItem?.client_id || '';
                const title = editingItem?.title || '';
                const notes = editingItem?.notes || '';
                const buttonText = editingItem ? 'Update Quote' : 'Create Quote';
                if (editingItem) quoteItems = editingItem.items || [];
                form = `<select id="client_id" class="w-full px-4 py-2 border rounded mb-3"><option value="">Select Client</option>${clients.map(c => `<option value="${c.id}" ${c.id === clientId ? 'selected' : ''}>${c.name}</option>`).join('')}</select><input type="text" id="title" placeholder="Quote Title" value="${title}" class="w-full px-4 py-2 border rounded mb-3"><div id="items-list"></div><button onclick="addQuoteItem()" class="text-teal-500 text-sm mb-3">+ Add Item</button><div id="quote-total" class="font-bold mb-3">Total: $0</div><textarea id="notes" placeholder="Notes (optional)" class="w-full px-4 py-2 border rounded mb-3" rows="3">${notes}</textarea><button onclick="${editingItem ? `updateQuote('${editingItem.id}')` : 'saveQuote()'}" class="w-full bg-black text-white px-4 py-2 rounded border border-teal-400">${buttonText}</button>`;
            }
            return `<div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50" onclick="if(event.target===this)closeModal()"><div class="bg-white rounded-lg p-6 max-w-2xl w-full"><div class="flex justify-between mb-4"><h3 class="text-xl font-bold">${editingItem ? 'Edit ' + modalType : modalType}</h3><button onclick="closeModal()" class="text-2xl">√ó</button></div>${form}</div></div>`;
        }
        
        let quoteItems = [];
        function addQuoteItem() { quoteItems.push({ description: '', quantity: 1, price: 0 }); renderQuoteItems(); }
        function renderQuoteItems() {
            const c = document.getElementById('items-list');
            if (!c) return;
            c.innerHTML = quoteItems.map((item, i) => `<div class="grid grid-cols-12 gap-2 mb-2"><input type="text" value="${item.description}" onchange="quoteItems[${i}].description=this.value;renderQuoteItems()" placeholder="Description" class="col-span-6 px-3 py-2 border rounded"><input type="number" value="${item.quantity}" onchange="quoteItems[${i}].quantity=parseFloat(this.value);renderQuoteItems()" class="col-span-2 px-3 py-2 border rounded"><input type="number" value="${item.price}" onchange="quoteItems[${i}].price=parseFloat(this.value);renderQuoteItems()" class="col-span-3 px-3 py-2 border rounded"><button onclick="quoteItems.splice(${i},1);renderQuoteItems()" class="text-red-600">√ó</button></div>`).join('');
            const total = quoteItems.reduce((s, i) => s + (i.quantity * i.price), 0);
            const t = document.getElementById('quote-total');
            if (t) t.textContent = `Total: $${total.toFixed(2)}`;
        }
        function saveQuote() {
            const total = quoteItems.reduce((s, i) => s + (i.quantity * i.price), 0);
            const notes = document.getElementById('notes').value;
            addQuote({client_id:document.getElementById('client_id').value,title:document.getElementById('title').value,items:quoteItems,total:total,notes:notes,date:new Date().toISOString().split('T')[0],status:'pending'});
        }
        
        async function updateQuote(id) {
            const total = quoteItems.reduce((s, i) => s + (i.quantity * i.price), 0);
            const updatedQuote = {
                client_id: document.getElementById('client_id').value,
                title: document.getElementById('title').value,
                items: quoteItems,
                total: total,
                notes: document.getElementById('notes').value
            };
            const { data } = await supabaseClient.from('quotes').update(updatedQuote).eq('id', id).select();
            if (data) {
                const index = quotes.findIndex(q => q.id === id);
                if (index !== -1) quotes[index] = data[0];
                closeModal();
                renderApp();
            }
        }
async function uploadJobPhoto(input, jobId) {
    const file = input.files[0];
    if (!file) return;
    
    const fileExt = file.name.split('.').pop();
    const fileName = `${jobId}-${Date.now()}.${fileExt}`;
    const filePath = `${fileName}`;
    
    const { data: uploadData, error: uploadError } = await supabaseClient.storage
        .from('job-photos')
        .upload(filePath, file);
    
    if (uploadError) {
        alert('Error uploading photo: ' + uploadError.message);
        return;
    }
    
    const { data: urlData } = supabaseClient.storage
        .from('job-photos')
        .getPublicUrl(filePath);
    
    const job = jobs.find(j => j.id === jobId);
    const photos = job.photos || [];
    photos.push(urlData.publicUrl);
    
    const { error: updateError } = await supabaseClient
        .from('jobs')
        .update({ photos })
        .eq('id', jobId);
    
    if (!updateError) {
        await loadAllData();
        renderApp();
    }
}        

async function sendQuoteEmail(quote) {
    const client = clients.find(c => c.id === quote.client_id);
    if (!client || !client.email) {
        alert('Client email not found!');
        return;
    }
    
    // Update this URL to match your GitHub Pages URL
    const baseUrl = window.location.href.split('?')[0].replace('index.html', '');
    const shareLink = baseUrl + 'quote-viewer.html?quote=' + quote.share_token;
    
    const templateParams = {
        to_email: client.email,
        from_name: currentUser.email.split('@')[0],
        client_name: client.name,
        quote_title: quote.title,
        quote_total: quote.total.toFixed(2),
        quote_link: shareLink,
        message: 'Please click the link below to view and download your quote.',
        reply_to: currentUser.email
    };
    
    try {
        await emailjs.send('service_og2tkc8', 'template_xvsfuhv', templateParams);
        alert('Email sent successfully to ' + client.email + '!');
    } catch (error) {
        alert('Failed to send email: ' + error.text);
    }
}

window.addEventListener('load', checkAuth);
    </script>
</body>
</html>
