<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>View Quote - M4 Streamline</title>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdn.jsdelivr.net/npm/@emailjs/browser@3/dist/email.min.js"></script>
    <style>
        body { font-family: Arial, sans-serif; max-width: 800px; margin: 50px auto; padding: 20px; background: #f9fafb; }
        .header { text-align: center; border-bottom: 3px solid #14b8a6; padding-bottom: 20px; margin-bottom: 30px; background: white; padding: 30px; border-radius: 10px; }
        .logo { color: #14b8a6; font-size: 48px; font-weight: bold; }
        .subtitle { color: #666; }
        .content { background: white; padding: 30px; border-radius: 10px; box-shadow: 0 1px 3px rgba(0,0,0,0.1); }
        .section { margin: 20px 0; }
        .label { font-weight: bold; color: #333; }
        table { width: 100%; border-collapse: collapse; margin: 20px 0; }
        th { background: #000; color: white; padding: 12px; text-align: left; }
        td { padding: 12px; border-bottom: 1px solid #ddd; }
        .total { font-size: 28px; color: #14b8a6; font-weight: bold; text-align: right; margin-top: 20px; padding: 20px; background: #f0fdfa; border-radius: 8px; }
        .print-btn { background: #14b8a6; color: white; padding: 12px 24px; border: none; border-radius: 5px; cursor: pointer; font-size: 16px; margin: 5px; }
        .print-btn:hover { background: #0f9e8e; }
        .accept-btn { background: #10b981; color: white; padding: 15px 40px; border: none; border-radius: 8px; cursor: pointer; font-size: 18px; font-weight: bold; margin: 20px 5px; box-shadow: 0 4px 6px rgba(16, 185, 129, 0.3); }
        .accept-btn:hover { background: #059669; transform: translateY(-2px); box-shadow: 0 6px 8px rgba(16, 185, 129, 0.4); }
        .accept-btn:active { transform: translateY(0); }
        .accepted-badge { background: #10b981; color: white; padding: 15px 30px; border-radius: 8px; font-weight: bold; display: inline-block; margin: 20px 0; font-size: 18px; }
        .button-container { text-align: center; margin-top: 40px; }
        .loading { text-align: center; padding: 50px; color: #666; }
        .error { text-align: center; padding: 50px; color: #ef4444; }
        
        /* Mobile styles */
        @media (max-width: 640px) {
            body { margin: 0; padding: 10px; }
            .header { padding: 20px 15px; margin-bottom: 20px; border-radius: 0; }
            .logo { font-size: 36px; }
            .subtitle { font-size: 14px; }
            .content { padding: 20px 15px; border-radius: 0; }
            .total { font-size: 24px; padding: 15px; }
            table { font-size: 14px; }
            th, td { padding: 8px 4px; font-size: 12px; }
            .accept-btn, .print-btn { font-size: 14px; padding: 12px 20px; }
        }
        
        /* Print styles */
        @media print {
            body { background: white; margin: 0; padding: 0; max-width: none; }
            .no-print { display: none !important; }
            .page-break { page-break-before: always; }
            .header, .content { box-shadow: none; margin: 0; padding: 20px; }
            #termsPage { display: block !important; }
        }
    </style>
</head>
<body>
    <div id="app">
        <div class="loading">Loading quote...</div>
    </div>

    <script>
        emailjs.init('cl17j5coPTDN-aVM8');
        const supabaseClient = window.supabase.createClient('https://xviustrrsuhidzbcpgow.supabase.co', 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Inh2aXVzdHJyc3VoaWR6YmNwZ293Iiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njg3ODk1NDgsImV4cCI6MjA4NDM2NTU0OH0.CEcc50c1K2Qnh6rXt_1-_w30LzHvDniGLbqWhdOolRY');
        
        let currentQuote = null;
        let currentClient = null;

        async function loadQuote() {
            try {
                const urlParams = new URLSearchParams(window.location.search);
                const shareToken = urlParams.get('quote');
                
                if (!shareToken) {
                    document.getElementById('app').innerHTML = '<div class="error">No quote specified</div>';
                    return;
                }

                // Show simple loading message
                document.getElementById('app').innerHTML = '<div class="loading">Loading quote...</div>';

                // Query database
                const response = await supabaseClient
                    .from('quotes')
                    .select('*')
                    .eq('share_token', shareToken);

                if (response.error) {
                    console.error('Database error:', response.error);
                    document.getElementById('app').innerHTML = '<div class="error">Error loading quote: ' + response.error.message + '</div>';
                    return;
                }

                if (!response.data || response.data.length === 0) {
                    document.getElementById('app').innerHTML = '<div class="error">Quote not found</div>';
                    return;
                }

                // Get the quote
                const quote = response.data.length > 1 
                    ? response.data.sort((a, b) => new Date(b.date) - new Date(a.date))[0]
                    : response.data[0];

                currentQuote = quote;

                const clientResponse = await supabaseClient
                    .from('clients')
                    .select('*')
                    .eq('id', quote.client_id)
                    .single();

                if (clientResponse.error) {
                    console.error('Client error:', clientResponse.error);
                    // Continue anyway with no client data
                }

                currentClient = clientResponse.data;

                renderQuote();
            } catch (error) {
                console.error('Error loading quote:', error);
                document.getElementById('app').innerHTML = '<div class="error">Error loading quote: ' + error.message + '</div>';
                // Don't retry - just show error
            }
        }

        function renderQuote() {
            try {
                const quote = currentQuote;
                const client = currentClient;
                const isAccepted = quote.accepted || quote.status === 'accepted';
                const company = quote.company_info || {};

                const html = `
                <div class="header">
                    <div class="logo">M4</div>
                    <div class="subtitle">Streamline</div>
                </div>
                
                <div class="content">
                    ${company.business_name ? `<div style="text-align: center; margin-bottom: 20px; padding: 15px; background: #f0fdfa; border-radius: 8px;">
                        <h2 style="margin: 0; color: #14b8a6;">${company.business_name}</h2>
                        ${company.abn ? `<p style="margin: 5px 0; font-size: 12px; color: #666;">ABN: ${company.abn}</p>` : ''}
                        ${company.phone ? `<p style="margin: 5px 0; font-size: 12px; color: #666;">üìû ${company.phone}</p>` : ''}
                        ${company.email ? `<p style="margin: 5px 0; font-size: 12px; color: #666;">‚úâÔ∏è ${company.email}</p>` : ''}
                        ${company.address ? `<p style="margin: 5px 0; font-size: 12px; color: #666;">üìç ${company.address}</p>` : ''}
                    </div>` : ''}
                    
                    <h1 style="margin-bottom: 10px;">Quote: ${quote.title}</h1>
                    
                    ${isAccepted ? '<div class="accepted-badge">‚úì QUOTE ACCEPTED</div>' : ''}
                    
                    <div class="section">
                        <p><span class="label">Client:</span> ${client?.name || 'N/A'}</p>
                        <p><span class="label">Email:</span> ${client?.email || 'N/A'}</p>
                        <p><span class="label">Phone:</span> ${client?.phone || 'N/A'}</p>
                        <p><span class="label">Date:</span> ${new Date(quote.date).toLocaleDateString()}</p>
                    </div>
                    
                    <table>
                        <thead>
                            <tr>
                                <th>Description</th>
                                <th>Quantity</th>
                                <th>Price</th>
                                <th>Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${quote.items.map(item => `
                                <tr>
                                    <td>${item.description}</td>
                                    <td>${item.quantity}</td>
                                    <td>$${parseFloat(item.price).toFixed(2)}</td>
                                    <td>$${(item.quantity * item.price).toFixed(2)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                    
                    ${quote.include_gst ? `
                        <div style="text-align: right; margin-top: 20px; padding: 15px; background: #f9fafb; border-radius: 8px;">
                            <div style="display: flex; justify-content: space-between; margin-bottom: 8px;">
                                <span style="color: #666;">Subtotal:</span>
                                <span style="font-weight: 500;">$${parseFloat(quote.subtotal || quote.total).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; margin-bottom: 12px; padding-bottom: 12px; border-bottom: 1px solid #e5e7eb;">
                                <span style="color: #666;">GST (10%):</span>
                                <span style="font-weight: 500;">$${parseFloat(quote.gst || 0).toFixed(2)}</span>
                            </div>
                            <div style="display: flex; justify-content: space-between; ${quote.deposit_percentage > 0 ? 'margin-bottom: 12px; padding-bottom: 12px; border-bottom: 2px solid #14b8a6;' : ''}">
                                <span style="font-size: 18px; font-weight: bold;">Total (inc GST):</span>
                                <span style="font-size: 18px; font-weight: bold; color: #14b8a6;">$${parseFloat(quote.total).toFixed(2)}</span>
                            </div>
                            ${quote.deposit_percentage > 0 ? `
                                <div style="display: flex; justify-content: space-between; margin-top: 12px; margin-bottom: 8px;">
                                    <span style="font-size: 16px; font-weight: bold; color: #f97316;">DEPOSIT REQUIRED:</span>
                                    <span style="font-size: 16px; font-weight: bold; color: #f97316;">$${parseFloat(quote.deposit_amount).toFixed(2)}</span>
                                </div>
                                <div style="text-align: right; font-size: 11px; color: #666; font-style: italic; margin-bottom: 8px;">
                                    (${quote.deposit_percentage}% of total)
                                </div>
                                <div style="padding-top: 8px; border-top: 1px solid #e5e7eb;">
                                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                                        <div style="display: flex; flex-direction: column;">
                                            <span style="font-size: 14px; color: #666;">Balance on completion:</span>
                                            <span style="font-size: 10px; color: #999; font-style: italic; margin-top: 2px;">(Unless specified otherwise)</span>
                                        </div>
                                        <span style="font-size: 14px; font-weight: 500;">$${(parseFloat(quote.total) - parseFloat(quote.deposit_amount)).toFixed(2)}</span>
                                    </div>
                                </div>
                            ` : `
                                <div style="margin-top: 12px; padding: 10px; background: #f0f9ff; border-radius: 8px; border-left: 3px solid #3b82f6;">
                                    <div style="font-size: 13px; font-weight: bold; color: #1e40af;">Payment Terms:</div>
                                    <div style="font-size: 12px; color: #475569; margin-top: 4px;">Full payment (COD) to be paid on completion</div>
                                </div>
                            `}
                        </div>
                    ` : `
                        <div class="total">Total: $${parseFloat(quote.total).toFixed(2)}</div>
                        ${quote.deposit_percentage > 0 ? `
                            <div style="margin-top: 15px; padding: 15px; background: #fff7ed; border-radius: 8px; border: 2px solid #f97316;">
                                <div style="font-size: 16px; font-weight: bold; color: #f97316; margin-bottom: 5px; text-align: right;">DEPOSIT REQUIRED: $${parseFloat(quote.deposit_amount).toFixed(2)}</div>
                                <div style="font-size: 11px; color: #666; font-style: italic; margin-bottom: 8px; text-align: right;">(${quote.deposit_percentage}% of total)</div>
                                <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2px;">
                                    <div>
                                        <div style="font-size: 14px; color: #666;">Balance on completion:</div>
                                        <div style="font-size: 10px; color: #999; font-style: italic; margin-top: 2px;">(Unless specified otherwise)</div>
                                    </div>
                                    <div style="font-size: 14px; font-weight: 500; color: #666;">$${(parseFloat(quote.total) - parseFloat(quote.deposit_amount)).toFixed(2)}</div>
                                </div>
                            </div>
                        ` : `
                            <div style="margin-top: 15px; padding: 15px; background: #f0f9ff; border-radius: 8px; border: 2px solid #3b82f6;">
                                <div style="font-size: 14px; font-weight: bold; color: #1e40af; margin-bottom: 5px;">Payment Terms:</div>
                                <div style="font-size: 13px; color: #475569;">Full payment (COD) to be paid on completion</div>
                            </div>
                        `}
                    `}
                    
                    ${quote.notes ? `<div class="section"><p class="label">Notes:</p><p>${quote.notes}</p></div>` : ''}
                    
                    <div style="margin-top: 30px; padding: 15px; background: #f9fafb; border-left: 3px solid #14b8a6; font-size: 12px; color: #666;">
                        <strong>Important:</strong> By accepting this quote, you are agreeing to the Terms and Conditions outlined on the next page.
                    </div>
                    
                    <div class="button-container no-print">
                        ${!isAccepted ? '<button class="accept-btn" onclick="acceptQuote()">Accept Quote</button>' : ''}
                        <button class="print-btn" onclick="window.print()">Print / Save as PDF</button>
                        <button class="print-btn" onclick="showTerms()">View Terms & Conditions</button>
                    </div>
                    
                    <div id="message" style="text-align: center; margin-top: 20px; font-size: 16px;"></div>
                </div>
                
                <!-- Terms and Conditions Page (Hidden by default, shown when clicked or printed) -->
                <div id="termsPage" style="display: none;" class="page-break">
                    <div class="header">
                        <div class="logo">M4</div>
                        <div class="subtitle">Streamline</div>
                    </div>
                    
                    <div class="content">
                        <h1 style="margin-bottom: 20px;">Terms and Conditions</h1>
                        
                        <div style="font-size: 14px; line-height: 1.6;">
                            <h3 style="margin-top: 20px; color: #14b8a6;">1. Quote Acceptance</h3>
                            <p>This quote is valid for 30 days from the date of issue. Acceptance of this quote constitutes agreement to these terms and conditions.</p>
                            
                            <h3 style="margin-top: 20px; color: #14b8a6;">2. Payment Terms</h3>
                            <p>Payment is due upon completion of work unless otherwise agreed in writing. Late payments may incur additional fees and are subject to legal action for debt recovery. All costs associated with debt recovery will be charged to the client.</p>
                            
                            <h3 style="margin-top: 20px; color: #14b8a6;">3. Scope of Work</h3>
                            <p>The work to be completed is as described in the quote. Any additional work requested will be quoted separately and requires written approval before commencement.</p>
                            
                            <h3 style="margin-top: 20px; color: #14b8a6;">4. Variations</h3>
                            <p>Any variations to the quoted work must be agreed in writing. Variations may result in additional charges and extended completion times.</p>
                            
                            <h3 style="margin-top: 20px; color: #14b8a6;">5. Warranty</h3>
                            <p>All work is guaranteed for a period of 12 months from completion date, subject to normal wear and tear.</p>
                            
                            <h3 style="margin-top: 20px; color: #14b8a6;">6. Liability</h3>
                            <p>Our liability is limited to the cost of rectifying any defects in our workmanship. We are not liable for consequential losses or damages.</p>
                            
                            <h3 style="margin-top: 20px; color: #14b8a6;">7. Access and Site Conditions</h3>
                            <p>Client must provide reasonable access to the work site and ensure utilities are available. Additional charges may apply if site conditions differ from those described.</p>
                            
                            <h3 style="margin-top: 20px; color: #14b8a6;">8. Cancellation</h3>
                            <p>Cancellation must be made in writing. Cancellation fees may apply for work already commenced or materials ordered.</p>
                        </div>
                        
                        <div class="button-container no-print" style="margin-top: 40px;">
                            <button class="print-btn" onclick="hideTerms()">Back to Quote</button>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('app').innerHTML = html;
            } catch (error) {
                console.error('Error rendering quote:', error);
                document.getElementById('app').innerHTML = '<div class="error">Error displaying quote: ' + error.message + '</div>';
            }
        }

        async function acceptQuote() {
            const messageDiv = document.getElementById('message');
            messageDiv.innerHTML = '<p style="color: #14b8a6; font-weight: bold;">Processing...</p>';
            
            try {
                // Update quote status
                const { error } = await supabaseClient
                    .from('quotes')
                    .update({ accepted: true, status: 'accepted' })
                    .eq('share_token', currentQuote.share_token);
                
                if (error) throw error;
                
                // Call the edge function to send notification email
                const functionUrl = 'https://xviustrrsuhidzbcpgow.supabase.co/functions/v1/notify-quote-accepted';
                
                await fetch(functionUrl, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        quote_id: currentQuote.id,
                        share_token: currentQuote.share_token
                    })
                });
                
                // Check if deposit needs to be paid
                if (currentQuote.deposit_amount && currentQuote.deposit_amount > 0) {
                    messageDiv.innerHTML = '<p style="color: #10b981; font-weight: bold; font-size: 18px;">‚úì Quote Accepted!</p><p style="margin-top: 10px;">Redirecting to deposit payment...</p>';
                    
                    // Create a deposit invoice and redirect to payment
                    setTimeout(async () => {
                        // Generate invoice number
                        const invoiceNumber = `INV-DEP-${Date.now()}`;
                        
                        // Create deposit invoice
                        const depositInvoice = {
                            client_id: currentQuote.client_id,
                            title: currentQuote.title + ' - Deposit',
                            items: [{
                                description: `Deposit (${currentQuote.deposit_percentage}%)`,
                                quantity: 1,
                                price: currentQuote.deposit_amount
                            }],
                            notes: `Deposit for quote: ${currentQuote.title}\nRemaining balance: $${(currentQuote.total - currentQuote.deposit_amount).toFixed(2)}`,
                            subtotal: currentQuote.deposit_amount,
                            gst: 0,
                            total: currentQuote.deposit_amount,
                            invoice_number: invoiceNumber,
                            status: 'unpaid',
                            issue_date: new Date().toISOString().split('T')[0],
                            due_date: new Date().toISOString().split('T')[0],
                            user_id: currentQuote.user_id
                        };
                        
                        const { data: invoiceData } = await supabaseClient
                            .from('invoices')
                            .insert([depositInvoice])
                            .select();
                        
                        if (invoiceData && invoiceData[0]) {
                            // Redirect to payment page
                            window.location.href = `payment.html?invoice=${invoiceData[0].id}`;
                        }
                    }, 1500);
                } else {
                    // No deposit - just show success
                    messageDiv.innerHTML = '<p style="color: #10b981; font-weight: bold; font-size: 18px;">‚úì Quote Accepted! The tradesperson has been notified.</p>';
                    
                    setTimeout(() => {
                        loadQuote();
                    }, 1500);
                }
                
            } catch (error) {
                console.error('Error:', error);
                messageDiv.innerHTML = '<p style="color: red;">Error accepting quote. Please try again.</p>';
            }
        }

        // Load quote when page loads
        window.addEventListener('load', loadQuote);
        
        function showTerms() {
            document.getElementById('termsPage').style.display = 'block';
            window.scrollTo(0, document.getElementById('termsPage').offsetTop - 50);
        }
        
        function hideTerms() {
            document.getElementById('termsPage').style.display = 'none';
            window.scrollTo(0, 0);
        }
    </script>
</body>
</html>
